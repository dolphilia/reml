# Reml FFI/ABI 調査メモ

## 1. 背景と目的
- Reml は LLVM/FFI 連携を前提に実用的な処理系を構築することを目標としているが、ABI や C 連携、WASM/WASI 支援に関する仕様化は未着手だった。
- 本メモでは現行ドキュメントを横断的に確認し、記述済みの内容とギャップを整理したうえで、導入判断とロードマップ案をまとめる。

## 2. 現状把握
### 2.1 LLVM 出力と ABI
- `a-jit.md` では Reml 型と LLVM IR の対応表、C 互換呼び出し規約 (`cc ccc`) の採用方針を記述しているが、対象 ABI（System V AMD64 など）の明示や構造体レイアウト規約までは定義していない。([a-jit.md](../a-jit.md#L130))
- 文字列や代数型のレイアウトは概略のみであり、外部言語と共有する際のライフサイクル・所有権モデルは参照カウント方式であることに触れるに留まる。([a-jit.md](../a-jit.md#L143))

### 2.2 C / C ライブラリ連携
- 言語仕様は `extern "C"` 宣言と `unsafe` ブロックによる FFI 呼び出し制約を定義し、FFI は `ffi` 効果タグを必須とする。([1-1-syntax.md](../1-1-syntax.md#L128), [1-3-effects-safety.md](../1-3-effects-safety.md#L95))
- `guides/runtime-bridges.md` はクラウド API や GPU など効果タグと監査ログの組み合わせを提示するが、リンカ設定・シグネチャ規約・ヘッダ生成といった運用ガイドは存在しない。([guides/runtime-bridges.md](../guides/runtime-bridges.md#L5))

### 2.3 WASM / WASI
- リポジトリ内に WASM, WASI, WebAssembly に関する記述は確認できず、ターゲット対応の方針は未策定。

## 3. Reml の目的との整合評価
- プロジェクトの最上位ゴールでは LLVM/FFI 連携による実サービス適用を重視しており、ABI や C 連携の詳細仕様化はその達成に不可欠。([0-2-project-purpose.md](../0-2-project-purpose.md#L7))
- FFI 境界を `unsafe` と効果タグで制御する現行設計に対し、ABI 不確定のままでは安全なラッパや再利用可能なガイドが欠落し、目的達成にギャップが残る。
- WASM/WASI は明示された目標ではないが、LLVM を利用するうえで将来的なターゲット拡張として検討価値が高い。

## 4. 取り込み方針とロードマップ案
### 4.1 短期（仕様整備）
- `a-jit.md` にターゲット ABI とデータレイアウト（整数/浮動小数点、ポインタ幅、構造体パッキング）の明示セクションを追加する。
- `extern` 宣言と効果システムを跨いだ FFI 実装ガイド（署名規約、リンカ統合、監査ログ要件）を `guides/` 配下に新規作成する。

### 4.2 中期（検証とサンプル）
- C ⇔ Reml 相互運用の最小サンプル（文字列、配列、構造体）を提示し、ABI 仕様と整合するか検証手順を用意する。
- CI もしくはドキュメント内チェックリストで ABI 逸脱を監視できる仕組みを検討する（例: 参考 C テストコードを用いた連結テスト）。

### 4.3 中〜長期（新ターゲット調査）
- LLVM を通した WASM/WASI 出力の制約（例: 線形メモリ、システムコール、例外処理）を調査し、想定ユースケースとの適合性を検討する。
- 従来 ABI との差異を比較表として整理し、ターゲット切替時に必要なランタイム API や効果タグの扱いを明文化する。

## 5. 次のアクション候補
1. `a-jit.md` に ABI/データレイアウト草案を追記してレビューを開始する。
2. FFI 運用ガイドのドラフトを `guides/reml-ffi-handbook.md`（仮称）として作成する。
3. WASM/WASI 調査ノートを別途起草し、要件・制約・期待効果を洗い出す。

## 6. 参照ドキュメント
- [a-jit.md](../a-jit.md)
- [1-1-syntax.md](../1-1-syntax.md)
- [1-3-effects-safety.md](../1-3-effects-safety.md)
- [guides/runtime-bridges.md](../guides/runtime-bridges.md)
- [0-2-project-purpose.md](../0-2-project-purpose.md)
