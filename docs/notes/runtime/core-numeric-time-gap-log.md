# Core Numeric & Time ギャップログ

Core.Numeric/Core.Time 仕様 (docs/spec/3-4-core-numeric-time.md) と Rust 実装の差分、対応計画、参照リンクを記録する。Phase3 Bootstrap Roadmap と Rust Migration 計画の連携資料として利用する。

## 記入フォーマット
| 日付 | 区分 | 概要 | 影響範囲 | 対応状況 | チケット/リンク |
| --- | --- | --- | --- | --- | --- |
| 2025-12-09 | 監査連携 | `MetricPoint`/`MetricValue`/`emit_metric` を Rust Runtime (`compiler/runtime/src/diagnostics/metric_point.rs`) に追加し、`effect.capability = "metrics.emit"`・`metric_point.tag.*` を含む `AuditEnvelope.metadata` を生成できるようにした。`tooling/ci/collect-iterator-audit-metrics.py --section numeric_time --scenario emit_metric --metric-source tests/data/metrics/metric_point_cases.json` で `core.time.emit_metric` KPI を収集し、`reports/spec-audit/ch3/metric_point-emit_metric.json` にゴールデンを保存。 | `compiler/runtime/src/diagnostics/`, `tests/data/metrics/metric_point_cases.json`, `reports/spec-audit/ch3/metric_point-emit_metric.json`, `tooling/ci/collect-iterator-audit-metrics.py`, `docs/guides/tooling/audit-metrics.md` | In Progress (Plan §5.1) | docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md §5.1 |

## 最新エントリ
| 日付 | 区分 | 概要 | 影響範囲 | 対応状況 | チケット/リンク |
| --- | --- | --- | --- | --- | --- |
| 2025-12-13 | 精度/金融 | `numeric/precision.rs` を追加し、`Precision` 列挙・`with_precision`・`round_to`・`truncate_to` を実装。`NumericError`/`NumericErrorKind` を導入して `numeric.precision.*` メタデータと監査キーを `tests/data/numeric/precision/*.json` で検証。`cargo test --manifest-path compiler/runtime/Cargo.toml --features core-numeric` で `numeric::precision::tests::*` を実行し、`median` が `PartialOrd` を扱えるよう更新した。 | `compiler/runtime/src/numeric/{mod.rs,error.rs,precision.rs}`, `tests/data/numeric/precision/*.json`, `docs/plans/bootstrap-roadmap/assets/core-numeric-time-api-diff.csv`, `docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md` §2.4 | In Progress (Plan §2.4 / Gap Plan N-4) | docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md §2.4 |
| 2025-12-13 | 数値プリミティブ | `Floating` トレイトを Clone/PartialOrd 系に刷新し、`Decimal` でも `mean`/`variance`/`percentile` が利用できるようにした。`median`/`percentile` で `effects::record_mem_copy` を呼び出し、`iter_numeric_props.rs` に Decimal ケースを追加して `take_numeric_effects_snapshot()` で `effect {mem}`/`mem_bytes` を検証。 | `compiler/runtime/src/numeric/{mod.rs,decimal.rs,effects.rs}`, `compiler/runtime/tests/iter_numeric_props.rs`, `docs/plans/bootstrap-roadmap/assets/core-numeric-time-api-diff.csv`, `docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md` §2.4 | In Progress (Plan §2.4 / Gap Plan N-5) | docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md §2.4 |
| 2025-12-13 | 精度/金融 | `numeric/finance.rs` を追加し、`CurrencyCode`/`currency_add`/`compound_interest`/`net_present_value` を `Decimal` ベースで実装。`NumericErrorKind::UnsupportedCurrency` を導入し、`tests/data/numeric/finance/unsupported_currency.json` で `numeric.finance.*` メタデータを検証。`numeric::tests::currency_add_respects_scale_and_validates_code` などの単体テストと `cargo test --manifest-path compiler/runtime/Cargo.toml --features core-numeric` を実行して保証。 | `compiler/runtime/src/numeric/{finance.rs,error.rs,mod.rs}`, `tests/data/numeric/finance/*.json`, `docs/plans/bootstrap-roadmap/assets/core-numeric-time-api-diff.csv`, `docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md` §2.4 | In Progress (Plan §2.4 / Gap Plan N-6) | docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md §2.4 |
| 2025-12-12 | 時刻/ロケール | `time-format-locale-map.csv` を `und`/`ja-JP`/`tr-TR`/`az-Latn`/`zh-TW` へ拡張し、`TIME_LOCALE_TABLE` を `compiler/runtime/src/time/locale_table_data.rs` に切り出して自動生成。`LocaleStatus`（Supported/Planned/Deprecated）と `supports_{rfc3339,unix,custom}` を導入し、`format_with_locale` でステータス未対応ロケールやフォーマット非対応ロケールを拒否するようにした。さらに `compiler/runtime/src/time/format/icu.rs` で ICU → `time` 記法のトランスレータを実装し、`tests/data/time/format/icu_cases.json` / `time::tests::{time_format_icu_cases_from_dataset,time_parse_icu_cases_from_dataset}` で往復テストを固定。 | `docs/plans/bootstrap-roadmap/assets/time-format-locale-map.csv`, `tooling/scripts/update_time_locale_table.py`, `compiler/runtime/src/time/{format.rs,locale_table_data.rs,format/icu.rs}`, `tests/data/time/format/{format_cases.json,icu_cases.json}`, `compiler/runtime/src/time/mod.rs`, `reports/spec-audit/ch3/time_format-locales.md` | In Progress (Plan §4.3 / Gap Plan T-1/T-2) | docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md §4.3, docs/plans/bootstrap-roadmap/3-4-core-numeric-time-gap-plan.md §2 |
| 2025-12-12 | 時刻/タイムゾーン | 代表的な IANA 名（`Asia/Tokyo`/`Europe/London`/`America/New_York`）を `timezone()` で受理できるよう静的オフセットテーブルを追加し、`tests/data/time/timezone_iana.json` と `time::tests::timezone_cases_from_dataset` で検証。`collect-iterator-audit-metrics.py --section numeric_time --scenario timezone_lookup` に新 JSON を追加指定する運用とし、`reports/spec-audit/ch3/time_timezone-iana.md` にログを保存。 | `compiler/runtime/src/time/timezone.rs`, `tests/data/time/timezone_iana.json`, `compiler/runtime/src/time/mod.rs`, `tooling/ci/collect-iterator-audit-metrics.py`, `reports/spec-audit/ch3/time_timezone-iana.md` | In Progress (Plan §4.2 / Gap Plan T-3) | docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md §4.2, docs/plans/bootstrap-roadmap/3-4-core-numeric-time-gap-plan.md §2 |
| 2025-12-12 | 時刻/IO 連携 | Core.IO に `time_env_snapshot()` を追加し、`TimeError::with_env_snapshot` で `time.env.{timezone,locale}` を診断・監査メタデータへ出力。`timezone()`/`local()` の Capability 失敗や範囲外エラーで環境情報が記録されるようにし、`reports/spec-audit/ch3/time_env-bridge.md` に取得フローと CLI 検証ログを保存。 | `compiler/runtime/src/io/env.rs`, `compiler/runtime/src/time/{error.rs,timezone.rs,mod.rs}`, `reports/spec-audit/ch3/time_env-bridge.md`, `tooling/ci/collect-iterator-audit-metrics.py` | In Progress (Plan §4.2 / Gap Plan T-4) | docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md §4.2, docs/plans/bootstrap-roadmap/3-4-core-numeric-time-gap-plan.md §2 |
| 2025-12-11 | 監査連携 | `metrics.emit` Capability の Stage 検証と `effects.contract.stage_mismatch` 診断を追加。`emit_metric` は `StageRequirement::Exact(StageId::Stable)` を通過した場合のみ `MetricPoint` を送出し、失敗時は metric 情報と Stage 要件を含む `GuardDiagnostic` を返す。`tooling/lsp/tests/client_compat/fixtures/metrics-stage.json`・`reports/dual-write/metrics-stage-mismatch.json` で CLI/LSP/監査のサンプルを固定。 | `compiler/runtime/src/diagnostics/{metric_point.rs,audit_bridge.rs}`, `compiler/runtime/src/registry.rs`, `compiler/runtime/tests/metrics_capability.rs`, `tooling/lsp/tests/client_compat/{fixtures/tests}`, `reports/dual-write/metrics-stage-mismatch.json`, `docs/notes/runtime/runtime-metrics-capability.md` | In Progress (Plan §5.3) | docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md §5.3 |
| 2025-12-10 | 監査連携 | `compiler/runtime/src/diagnostics/audit_bridge.rs` を追加し、`attach_audit`/`with_metric_tags`/`metric_audit_metadata` で `MetricPoint` の監査メタデータを統一。`reports/audit/metric_point/emit_metric.audit.jsonl` と `scripts/validate-diagnostic-json.sh --pattern metrics.emit` により CLI/LSP/監査ログを同一スキーマで検証できるようにした。`docs/guides/tooling/audit-metrics.md`・`3-4-core-numeric-time-plan.md` に KPI と進捗を反映。 | `compiler/runtime/src/diagnostics/{audit_bridge.rs,metric_point.rs}`, `reports/audit/metric_point/emit_metric.audit.jsonl`, `scripts/validate-diagnostic-json.sh`, `docs/guides/tooling/audit-metrics.md`, `docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md` | In Progress (Plan §5.2) | docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md §5.2 |
| 2025-12-09 | 数値プリミティブ | `median`/`mode`/`range` を `compiler/runtime/src/numeric/mod.rs` に追加し、`IterNumericExt` から呼べるようにした。`reports/spec-audit/ch3/numeric_basic-extended.md` に結果を記録し、`core_numeric` feature で `cargo test numeric::tests::median_mode_and_range_cover_basic_cases` を実行。さらに `Decimal`/`BigInt`/`BigRational` に対する `Numeric` 実装と feature (`decimal`/`bigint`/`ratio`) を追加し、`tests/data/numeric/decimal_cases.json` を `scripts/validate-diagnostic-json.sh --suite numeric` の対象に含めた。 | `compiler/runtime/src/numeric/{mod.rs,decimal.rs}`, `tests/data/numeric/decimal_cases.json`, `reports/spec-audit/ch3/numeric_basic-extended.md`, `compiler/runtime/Cargo.toml`, `docs/plans/rust-migration/1-1-ast-and-ir-alignment.md` | In Progress (Plan §1.1 / Gap Plan N-1,N-2) | docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md §1, docs/plans/bootstrap-roadmap/3-4-core-numeric-time-gap-plan.md §1 |
| 2025-12-08 | 時刻/タイムゾーン | `TimeError` に `IntoDiagnostic` を実装し `time.platform`/`time.timezone` を診断・監査へ出力。`compiler/runtime/src/time/timezone.rs` を新設して `utc`/`local`/`timezone`/`convert_timezone` を PoC 実装し、`tests/data/time/timezone_cases.json` ベースの単体テストを追加。`tooling/ci/collect-iterator-audit-metrics.py --section numeric_time --scenario {clock_accuracy,timezone_lookup}` が新データを検証できるよう CLI オプションと `numeric_time` セクションを整備。 | `compiler/runtime/src/time/{mod.rs,error.rs,timezone.rs}`, `tests/data/time/timezone_cases.json`, `tooling/ci/collect-iterator-audit-metrics.py`, `docs/guides/tooling/audit-metrics.md`, `docs/notes/runtime/runtime-capability-stage-log.md` | In Progress (Plan §4.2) | docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md §4.2 |
| 2025-12-07 | 統計/品質 | `rolling_average`/`z_score` を `numeric/iter.rs` に追加し、`NumericCollector` と `Iter::collect_numeric` を導入。`iter_numeric_props.rs` では固定乱数サンプルを使った擬似 property テストで遅延計算と `effect {mem}` 記録を検証し、`core-iter-numeric` チェックリストへテストケースを登録した。 | `compiler/runtime/src/numeric/{iter.rs,mod.rs}`, `compiler/runtime/src/prelude/collectors/{mod.rs,numeric.rs}`, `compiler/runtime/tests/iter_numeric_props.rs`, `docs/plans/bootstrap-roadmap/checklists/core-iter-numeric.md`, `docs/plans/bootstrap-roadmap/assets/core-numeric-time-api-diff.csv` | In Progress (Plan §3.3) | docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md §3.3 |
| 2025-12-06 | 診断連携 | `StatisticsError` の `IntoDiagnostic` を拡張し、`column`/`aggregation`/`audit_id` など Config/Data 章で要求されるメタデータを `numeric.statistics.*` と `data.stats.*` 双方に書き込めるようにした。`encode_sample_value` で `NaN`/`±Infinity` を安定フォーマット化し、`scripts/validate-diagnostic-json.sh --suite numeric` を追加して `tests/data/numeric/` と `tests/expected/numeric_*.json` を `diagnostic-v2` スキーマで一括検証できるようにした。2025-12-09 追記: `StatisticsTags`/`StatisticsError::with_tags` を導入し、`tests/data/numeric/decimal_cases.json` でタグ付き診断を検証。 | `compiler/runtime/src/numeric/error.rs`, `scripts/validate-diagnostic-json.sh`, `tests/data/numeric/`, `tests/expected/`, `docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md`, `docs/plans/bootstrap-roadmap/assets/core-numeric-time-api-diff.csv`, `README.md` | In Progress (Plan §3.2) | docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md §3.2 |
| 2025-12-05 | 統計/品質 | `numeric/statistics.rs` を追加し `quantiles`/`correlation`/`linear_regression` を実装。`ordered-float` キーで `Map` を返し、ThreadLocal `numeric/effects.rs` + `take_numeric_effects_snapshot()` で `effect {mem}` と `mem_bytes` を記録できるようにした。`tests/expected/numeric_{quantiles,regression}.json` と単体テストで精度と診断分岐を固定。 | `compiler/runtime/src/numeric/{statistics.rs,effects.rs,mod.rs}`, `tests/expected/numeric_*.json`, `docs/guides/tooling/audit-metrics.md`, `docs/plans/bootstrap-roadmap/assets/core-numeric-time-api-diff.csv` | In Progress (Plan §3.1) | docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md §3.1 |
| 2025-12-04 | 数値安定性 | 数値安定性メモ (`core-numeric-stability.md`) と Criterion ベンチ (`bench_numeric_statistics.rs`) を追加し、`reports/benchmarks/numeric-phase3/phase3-baseline-2025-12-04.json` に平均/分散/百分位シナリオの初回測定を記録。`StatisticsErrorKind::NumericalInstability` を再現する JSON (`tests/data/numeric/instability/*.json`) も作成し、診断拡張と監査メタデータを確認できるようにした。 | `docs/notes/runtime/core-numeric-stability.md`, `compiler/runtime/benches/bench_numeric_statistics.rs`, `reports/benchmarks/numeric-phase3/`, `tests/data/numeric/instability/` | In Progress (Plan §2.3) | docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md §2.3, docs/plans/rust-migration/3-2-benchmark-baseline.md |
| 2025-12-03 | 統計/品質 | `HistogramBucket`/`HistogramBucketState`/`StatisticsError` を PoC 実装し、`histogram` にバケット検証 (`H-01`〜`H-07`)・`IntoDiagnostic` を組み込んだ。`tests/data/numeric/histogram/*.json` と `scripts/validate-diagnostic-json.sh --pattern numeric.histogram` で JSON 契約を検証。 | `compiler/runtime/src/numeric/{histogram.rs,error.rs,mod.rs}`, `tests/data/numeric/histogram/`, `scripts/validate-diagnostic-json.sh`, `docs/plans/bootstrap-roadmap/assets/histogram-error-matrix.md` | In Progress (Plan §2.2) | docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md §2.2 |
| 2025-12-02 | 数値ユーティリティ | `core_numeric` feature で `Numeric`/`OrderedFloat`/`Floating`/`IterNumericExt` を追加し、`lerp`/`mean`/`variance`/`percentile` を PoC 実装。現状は浮動小数点型中心のため、整数/Decimal 系への拡張と KPI 計測は後続タスク。 | `compiler/runtime/src/numeric/mod.rs`, `docs/plans/bootstrap-roadmap/assets/core-numeric-time-api-diff.csv`, `docs/plans/rust-migration/1-1-ast-and-ir-alignment.md` | In Progress | docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md §2.1 |
| 2025-12-01 | 監査連携 | `MetricPoint` から `AuditSink` への橋渡しと `effect {audit}` 計測が未整備。Phase3 KPI (`numeric.metrics.*`) を README/Phase3 表と同期する導線がないため、`emit_metric` 実装・監査ジョブ設計・文書リンクの追加が必要。 | `docs/spec/3-4-core-numeric-time.md` §4, `docs/spec/3-6-core-diagnostics-audit.md`, `docs/guides/tooling/audit-metrics.md`, `README.md#core-numeric--time-進捗` | Pending (Backlog/1.3) | docs/plans/bootstrap-roadmap/assets/core-numeric-time-dependency-map.drawio |
| 2025-12-01 | 診断連携 | `StatisticsError`/`NumericError` を `Diagnostic` に昇格させるブリッジがなく、`Core.Config` 章で要求されるメッセージ (`column`/`aggregation`/`audit_id`) が出力できない。`docs/spec/3-7-core-config-data.md` と計画書の参照更新が滞っている。 | `docs/spec/3-4-core-numeric-time.md` §2, `docs/spec/3-6-core-diagnostics-audit.md`, `docs/spec/3-7-core-config-data.md`, `compiler/runtime/src/prelude/ensure.rs` | Superseded (see 2025-12-06 entry) | docs/plans/bootstrap-roadmap/assets/core-numeric-time-dependency-map.drawio |
| 2025-12-01 | IO 連携 | `Timestamp`/`Duration` が `Core.IO` (`docs/spec/3-5-core-io-path.md`) や `Env` のクロック API と接続されておらず、Phase3 Self-Host 計画の IO/Runtime 行にも進捗が反映されていない。`CapabilityStage`/`timezone` 層の依存整理が必要。 | `docs/spec/3-4-core-numeric-time.md` §3, `docs/spec/3-5-core-io-path.md`, `docs/spec/3-8-core-runtime-capability.md`, `docs/plans/bootstrap-roadmap/3-0-phase3-self-host.md` | Pending (Backlog/1.3) | docs/plans/bootstrap-roadmap/assets/core-numeric-time-dependency-map.drawio |
| 2025-11-30 | 監査メタデータ | `EffectSet`/`CollectorEffectMarkers` に `effect {time}` ビットと `time_calls` を追加し、`collector.effect.time` / `collector.effect.time_calls` が診断/監査ログへ出力されるようになった。`collect-iterator-audit-metrics.py` でも `collector.effect.audit_snapshot` から同フィールドを集計可能。 | `compiler/runtime/src/prelude/iter/mod.rs`, `compiler/runtime/src/prelude/collectors/mod.rs`, `tooling/ci/collect-iterator-audit-metrics.py`, `docs/plans/bootstrap-roadmap/assets/core-numeric-time-effects-matrix.md` | Done | docs/plans/bootstrap-roadmap/assets/core-numeric-time-effects-matrix.md |
| 2025-11-27 | API 差分 | `Numeric`/`OrderedFloat` トレイトおよび `lerp`/`mean`/`variance` 等の基本ユーティリティが Rust runtime に存在しない。`compiler/runtime/src/numeric/` ディレクトリ自体が未作成で、型推論制約に紐づく実装ポイントが空白。 | `docs/spec/3-4-core-numeric-time.md#1-数値プリミティブとユーティリティ`, `compiler/runtime/src/numeric/*` | Pending | docs/plans/bootstrap-roadmap/assets/core-numeric-time-api-diff.csv |
| 2025-11-27 | 統計/品質 | `histogram`/`rolling_average`/`quantiles` など統計 API、`StatisticsError`/`StatisticsErrorKind` 型が未実装。`Iter`/`Core.Collections` に依存する導線や `effect {mem}` 記録戦略も決まっていない。 | `docs/spec/3-4-core-numeric-time.md#2-統計・データ品質サポート`, `compiler/runtime/src/numeric/{histogram,statistics,error}.rs` | Pending | docs/plans/bootstrap-roadmap/assets/core-numeric-time-api-diff.csv |
| 2025-11-27 | 時刻/タイムゾーン | `Timestamp`/`Duration` 型と `now`/`monotonic_now`/`sleep`/`timezone` 等の Core.Time API が欠落。現状 `compiler/adapter/src/time.rs` の Capability ラッパのみで、Runtime/Diagnostics から時刻を扱うインターフェースが露出していない。 | `docs/spec/3-4-core-numeric-time.md#3-時間・期間型`, `#31-時刻フォーマット`, `#32-タイムゾーンサポート`, `compiler/runtime/src/time/*` | Pending | docs/plans/bootstrap-roadmap/assets/core-numeric-time-api-diff.csv, compiler/adapter/src/time.rs |
| 2025-11-27 | メトリクス/監査 | `MetricPoint`/`IntoMetricValue`/`emit_metric` が未定義。`effect {audit}` を計測して `AuditSink` へ送る経路や Stage 検証ロジックが runtime になく、Phase3 KPI (`MetricPoint` → `AuditEnvelope`) を満たせない。 | `docs/spec/3-4-core-numeric-time.md#4-メトリクスと監査連携`, `docs/spec/3-6-core-diagnostics-audit.md`, `compiler/runtime/src/diagnostics/metric_point.rs` | Superseded (see 2025-12-09 entry) | docs/plans/bootstrap-roadmap/assets/core-numeric-time-api-diff.csv |
| 2025-11-27 | 精度/金融 | `Precision` 列挙・`with_precision`・`round_to` など丸め API と `currency_add`/`net_present_value` など金融向け Decimal 関連が丸ごと未実装。`NumericError` も未定義のため、仕様 6 章の要件に着手できない。 | `docs/spec/3-4-core-numeric-time.md#6-数値精度と丸め設定`, `#62-金融計算向け最適化`, `compiler/runtime/src/numeric/{precision,finance}.rs` | Pending | docs/plans/bootstrap-roadmap/assets/core-numeric-time-api-diff.csv |

## TODO
- [ ] エントリごとに Responsible/Owner を割り当て、Phase3 スプリント計画に紐付ける。
- [ ] `docs/plans/bootstrap-roadmap/3-4-core-numeric-time-plan.md` の進行状況に合わせて本ログを定期更新する。
