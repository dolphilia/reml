# 型クラス実装方式 性能評価レポート

**日時**: 2025-10-13
**Phase**: Phase 2 Week 20-21
**目的**: 辞書渡し方式とモノモルフィゼーションPoCの定量的比較評価

## 1. 評価目的

Phase 2マイルストーンM1に向けて、以下2つの型クラス実装方式を比較し、Phase 3セルフホスト化に向けた採用方針を決定する。

### 1.1 評価対象

- **辞書渡し方式** (Dictionary Passing)
  - トレイト制約を辞書構造体（vtable）として実行時に渡す
  - 型クラスごとに1つの実装で済む（コードサイズ効率）
  - 関数ポインタ経由の間接呼び出しによるオーバーヘッド

- **モノモルフィゼーションPoC** (Monomorphization Proof-of-Concept)
  - トレイトインスタンスごとに具象関数を生成
  - 直接呼び出しによる性能向上（インライン展開可能）
  - コードサイズ増加とコンパイル時間増加のトレードオフ

## 2. 評価基準

### 2.1 実行時間

- **目標**: 辞書渡し方式のオーバーヘッドが **10%未満**
- **計測方法**: 各ベンチマークを3回実行し平均値を算出
- **ベンチマーク種別**:
  - マイクロベンチマーク: 単純なメソッド呼び出し（10^6回）
  - マクロベンチマーク: コレクション操作（sort, filter, find等）

### 2.2 コードサイズ

- **目標**: モノモルフィゼーションによる増加率が **30%未満**
- **計測対象**:
  - バイナリファイルサイズ（bytes）
  - LLVM IR行数
  - オブジェクトファイル（.o）サイズ

### 2.3 コンパイル時間

- **目標**: モノモルフィゼーションが辞書渡しの **2倍未満**
- **計測方法**: コンパイル全体（Parser→Typer→Core IR→LLVM IR→llc）の所要時間

### 2.4 メモリ使用量

- **目標**: 実行時メモリ使用量の差異を定量化
- **計測方法**:
  - macOS: `time -l` による最大常駐セットサイズ (RSS)
  - Linux: `/usr/bin/time -v` による最大RSS

## 3. ベンチマーク設計

### 3.1 マイクロベンチマーク (`micro_typeclass.reml`)

#### 3.1.1 Eq型クラス
- `bench_eq_i64`: i64での等価比較（10^6回）
- `bench_eq_string`: String での等価比較（10^6回）
- `bench_eq_bool`: Bool での等価比較（10^6回）

#### 3.1.2 Ord型クラス
- `bench_ord_i64`: i64での順序比較（10^6回）
- `bench_ord_string`: String での順序比較（10^6回）

#### 3.1.3 複合ベンチマーク
- `bench_combined`: Eq + Ord の組み合わせ（10^6回）

### 3.2 マクロベンチマーク (`macro_typeclass.reml`)

#### 3.2.1 検索操作（Eq使用）
- `find_element`: リスト内要素探索
- `count_duplicates`: 重複要素カウント

#### 3.2.2 順序操作（Ord使用）
- `find_min`: 最小値探索
- `bubble_sort_iteration`: バブルソート（1イテレーション）
- `filter_greater_than`: 閾値フィルタリング
- `count_in_range`: 範囲内要素カウント

## 4. 計測結果（予定）

### 4.1 実行時間比較

| ベンチマーク | 辞書渡し (ms) | モノモルフィック (ms) | オーバーヘッド (%) | 判定 |
|-------------|---------------|----------------------|-------------------|------|
| micro_eq_i64 | TBD | TBD | TBD | - |
| micro_eq_string | TBD | TBD | TBD | - |
| micro_ord_i64 | TBD | TBD | TBD | - |
| macro_combined | TBD | TBD | TBD | - |
| **平均** | TBD | TBD | TBD | - |

### 4.2 コードサイズ比較

| ベンチマーク | 辞書渡し (bytes) | モノモルフィック (bytes) | 増加率 (%) | 判定 |
|-------------|-----------------|------------------------|-----------|------|
| micro_typeclass | TBD | TBD | TBD | - |
| macro_typeclass | TBD | TBD | TBD | - |
| **合計** | TBD | TBD | TBD | - |

### 4.3 LLVM IR サイズ比較

| ベンチマーク | 辞書渡し (行) | モノモルフィック (行) | 増加率 (%) | 判定 |
|-------------|--------------|---------------------|-----------|------|
| micro_typeclass | TBD | TBD | TBD | - |
| macro_typeclass | TBD | TBD | TBD | - |

### 4.4 メモリ使用量比較

| ベンチマーク | 辞書渡し (KB) | モノモルフィック (KB) | 差異 (%) |
|-------------|--------------|---------------------|---------|
| micro_typeclass | TBD | TBD | TBD |
| macro_typeclass | TBD | TBD | TBD |

## 5. 分析と考察（予定）

### 5.1 実行時間の分析
（計測後に記載）

### 5.2 コードサイズの分析
（計測後に記載）

### 5.3 トレードオフ分析
（計測後に記載）

## 6. 採用方針の決定（予定）

### 6.1 評価結果サマリー
（計測後に記載）

### 6.2 推奨実装方式
（計測後に記載）

### 6.3 却下理由（該当する場合）
（計測後に記載）

### 6.4 Phase 3への引き継ぎ事項
（計測後に記載）

## 7. 参考資料

- Phase 2計画書: [docs/plans/bootstrap-roadmap/2-1-typeclass-strategy.md](../../plans/bootstrap-roadmap/2-1-typeclass-strategy.md)
- 型システム仕様: [docs/spec/1-2-types-Inference.md](../../spec/1-2-types-Inference.md)
- 技術的負債: [compiler/ocaml/docs/technical-debt.md](../../compiler/ocaml/docs/technical-debt.md)

## 8. 更新履歴

- **2025-10-13**: 初版作成（ベンチマーク設計・評価基準定義）
- **TBD**: 計測結果記録
- **TBD**: 分析・採用方針決定
