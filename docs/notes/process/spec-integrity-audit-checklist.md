# spec-integrity-audit-checklist 草案

> TODO: Phase 2-8 `spec-integrity-audit` 着手時に正式版へ昇格させる。現時点では Phase 2-5 ERR-001 の共有タスクで把握した監視項目のみを記録する。

## Phase 2-8 初動チェック（W36 更新）
- [x] `reports/spec-audit/` ディレクトリ構造（`ch0/`〜`ch3/`, `diffs/`, `summary.md`）を作成し、格納方針を `reports/spec-audit/README.md` に記載する。
- [x] `cargo test --manifest-path compiler/frontend/Cargo.toml`（2025-11-17 実行）と `cargo run --manifest-path compiler/frontend/Cargo.toml --bin reml_frontend -- --help` の成功ログを `reports/spec-audit/summary.md` に記録し、Rust Frontend を監査ベースラインとして利用できることを確認する。
- [x] Chapter 0/索引レビュー: `reports/spec-audit/ch0/links.md` にリンク検証結果と `docs/spec/0-0-overview.md` の差分要約を記録する（担当: Spec Core WG @ W36、2025-11-17 12:39 JST 更新）。
- [x] Chapter 1 サンプル実行: `cargo run ... --emit-diagnostics` の結果を `reports/spec-audit/ch1/` に保存し、`SYNTAX-002`/`SYNTAX-003` の `rust-gap` 状態を更新する（担当: Rust Parser WG @ W37 前半、2025-11-17 12:41 JST 実行ログを `reports/spec-audit/ch1/2025-11-17-syntax-samples.md` に集約）。
- [x] Chapter 2 Streaming/Recover: `reports/spec-audit/ch2/streaming/*.json` に streaming runner の JSON を追加し、`ERR-001`/`ERR-002` の再現ログを添付する（担当: Parser API WG @ W38、`CI_RUN_ID=rust-frontend-streaming-20251121.1` を `streaming_use_nested-20251121-diagnostics.json` / `streaming_effect_handler-20251121-diagnostics.json` に記録）。
- [ ] Chapter 3 Diagnostics/Capability: `cargo test --manifest-path compiler/runtime/ffi/Cargo.toml` と `compiler/adapter/Cargo.toml` の結果、および `tooling/ci/collect-iterator-audit-metrics.py --section diagnostics --require-success` の出力を `reports/spec-audit/ch3/` に格納する（担当: Rust Runtime WG @ W38 前半）。
- [ ] `reports/spec-audit/diffs/` に `rust-gap` 向け差分メモ （フォーマット: `<ID>-<chapter>-rust-gap.md`）を作成し、`docs/plans/bootstrap-roadmap/2-5-spec-drift-remediation.md#phase28-diff-class` と相互参照する。`SYNTAX-002-ch1-rust-gap.md` を 2025-11-17 に追加済み（他 ID も同形式で追従する）。

## 期待集合（ERR-001）
- [x] `parser.expected_summary_presence` が 1.0 を維持していることを `tooling/ci/collect-iterator-audit-metrics.py --require-success` と `cargo test --manifest-path compiler/frontend/Cargo.toml streaming_metrics -- --nocapture` の双方で確認する（`CI_RUN_ID=rust-frontend-streaming-20251121.1` ログを `reports/spec-audit/ch1/streaming_metrics-20251121-log.md` に保存）。
- [ ] `parser.expected_tokens_per_error` が 0.0 を下回らないことをチェックし、閾値を超える場合は `docs/spec/2-5-error.md` §B-7 の縮約ルールに従って上限設定を検討する。
- [ ] ストリーミング経路 (`docs/guides/compiler/core-parse-streaming.md` §3/§7) が `Diagnostic.expected` を CLI/LSP と同じ `ExpectationSummary` で公開しているか確認する。`StreamEvent::Error` で `ExpectedSummary` が欠落している場合は Phase 2-5 ERR-001 S5 の共有事項に沿って修正する。

## ドキュメント整合
- [ ] `docs/spec/2-5-error.md` と `docs/spec/3-6-core-diagnostics-audit.md` の脚注 `[^err001-phase25]` / `[^err001-phase25-core]` をレビューし、将来の仕様改訂で状態が変わった場合は脚注内容とリンクを更新する。

## Core.Collections 監査 TODO（W39 追加）
- [ ] `Collections.audit_bridge` の JSON 生成結果を `reports/spec-audit/ch1/core_iter_collectors.audit.jsonl` に 3 ケース（`map_diff`, `set_partition`, `table_merge`）で残し、`tooling/ci/collect-iterator-audit-metrics.py --section collectors --scenario map_set_persistent --require-audit` を通過することを確認する。監査メタデータ (`AuditEnvelope.change_set.collections.diff.*`) に `collector.effect.audit` / `collector.effect.mem_bytes` が揃っているかチェックリストへ追記する。【参照: docs/plans/bootstrap-roadmap/3-2-core-collections-plan.md §2.2】
- [ ] `docs/notes/stdlib/collections-audit-bridge-todo.md` に 5.1.2 手順の追跡ログと KPI 同期予定を追加し、`ConfigMergeOutcome` → `REML_COLLECTIONS_CHANGE_SET_PATH` → `FormatterContext::change_set` の全パスがドキュメント化されていることを確認する。現状の TODO は `Core.Collections 棟` の audit_bridge 項でフォローする。
- [ ] `collector.effect.audit` を出力するシナリオで `core.collections.audit` Capability をチェックし、`CollectError::CapabilityDenied` が `reports/spec-audit/ch1/core_iter_collectors.audit.jsonl` に記録されていることを `scripts/validate-diagnostic-json.sh --pattern collector.effect.audit` で検証する。`tooling/ci/collect-iterator-audit-metrics.py --scenario audit_cap` の KPI に `collector.effect.audit_presence` と `collections.change_set.total` を追加し、`docs/plans/bootstrap-roadmap/0-3-audit-and-metrics.md` Phase3 Capability 列へ反映させる。
- [ ] `CollectError::CapabilityDenied` の発生/解消経路を `reports/spec-audit/ch1/core_iter_collectors.audit.jsonl` の `capability` ケースに記録し、`reports/iterator-collector-summary.md` `status=audit_cap` 行に `capability`/`collector.effect.audit` の webhook を添えて `scripts/poc_dualwrite_compare.sh --target audit_bridge` の `collector.capability` output を突き合わせるルーチンを確認する。
- [x] `config.diff.bridge`: `compiler/runtime/src/config/collection_diff.rs` で `SchemaDiff`/`ConfigChange` を実装し、`scripts/validate-diagnostic-json.sh --section config` で `schema_diff.*` キーの存在を検証するブロックを追加した。これにより Config/Data との差分 JSON の双方向整合性が仕様上の TODO として追跡できるようになった（2025-12-03 追記: 同セクションで Config 診断メタデータの整合チェックも実施する）。

## Config/Data 監査 TODO（W40 追加）
- [x] `config_diagnostics_pass_rate >= 0.95`: `reports/spec-audit/ch3/config_diagnostics-20251203.json` で `config.missing_manifest` シナリオをゴールデン化し、`scripts/validate-diagnostic-json.sh --section config` が `extensions["config"]` と `audit_metadata["config.*"]` を同時確認するよう更新した。CLI/LSP 双方の Config 診断が監査メタデータを欠落させた場合に即座に検出できる。

### `rust-gap` トラッキング表（2025-11-17 更新）
| 差分 ID | 章/カテゴリ | 症状 | Rust 監査手順 | 備考 |
|---------|-------------|------|----------------|------|
| `SYNTAX-002` | Chapter 1／モジュール `use` | ✅ Close (2025-11-17) | `cargo run --bin reml_frontend -- --emit-diagnostics examples/docs-examples/spec/1-1-syntax/use_nested.reml --trace-output reports/spec-audit/ch1/use_nested-YYYYMMDD-trace.md`（診断 0 件。`reports/spec-audit/ch1/use_nested-20251117-diagnostics.json` と `use_nested-20251117-trace.md` を参照）。`reports/spec-audit/diffs/SYNTAX-002-ch1-rust-gap.md` にクローズログを記載。 | `docs/spec/1-1-syntax.md` 脚注と `docs/spec/0-3-code-style-guide.md` を Rust Frontend ベースへ更新済み。`use_nested_rustcap.reml` は参考用途として残す。 |
| `SYNTAX-002/module_parser` | Chapter 1／module_parser 再実装 | `ModuleStage` 単位の再実装／TraceEvent ログ／統合テストの証跡不足 | `cargo test --manifest-path compiler/frontend/Cargo.toml parser::module -- --nocapture` のログを `reports/spec-audit/ch1/module_parser-YYYYMMDD-parser-tests.md` に保存し、`scripts/poc_dualwrite_compare.sh use_nested`/`effect_handler` 実行結果を `module_parser-YYYYMMDD-dualwrite.md` へ追記する。 | 状態: `Closed (P2-8 W38, 2025-11-20)` 。owner: Parser QA。証跡: `reports/spec-audit/ch1/module_parser-20251119-parser-tests.md`, `module_parser-20251119-dualwrite.md`, `use_nested-20251119-diagnostics.json`, `effect_handler-20251119-diagnostics.json`。 |
| `SYNTAX-003` | Chapter 1／効果構文 | ✅ Close (2025-11-18) | `scripts/poc_dualwrite_compare.sh effect_handler --trace`（`reports/spec-audit/ch1/effect_handler-YYYYMMDD-{diagnostics.json,trace.md}`、`trace-coverage-20251122.md` に `Trace coverage >= 4` の証跡を保存）。`FrontendDiagnostic.extensions.trace_ids` と `syntax:expr::<kind>` の突き合わせを `reports/spec-audit/diffs/SYNTAX-003-ch1-rust-gap.md` に記録。 | `docs/plans/rust-migration/p1-rust-frontend-gap-report.md` と `docs/plans/bootstrap-roadmap/2-8-spec-integrity-audit.md` で `Closed(P2-8)` と記録。`examples/docs-examples/spec/1-1-syntax/README.md` / `docs/spec/0-3-code-style-guide.md` に命名規約を追記 |
| `SYNTAX-003/block_scope` | Chapter 1／ブロック/代入 | `let`/`var` の BindingKind とブロック式の JSON エビデンス | `reports/spec-audit/ch1/block_scope-20251118-diagnostics.json` / `block_scope-20251118-trace.md`（Rust Parser WG, due: W37 後半）。 | `BindingKind` と `TypeAnnot::Pending` を AST に維持すること。owner: Rust Parser WG |
| `SYNTAX-003/effect_handler` | Chapter 1／effect handler 診断 | dual-write で `effects.resume.untyped` が再現しないことの監査 | `reports/spec-audit/ch1/effect_handler-20251118-diagnostics.json` / `effect_handler-20251118-dualwrite.md`（owner: Effects WG, evidence(log) 記載）。`trace-coverage-20251122.md` で `syntax:expr::<kind>` / `syntax:operation::resume` の対応関係を確認。 | KPI: `syntax.effect_construct_acceptance = 1.0`, `ci_run_id = rust-frontend-w37-20251118.2` |
| `SYNTAX-003/perform_do` | Chapter 1／perform/do フロー | `perform expr` と `do` ブロックの `EffectScopeId` 共有確認 | `cargo test --manifest-path compiler/frontend/Cargo.toml parser::expr -- --nocapture` ログを `reports/spec-audit/ch1/perform_do-20251118-log.md`（準備中）へ保存 | owner: Rust Parser WG + Effects WG（due: W37 後半）。`TraceEvent::ExprEnter(kind=\"perform\")` を記録すること |
| `ERR-001` | Chapter 2／期待集合 | Streaming Recover で `ExpectedSummary` が欠落 | `tests/streaming_runner.rs` の `streaming_expected_token_snapshot_matches` / `compiler/frontend/tests/streaming_metrics.rs` の `SampleCase` テストを `reports/spec-audit/ch1/streaming_metrics-YYYYMMDD-log.md` および `reports/spec-audit/ch2/streaming/streaming_<sample>-YYYYMMDD-diagnostics.json` で監査 | `parser.expected_summary_presence = 1.0`（`CI_RUN_ID=rust-frontend-streaming-20251121.1`）、Streaming ログ複製済み |
| `ERR-002` | Chapter 2／Recover Fix-it | `recover`/`fixit` 情報の Rust 実装反映状況 | `cargo test --manifest-path compiler/frontend/Cargo.toml parser::recover -- --nocapture` ログ | CLI/LSP JSON の `recover.fixit.*` 拡張を Chapter 2 へ反映 |
| `CAP-001` | Chapter 3／Capability Stage | `BridgeAuditMetadata::as_json` が監査ログへ未接続 | `cargo test --manifest-path compiler/runtime/ffi/Cargo.toml audit::tests::bridge_audit_metadata_as_json_serializes` の結果と `collect-iterator-audit-metrics.py --section diagnostics` | `reports/spec-audit/ch3/` に JSON を保存し、Stage 検査スクリプトと結合する |

### FRG（Rust Frontend Gap）トラッキング
| Gap ID | カテゴリ | ステータス | エビデンス |
|--------|----------|------------|------------|
| `FRG-05` | Streaming RunConfig / CLI | ✅ Closed (P2-8 W39) | `compiler/frontend/src/bin/reml_frontend.rs` が `SCHEMA_VERSION = "3.0.0-alpha"` で Stage/Audit を出力し、`scripts/poc_dualwrite_compare.sh`・`tooling/lsp/tests/client_compat/fixtures/*.json` を `reml_frontend` 呼び出しへ更新。`reports/spec-audit/ch1/use_nested-20251122-typeck.json` に `stage_trace` と `used_impls` が保存され、`docs/spec/0-3-code-style-guide.md` / `examples/docs-examples/spec/1-1-syntax/README.md` が新 CLI に合わせて改訂済み。 |
| `FRG-12` | Hindley-Milner / 型推論 | ✅ Closed (P2-8 W39) | `TypecheckDriver::infer_module` が `Option<&Module>` を受け取り、AST 不在時に `typeck.aborted.ast_unavailable` を出力。`compiler/frontend/tests/typeck_hindley_milner.rs::reports_ast_unavailable_when_module_is_absent` と `reports/spec-audit/ch1/typeck-fallback-removal-20251122.md` で診断ログと CLI 手順を記録。`docs/spec/3-6-core-diagnostics-audit.md` §1.2 に新診断を追加済み。 |
