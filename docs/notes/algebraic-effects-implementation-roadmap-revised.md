# Reml代数的効果導入ロードマップ（現実的実行案）

> 作成日: 2025年10月
> 対象バージョン: Reml v1.x 後期〜v2.x
> 参照資料: `1-3-effects-safety.md`, `docs/notes/algebraic-effects-handlers-assessment.md`, `docs/notes/algebraic-effects-handlers-spec-proposal.md`

## 0. ハイライト
- まず HM 型推論と効果タグ契約の現行挙動を壊さない PoC を最優先で検証する。
- 行多相を伴う型システム拡張は別フェーズに隔離し、PoC の成果を基に仕様を再スコープする。
- Core.Async や DSL エコシステムへの波及は実証済みのランタイム最適化が揃ってから段階的に進める。
- 既存チームの規模（開発2-3名＋専任サポート）を前提とし、並列作業が発生しないよう依存関係を明確化する。

## 1. 前提・制約
- **言語仕様の現状**: 効果はタグ集合として追跡し型とは分離（`1-3-effects-safety.md:213`）。`@pure` や `@dsl_export` はタグ包含で判定する（`1-3-effects-safety.md:223`）。
- **既存提案の整理**: 代数的効果の利点と課題は調査済み（`docs/notes/algebraic-effects-handlers-assessment.md:35`）。草案は段階導入を提案するが、実装規模が大きい（`docs/notes/algebraic-effects-handlers-spec-proposal.md:73`）。
- **リソース想定**: コア開発2名、型システム1名、ランタイム最適化1名、QA/ドキュメント1名が最大。外部貢献は限定的と想定。
- **成功条件**: 既存 DSL の互換性維持、性能劣化を 10% 未満に抑制、契約属性の再定義で既存診断品質を維持。

## 2. フェーズ構成

### フェーズ0: 準備・調査 PoC（3ヶ月, v1.x ブランチ）
- **目的**: `effect/handle` 最小構文とワンショット継続ランタイムを実験フラグ下で試す。
- **主担当**: コア開発1名 + ランタイム1名、型システムサポート0.5人月。
- **スコープ**:
  - `-Zalgebraic-effects` で有効化される AST 拡張。
  - `io`/`panic` のみを対象とした `perform` とハンドラ構文の PoC。
  - 継続はワンショットのみ、型検査は手動注釈＋簡易検証に限定。
- **成果物**:
  - RFC/メモ：PoC の API・診断・性能結果。
  - ベンチ: 小規模 DSL/Parser の性能比較（±15% 以内が目標）。
  - 相互運用テスト：`@pure` 関数でハンドラ捕捉時に警告を出さない仮実装。
- **Exit 条件**:
  - PoC 成果がレビューで承認される。
  - 既存テストをフラグ OFF で完全維持。
  - `@pure`/`@no_panic` の判定が PoC の範囲で破綻しない。

### フェーズ1: 最小実装（6ヶ月, v2.0 α）
- **目的**: フラグ付きで `effect`/`handle` を提供し、`io` と `panic` の効果捕捉に限定した安定挙動を得る。
- **主担当**: コア開発2名、ランタイム1名、型システム0.5人月。
- **スコープ**:
  - 構文と型アノテーション（`-> T ! {io}`）の導入。
  - ハンドラ適用後の残余効果計算ロジック（タグ集合差分）を実装。
  - `@pure`/`@dsl_export` 判定を「ハンドラ適用後の残余タグ」ベースに再定義。
  - LSP/診断に未処理効果を表示する最小 UI。
  - ランタイム：ワンショット継続 + トランポリン実装。
- **成果物**:
  - ドキュメント草稿（仕様更新差分）。
  - 自動テスト：`io`/`panic` 捕捉ケースの単体・統合テスト。
  - 性能測定：Parser ベンチでオーバーヘッド 10% 以内。
- **Exit 条件**:
  - 残余タグ判定が全契約属性で検証済み。
  - ハンドラ導入前後の API 互換性が回帰テストで確認済み。
  - フラグ ON で既存 DSL が最低1件通る PoC が成立。

### フェーズ2: 効果多相と型システム統合（7ヶ月, v2.0 β→RC）
- **目的**: HM 型推論と行多相を段階導入し、`@pure` 判定や DSL 契約を本番水準へ戻す。
- **主担当**: 型システム1名、コア開発1名、QA1名。
- **スコープ**:
  - 行多相をランク1に制限し、トップレベルのみ一般化。
  - 制約解決器の導入：包含・排他・残余ゼロ証明。
  - `@dsl_export` と Capability Registry の残余効果照合を刷新。
  - エラーメッセージの段階表示（推論失敗/制約衝突/未捕捉効果）。
  - IDE/LSP: 効果ツリーとハンドラ境界の可視化。
- **成果物**:
  - 仕様更新：型推論章の改訂案。
  - プロトコル：LSP 拡張ドラフト。
  - ベンチ：行多相有効時の型推論時間とメモリ測定。
- **Exit 条件**:
  - 行多相導入後も `@pure` 判定が既存コードで後方互換。
  - `@dsl_export` 検査が新旧 DSL で検証済み。
  - エラーメッセージ評価で既存対比 +20% 以内の解決時間。

### フェーズ3: エコシステム統合と最適化（9ヶ月, v2.1）
- **目的**: Core.Async/Diagnostics/IO をハンドラ基盤へ移行し、性能最適化を達成。
- **主担当**: コア開発2名、ランタイム1名、QA1名。
- **スコープ**:
  - Core.Async を `effect Async : io.async` ベースへ再設計。
  - Diagnostics/Audit のインジェクションをハンドラ経由へ移行。
  - エビデンス渡し最適化（静的解決可能なケースのゼロコスト化）。
  - 実アプリ（Parser 10MB 規模・CLI ツール）での性能/メモリ検証。
  - ドキュメント/LSP/ガイド全体更新。
- **成果物**:
  - 最適化レポート（継続捕捉 200ns, 再開 150ns 目標）。
  - 移行ガイド（旧 API からの移行例）。
  - コミュニティ向けチュートリアルとリリースノート草稿。
- **Exit 条件**:
  - オーバーヘッド 5% 以内、メモリ 110% 以内。
  - Core.Async を利用する DSL が移行完了。
  - FFI 境界と継続保存ルールの仕様化。

## 3. 横断タスク
- **仕様管理**: フェーズ毎に RFC を公開しコミュニティフィードバックを反映。
- **テスト戦略**: 回帰テストをフラグ OFF/ON で走らせ、PoC → 正式導入まで継続。
- **ツール整備**: ベンチマーク・プロファイラ・LSP 表示を段階投入。
- **ドキュメント**: 各フェーズ終了時に `1-3-effects-safety.md` と関連章を更新。

## 4. リスクと緩和策
| リスク | フェーズ | 影響 | 緩和策 |
| --- | --- | --- | --- |
| PoC で性能劣化が顕著 | 0 | 高 | ワンショット限定・トランポリン採用、必要ならフェーズ1のスコープ縮小 |
| `@pure` 判定が不安定 | 1-2 | 高 | 残余タグ計算のプロパティテスト、既存契約のゴールデンテスト追加 |
| 行多相導入で型推論が複雑化 | 2 | 中 | 制約解決を別モジュール化、段階的に IDE へ可視化を提供 |
| Core.Async 移行で互換性が崩れる | 3 | 高 | 移行前にラッパ層を用意し段階的に切り替え |
| チームリソース逼迫 | 全体 | 中 | 各フェーズ直前にスコープレビュー、必要なら期間延長や外注を検討 |

## 5. 成功指標
- **性能**: Parser ベンチ 95% 以上、Async ベンチ 90% 以上を維持。
- **品質**: 効果関連のバグ密度 1000 行あたり 0.5 未満、エラーメッセージ満足度 4.0/5.0。
- **採用**: フラグ OFF の互換性 100%、リリース後 6 ヶ月で主要 DSL の 30% が部分採用。

## 6. 直近アクション
1. フェーズ0 用 RFC テンプレートを作成し、PoC スコープをチーム合意する。
2. `@pure`/`@dsl_export` の残余タグ検証用テストハーネスを準備する。
3. Parser/Diagnostics ベンチマークのベースラインを取得し、性能指標の計測方法を確立する。

