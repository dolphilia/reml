# 第21章: 開発支援ツール

## 21.1 概要

本章では、Reml の開発プロセスを支える **周辺ツール群** と、品質を保証するための **監査ワークフロー** について解説します。

Reml の開発環境は、単にコンパイラをビルドするだけでなく、仕様への準拠状況を機械的に検証する仕組みを備えています。この仕組みは大きく分けて以下の2つの領域で構成されています。

1. **`compiler/xtask`**: `cargo xtask` コマンドを通じて実行される、開発者向けのタスクランナーです。APIの実装状況を確認する監査ツールなどがここに含まれます。
2. **`tooling/` ディレクトリ**: CI（継続的インテグレーション）やレビューで利用されるスクリプト群です。診断データの検証、監査ログの集計、レポート生成などを担当します。

Reml の設計において特徴的なのは、「監査ログとメトリクスによって、仕様と実装の差分を可視化し続ける」という方針です。本章では、これらのツールがどのように連携し、開発の健全性を保っているかを紐解きます。

### この章で扱う主なコンポーネント

- **開発タスクランナー**: `compiler/xtask/`
- **CI・監査プロセス**: `tooling/ci/`, `tooling/json-schema/`, `tooling/runtime/`
- **レビュー・可視化**: `tooling/review/`

### 参照する主なドキュメント

- `docs/guides/tooling/audit-metrics.md`: 監査とメトリクスの運用ルール
- `tooling/README.md`: ツール群の全体構成

## 21.2 データ構造

監査システムが扱う主要なデータ構造について見ていきましょう。

### 21.2.1 監査対象 API のインベントリ

`prelude-audit` コマンドなどが利用する、API の「あるべき姿」を定義したデータです。TOML形式で記述されており、`Inventory` 構造体として読み込まれます。

- **定義場所**: `compiler/xtask/src/main.rs`
- **構造体**: `Inventory`, `ApiEntry`
- **データ実体**: `docs/plans/bootstrap-roadmap/assets/prelude_api_inventory.toml`

`Inventory` は複数の `ApiEntry` を持ちます。各エントリは `module`（モジュール名）、`name`（API名）、`rust_status`（実装状況）などのフィールドを持ち、ツールはこの `rust_status` が `"implemented"` であるかどうかで実装完了を判定します。

```rust
// compiler/xtask/src/main.rs より抜粋・要約
struct Inventory {
    api: Vec<ApiEntry>,
}

struct ApiEntry {
    module: String,
    name: String,
    rust_status: Option<String>,
    // ...
}
```

### 21.2.2 SectionFilter

監査を実行する際、対象を特定のカテゴリ（ `Option`, `Result` など）に絞り込むためのフィルタです。

- **定義場所**: `compiler/xtask/src/main.rs`
- **列挙型**: `SectionFilter`

コマンドライン引数 `--section` で指定された文字列は、この `SectionFilter` 列挙型にパースされ、各モジュール名とのマッチングに使用されます。例えば `--section iter` を指定すると、`Iter` および `Collector` に関するモジュールが対象となります。

### 21.2.3 監査スキーマ

監査ログの出力形式は厳密に定義されています。JSON Schema を正として管理されており、ログファイルが構造に従っているかどうかが自動的に検証されます。

- **スキーマ定義**: `tooling/runtime/audit-schema.json`
- **検証スクリプト**: `tooling/ci/ci-validate-audit.sh`

## 21.3 アルゴリズムと実装

開発支援ツールの中核となるロジックについて解説します。

### 21.3.1 `cargo xtask` による監査実行フロー

`cargo xtask` は Rust の慣習的なタスクランナーパターンです。Reml では `compiler/xtask` パッケージがその役割を担っています。

処理の起点となるのは `compiler/xtask/src/main.rs` です。ここでは以下のフローで処理が進みます。

1. **引数の解析**: コマンドライン引数を読み取り、サブコマンド（例: `prelude-audit`）を特定します。
2. **インベントリのロード**: TOMLファイルを読み込み、`Inventory` 構造体にデシリアライズします。
3. **フィルタリング**: `--module` や `--section` といった指定に基づき、監査対象の API エントリを絞り込みます。
4. **実装状況の判定**: 各エントリの `rust_status` を確認し、未実装（`"implemented"` 以外）のものをリストアップします。
5. **結果の報告**: 全体の進捗率（対象件数、実装済み件数、未完件数）を標準出力に表示します。
6. **厳格モードの判定**: `--strict` オプションが指定されている場合、未実装項目が一つでもあれば、プロセスは非ゼロの終了コード（エラー）で終了します。これによりCI上で検出漏れを防ぎます。

### 21.3.2 監査・メトリクス運用パイプライン

監査システムは単一のツールではなく、複数のスクリプトが連携するパイプラインとして機能しています。`docs/guides/tooling/audit-metrics.md` に定義された運用フローに基づき、以下のような検証が行われます。

1. **診断 JSON の検証**:
    コンパイラが出力する診断メッセージ（エラーや警告のJSON）が、正しいスキーマに従っているかを検証します。
    - スクリプト: `tooling/json-schema/validate-diagnostic-json.sh`
    - 参照データ: `tooling/json-schema/diagnostic-v2.schema.json`
2. **監査 JSONL の検証**:
    実行時に出力される監査ログ（JSON Lines形式）の妥当性を検証します。
    - スクリプト: `tooling/ci/ci-validate-audit.sh`
    - 参照データ: `tooling/runtime/audit-schema.json`
3. **インデックス生成とレビュー**:
    検証をパスしたログからインデックスを生成し、人間がレビューしやすい形式（レポートなど）に加工します。
    - スクリプト: `tooling/ci/create-audit-index.py` など

これらの処理により、ソースコードだけでなく、コンパイラが吐き出す「振る舞いの記録」も仕様と整合していることが保証されます。

### 21.3.3 監査レビューの補助ツール

収集された監査ログの差分を確認したり、可視化したりするためのツール群が `tooling/review/` に集約されています。Pythonスクリプトが主であり、`reports/` ディレクトリに出力された生のデータを、開発者が判断しやすい情報へと加工します。

## 21.4 エラー処理

開発支援ツールにおけるエラー処理は、ユーザー（開発者）へのフィードバックを重視しています。

- **`xtask` のエラー報告**: `run` 関数内で発生したエラーは `Result` 型で捕捉され、メイン関数でキャッチされます。エラー時は `xtask エラー: ...` というプレフィックス付きでメッセージが表示され、プロセスは異常終了（exit code 1）します。
- **引数チェック**: 必須オプションの欠落や不正な値（例: 定義されていないセクション名）は即座にエラーとして報告されます。
- **スクリプトの制御**: シェルスクリプト群では、`--allow-missing` や `--fail-silently` といったオプションを提供することで、CIのステージに応じて「警告にとどめる」か「直ちに失敗させる」かを制御できるよう配慮されています。

## 21.5 発展的トピックと課題

### 21.5.1 `tooling` ディレクトリの責務境界

`tooling/` ディレクトリは、コンパイラ本体（`compiler/`）とは異なるライフサイクルを持つ周辺資産の置き場として機能しています。CI設定、監査スクリプト、IDE向け設定などがここに集約されることで、コンパイラのソースコードが「開発のためのコード」で汚染されるのを防いでいます。

- `tooling/ci/`: 自動化パイプライン用
- `tooling/review/`: 人間による分析・確認用
- `tooling/json-schema/`: 型定義・スキーマ

### 21.5.2 仕様と現状の乖離（Known Issues）

本執筆時点（2025-2026年）において、ドキュメントに記載された計画と、リポジトリの実装状態には一部乖離が見られます。これらは今後の開発で解消されるべき課題です。

1. **スクリプトの配置場所**:
    `docs/guides/tooling/audit-metrics.md` では `scripts/validate-diagnostic-json.sh` を参照していますが、実際には `tooling/json-schema/validate-diagnostic-json.sh` に移動されています。ドキュメントの更新が追いついていない箇所です。
2. **未実装のスクリプト**:
    同ガイドで言及されている `tooling/ci/collect-iterator-audit-metrics.py` は、現時点のリポジトリには存在しません。特定のメトリクス収集機能がまだ実装されていないか、別名で実装されている可能性があります。

これらの乖離は、Reml プロジェクトが急速に進化している証左でもありますが、開発に参加する際は最新のファイル構成を確認することが推奨されます。

## 21.6 まとめ

本章では、Reml の品質を底支えする開発支援ツールと監査フローについて解説しました。

- **`compiler/xtask`**: 開発者はこのコマンドを通じて、実装の進捗と仕様への適合度をいつでも確認できます。
- **監査パイプライン**: JSON Schema を活用した厳密な検証により、ログや診断メッセージの構造的一貫性が保たれています。
- **分離と統合**: 開発支援ツールは `tooling/` に分離されていますが、CIプロセスを通じて開発ワークフローに深く統合されています。

次章からは、これらのツールによって守られるべき品質をどのようにテストするか、**第7部: テストと運用** について詳述します。
