# Phase 1: reml-bindgen 設計・仕様化

## 進捗サマリ
- 実装ステップ 1〜4 完了

## 背景
- `extern "C"` を手書きする現行フローは大規模ライブラリ運用に耐えない。
- Rust `bindgen` のような自動生成経路が不可欠。

## スコープ
- C/C++ ヘッダを入力とする **Reml 向けバインディング生成仕様**の策定。
- 生成される Reml コードは **低レベルかつ `unsafe` 前提**でよい（安全ラッパーは Phase 2）。

## 成果物
- `reml-bindgen` の I/O 仕様（CLI 入出力、設定ファイル、ログ形式）
- C 型→Reml 型のマッピング表（一次案）
- `docs/spec/3-9-core-async-ffi-unsafe.md` の更新草案
- `examples/ffi` の生成例（サンプル差分）

## 仕様検討項目
1. **入力と構成**
   - 入力: ヘッダファイル（複数）、`compile_commands.json`、include パス
   - 設定: `reml-bindgen.toml`（確定）
   - 出力: `.reml` と `bindings.manifest.json`
2. **型変換表（確定・一次範囲）**
   - `bool` → `Bool`
   - `char` / `signed char` / `unsigned char` → `I8` / `U8`
   - `short` / `unsigned short` → `I16` / `U16`
   - `int` / `unsigned int` → `I32` / `U32`
   - `long` / `unsigned long` → `I64` / `U64`（LP64 を基準）
   - `long long` / `unsigned long long` → `I64` / `U64`
   - `size_t` → `USize`
   - `intptr_t` / `uintptr_t` → `ISize` / `USize`
   - `float` / `double` → `F32` / `F64`
   - `void` → `Unit`
   - `char*` → `Ptr<I8>`（文字列は Phase 2 で安全ラッパーを定義）
   - `void*` → `Ptr<Unit>`
   - `T*` → `Ptr<T>`
   - `struct` → `repr(C)` 相当のレコード定義（フィールド順固定）
   - `enum` → 整数型（基底型指定がない場合は `I32`）
   - `const` / `volatile` / `restrict`:
     - 型変換は `T` に準拠し、`Ptr<T>` の形は変更しない。
     - 修飾子は `bindings.manifest.json` に `qualifiers` として記録する。
3. **安全性境界**
   - 生成関数は `effect {unsafe, ffi}` を付与
   - `Core.Ffi` の低レベル API (`Ptr`, `Span`) を標準化
4. **監査・診断**
   - 生成時に `ffi.bindgen.*` の診断キーを定義
   - `docs/spec/3-6-core-diagnostics-audit.md` と整合

## `reml-bindgen.toml` キー一覧（確定）

| キー | 型 | 必須 | 説明 |
| --- | --- | --- | --- |
| `headers` | `string[]` | Required | 解析対象のヘッダファイル配列 |
| `include_paths` | `string[]` | Required | `-I` 相当の include パス配列 |
| `compile_commands` | `string` | Optional | `compile_commands.json` のパス（指定時は `include_paths` / `defines` を上書き可能） |
| `defines` | `string[]` | Optional | `-D` 相当の定義（`NAME` または `NAME=VALUE`） |
| `output` | `string` | Required | 生成する `.reml` の出力先 |
| `manifest` | `string` | Required | `bindings.manifest.json` の出力先 |
| `exclude` | `string[]` | Optional | 除外パターン（正規表現） |

## CLI オプション対応表（確定）

| CLI オプション | 対応キー | 説明 |
| --- | --- | --- |
| `--config <path>` | - | 設定ファイルを明示指定（既定: `reml-bindgen.toml`） |
| `--header <path>` | `headers` | ヘッダを追加（複数指定可） |
| `--include-path <path>` / `-I <path>` | `include_paths` | include パスを追加（複数指定可） |
| `--compile-commands <path>` | `compile_commands` | `compile_commands.json` を指定 |
| `--define <name[=value]>` / `-D <name[=value]>` | `defines` | プリプロセッサ定義を追加（複数指定可） |
| `--output <path>` | `output` | 生成 `.reml` の出力先 |
| `--manifest <path>` | `manifest` | `bindings.manifest.json` の出力先 |
| `--exclude <pattern>` | `exclude` | 除外パターンを追加（複数指定可） |

- CLI 指定は `reml-bindgen.toml` より優先し、配列系は **追加マージ**、単一値は **上書き** とする。

## 実装ステップ
1. `reml-bindgen.toml` のキー一覧（include パス、入力ヘッダ、出力先、除外パターン）を確定し、CLI オプション対応表を作成する。
2. 型変換表（確定・一次範囲）と修飾子扱いを `docs/spec/3-9-core-async-ffi-unsafe.md` に反映し、未対応型の診断キー案を併記する。
3. 生成コードの最小サンプル（単一ヘッダ + `bindings.manifest.json`）を `examples/ffi` に追加し、生成物と手書きラッパーを分離する構成を示す。
4. `ffi.bindgen.*` の診断キーとログ形式を整理し、レビュー手順（差分確認/再生成条件）を `docs/guides/ffi/reml-bindgen-guide.md` に記述する。

## 実装ステップ進捗
- Step 2 完了: `docs/spec/3-9-core-async-ffi-unsafe.md` に型変換表と未対応型の診断キー案を反映済み。
- Step 3 完了: `examples/ffi/bindgen/minimal` に最小サンプル（単一ヘッダ + `bindings.manifest.json`）を追加済み。
- Step 4 完了: `docs/guides/ffi/reml-bindgen-guide.md` にログ形式とレビュー手順の詳細を追記済み。

## 依存関係
- `docs/spec/3-9-core-async-ffi-unsafe.md`
- `docs/spec/3-6-core-diagnostics-audit.md`
- `docs/notes/ffi/ffi-improvement-survey.md`

## リスクと対策
- **型変換の不足**: 対応外の型は `ffi.unknown_type` として明示し、
  生成結果に TODO コメントを残す。
- **生成コードの読みづらさ**: 生成コードに `// generated by reml-bindgen` を付与し、
  `examples/ffi` では手書きラッパーとの分離を徹底する。

## 完了判定
- `reml-bindgen` の入力・出力・型変換・診断キーが `docs/spec/3-9-core-async-ffi-unsafe.md` に反映されている。
- 型変換表（確定・一次範囲）が `docs/spec/3-9-core-async-ffi-unsafe.md` に反映されている。
- CLI 仕様（設定ファイル名、ログ形式含む）が文書化されている。
- `examples/ffi` に `reml-bindgen` 生成例が追加されている。
