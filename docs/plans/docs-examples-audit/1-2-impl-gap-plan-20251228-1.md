# 1.2 実装ギャップ対応計画（Rust Frontend / 2025-12-28）

`docs/spec/3-10-core-env.md` のサンプル修正で判明した **仕様と実装のギャップ** を整理し、Rust Frontend 側で追随するための対応計画を定義する。

## 目的
- 仕様にある `pub enum` 宣言をそのまま型参照できるようにする。
- 仕様サンプルをフォールバックではなく正準表記で通せるようにする。

## 対象範囲
- 仕様章: `docs/spec/3-10-core-env.md`
- サンプル: `examples/docs-examples/spec/3-10-core-env/sec_1-b.reml`

## ギャップ一覧（サンプル修正で回避済み）

### 1. `enum` 宣言が型として解決されない
- 影響: `pub enum EnvErrorKind = ...` を宣言しても `EnvErrorKind` が `type.unresolved_ident` になる。
- 回避: `pub type EnvErrorKind = | ...` へ置換し、型定義として解釈させる。

## 実装修正計画（Rust Frontend）

### フェーズ 1: 型登録の整備
1) `enum` 宣言の型シンボル登録
- 対象: `compiler/frontend/src/parser/ast.rs`, `compiler/frontend/src/typeck/`
- 目的: `enum` 宣言で型名を環境に登録し、型参照で解決できるようにする。
- 詳細ステップ:
  - `compiler/frontend/src/parser/ast.rs` で `EnumDecl` の意味付けを確認し、型定義として扱う前提を明文化できる箇所を整理する（コメント or 構造体名の見直し候補をメモ）。
  - 型登録の入口（decl 収集/シンボル登録/型環境構築の順序）を確認し、`enum` が登録漏れしている箇所を特定する。
  - `TypeDefKind::Enum` の追加/流用が必要かを確認し、既存の `TypeDefKind` 分岐に `EnumDecl` を割り当てる。
  - 型環境への登録処理で `EnumDecl` を型名として記録し、後段の型参照解決に引き渡す。
  - `type.unresolved_ident` の解決パス（型名解決側）に `EnumDecl` 起点の参照を追加する。
  - 既存の `pub type` と `pub enum` の挙動差がないことを確認し、必要なら診断やエラーメッセージの文言を揃える。
- 成果物: `pub enum Foo = A | B` を型として参照しても診断 0 件になる。

### フェーズ 2: 仕様サンプルの復元
1) 仕様サンプルの復元
- 対象: `examples/docs-examples/spec/3-10-core-env/sec_1-b.reml`
- 目的: `pub type EnvErrorKind` のフォールバックを `pub enum EnvErrorKind` に戻す。
- 詳細ステップ:
  - 仕様コードブロックとサンプルで `EnvErrorKind` の記法差分がないか再確認する。
  - `examples/docs-examples/spec/3-10-core-env/sec_1-b.reml` の `EnvErrorKind` を `enum` 記法へ戻す。
  - `reml_frontend --output json` を実行し、診断が 0 件であることを確認する。
  - 診断が出る場合はフェーズ 1 の追加修正点をメモし、計画に追記する。
  - `docs/plans/docs-examples-audit/1-2-spec-sample-fix-targets.md` の対象差分を更新する。

## 進捗管理
- 本計画書作成日: 2025-12-28
- 進捗欄（運用用）:
  - [ ] フェーズ 1 完了（型登録の整備）
  - [ ] フェーズ 2 完了（サンプル復元・診断 0 件確認）

## 関連リンク
- `docs/spec/3-10-core-env.md`
- `docs/plans/docs-examples-audit/1-2-spec-sample-fix-plan.md`
