# 1.2 実装ギャップ対応計画（Core.Test.Dsl / 2025-12-29）

`docs/spec/3-11-core-test.md` のサンプル修正で判明した **仕様と実装のギャップ** を整理し、Rust Frontend 側で追随するための対応計画を定義する。

## 目的
- `Core.Test.Dsl` のブロック構文（`test_parser { case ... }`）を仕様通りに受理できるようにする。
- フォールバックに置き換えたサンプルを正準例へ戻す。

## 対象範囲
- 仕様章: `docs/spec/3-11-core-test.md`（7.1/7.3）
- サンプル:
  - `examples/docs-examples/spec/3-11-core-test/sec_7_1.reml`
  - `examples/docs-examples/spec/3-11-core-test/sec_7_3.reml`
- 監査ログ: `reports/spec-audit/ch3/docs-examples-fix-notes-20251229.md`（作成予定）

## ギャップ一覧（回避済み）

### 1. `test_parser { case ... }` ブロック構文の未対応
- 影響: `test_parser(my_parser) { case ... }` を含むコードが `parser.syntax.expected_tokens` で失敗する。
- 該当サンプル:
  - `examples/docs-examples/spec/3-11-core-test/sec_7_1.reml`
  - `examples/docs-examples/spec/3-11-core-test/sec_7_3.reml`
- 現状の回避: ケース配列を構築して `test_parser(my_parser, cases)` を呼ぶ明示形へ置換。

## 実装修正計画（Rust Frontend）

### フェーズ 1: 構文受理（最小限のパース対応）
1) `test_parser { case ... }` の構文糖衣を追加
- 目的: `test_parser(expr) { case ... }` を `test_parser(expr, cases)` へ変換する構文糖衣として受理する。
- 成果物: `sec_7_1.reml` / `sec_7_3.reml` が `--emit-diagnostics` で診断 0 件になる。
- 作業ステップ:
  - 既存の `test_parser(expr, cases)` 呼び出しの文法規則とトークン列を確認し、追加規則が衝突しない位置を特定する。
  - `test_parser(<expr>) { ... }` のブロックをパースする専用ルールを追加する（`block` 内で `case` を反復パース）。
  - `case <string> => <expr>` を `DslCase` 相当のレコードへ展開する式を組み立てる。
  - `case` の `name` は省略可能とし、`source` に文字列リテラルを必須とする。
  - `case` 行の `=>` 右辺が省略/欠落した場合は `parser.syntax.expected_tokens` を返す。
  - ブロック終端 `}` の欠落時は既存の `parser.syntax.expected_tokens` へ誘導し、位置情報が `case` 行を指すことを確認する。
  - 既存の構文エラー回復が `case` の連続に影響しないかを確認し、必要なら `case` 専用の回復ポイントを追加する。
  - 新規構文の識別子は `test_parser` のみ対象とし、他の DSL 呼び出しには影響しないことを確認する。

### フェーズ 2: AST/MIR への展開方針
- `test_parser(parser) { ... }` をパース時に `test_parser(parser, cases)` へ desugar する。
- `cases` は `List<DslCase<T>>` を構築する式として AST に保持する。
 - 作業ステップ:
  - 既存の `test_parser` 呼び出しを表現する AST ノード/構造体を確認し、追加フィールド不要で変換できることを確認する。
  - `case` を収集した時点で `cases` の AST 式（配列/リスト構築）を組み立てる。
  - `DslCase` のレコード構造（`name` / `source` / `expect`）と対応づくキー名を仕様から照合する。
  - 型推論や式種別の整合を確認し、`cases` 構築で型エラーが起きる場合は診断を追加する。
  - desugar 後の AST を既存の `test_parser(expr, cases)` と同一の経路で型検査/評価できることを確認する。

### フェーズ 3: サンプル復元と再検証
1) サンプルを正準例へ戻す
- `sec_7_1.reml` / `sec_7_3.reml` をブロック構文へ復元する。
- `docs/spec/3-11-core-test.md` の 7.1/7.3 コードブロックを正準例へ戻す。
 - 作業ステップ:
  - 既存のフォールバック実装（`cases` 配列構築）をブロック構文へ置き換える。
  - ブロック内の `case` に `name` の有無が混在する場合の表記を仕様に合わせて揃える。
  - 仕様文書側のコードブロックとサンプルファイルの内容が一致するよう同期する。

2) 再検証
- `cargo build --manifest-path compiler/frontend/Cargo.toml --bin reml_frontend` を実行する。
- `compiler/frontend/target/debug/reml_frontend --emit-diagnostics <sample>` を実行し、診断 0 件を確認する。
- `reports/spec-audit/ch3/3-11-core-test__sec_7_1-YYYYMMDD-diagnostics.json` / `sec_7_3` を更新する。
 - 作業ステップ:
  - `sec_7_1.reml` / `sec_7_3.reml` を個別に実行し、診断出力を保存する。
  - 既存の監査ログと差分を比較し、診断コードの変化がないことを確認する。
  - 監査ログファイル名の日付を作業日で更新し、追記内容にブロック構文復元の旨を記録する。

## 進捗管理
- 本計画書作成日: 2025-12-29
- 進捗欄（運用用）:
  - [ ] フェーズ 1 完了
  - [ ] フェーズ 2 完了
  - [ ] フェーズ 3 完了

## 関連リンク
- `docs/spec/3-11-core-test.md`
- `docs/plans/docs-examples-audit/1-2-spec-sample-fix-plan.md`
