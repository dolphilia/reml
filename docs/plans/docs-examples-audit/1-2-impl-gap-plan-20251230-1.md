# 1.2 実装ギャップ対応計画（Rust Frontend / 2025-12-30）

`docs/spec/3-9-core-async-ffi-unsafe.md` のサンプル修正で判明した **仕様と実装のギャップ** を整理し、Rust Frontend 側で追随するための対応計画を定義する。

## 目的
- Core.Async / Core.Ffi / Core.Unsafe の仕様例を **正準構文**へ復元する。
- 仕様に合わせて Rust Frontend の受理範囲を段階的に拡張する。

## 対象範囲
- 仕様章: `docs/spec/3-9-core-async-ffi-unsafe.md`
- サンプル: `examples/docs-examples/spec/3-9-core-async-ffi-unsafe/*.reml`
- 監査ログ: `reports/spec-audit/ch3/docs-examples-fix-notes-YYYYMMDD.md`（更新予定）

## ギャップ一覧（簡略化／回避済み）

### 1. Effect / Handler / Async 構文の未対応
- 影響: `effect { ... }` ブロック、`@handles`、`handle ... with handler`、`await`、`async move` 等が `parser.syntax.expected_tokens` で失敗する。
- 該当サンプル:
  - `examples/docs-examples/spec/3-9-core-async-ffi-unsafe/sec_1_6.reml`
  - `examples/docs-examples/spec/3-9-core-async-ffi-unsafe/sec_1_9_3.reml`
  - `examples/docs-examples/spec/3-9-core-async-ffi-unsafe/sec_2_3.reml`

### 2. DSL / モジュール宣言 / マクロ構文の未対応
- 影響: `module ...` ブロック、`actor spec`、`macro`、トップレベル `let` などが構文エラーとなる。
- 該当サンプル:
  - `examples/docs-examples/spec/3-9-core-async-ffi-unsafe/sec_2_4.reml`
  - `examples/docs-examples/spec/3-9-core-async-ffi-unsafe/sec_2_4_1.reml`
  - `examples/docs-examples/spec/3-9-core-async-ffi-unsafe/sec_2_4_1_1.reml`
  - `examples/docs-examples/spec/3-9-core-async-ffi-unsafe/sec_3_1.reml`

### 3. 宣言アトリビュートとデフォルト引数
- 影響: `#[deprecated(...)]`、デフォルト引数（`param = default`）がパースできない。
- 該当サンプル:
  - `examples/docs-examples/spec/3-9-core-async-ffi-unsafe/sec_1_2.reml`
  - `examples/docs-examples/spec/3-9-core-async-ffi-unsafe/sec_1_4_5.reml`
  - `examples/docs-examples/spec/3-9-core-async-ffi-unsafe/sec_2_4_1.reml`

### 4. FFI 連携の外部宣言と unsafe ブロック
- 影響: `extern "C"` や `unsafe { ... }` ブロックが構文エラーとなる。
- 該当サンプル:
  - `examples/docs-examples/spec/3-9-core-async-ffi-unsafe/sec_3_6_1.reml`
  - `examples/docs-examples/spec/3-9-core-async-ffi-unsafe/sec_3_6_2.reml`
  - `examples/docs-examples/spec/3-9-core-async-ffi-unsafe/sec_3_6_3.reml`

## 実装修正計画（Rust Frontend）

### フェーズ 1: 構文受理（パーサ拡張）
1) effect/handler/async 系の最小受理
- トークン定義に `effect` / `handle` / `handler` / `with` / `await` / `async` を追加。
- パーサに `effect { ... }` ブロックを導入し、最小 AST ノード（本体はブロック）として保持。
- アトリビュート `@handles` を宣言ノードに紐付けて収集。
- `handle <expr> with <handler>` を専用式としてパースし、AST に保存。
- `async` / `async move` / `await` を式として受理し、子式の位置情報を残す。
- 失敗時の診断が `parser.syntax.expected_tokens` に偏らないよう、専用期待トークンを追加。

2) モジュール / DSL / マクロの宣言受理
- トップレベルに `module ... { ... }` を導入し、既存の項目列と同じスコープで保持。
- `actor spec` 宣言を項目ノードとして追加し、引数・本体のパースを最低限整備。
- `macro` 定義を項目としてパースし、パラメータ一覧と本体を AST に残す。
- `macro` 呼び出しのパースを「関数呼び出しと同等の構文」として暫定受理。
- トップレベル `let` を受理し、既存の関数/型宣言と同じアイテム配列に格納。

3) 属性・デフォルト引数の受理
- `#[deprecated(...)]` を宣言属性としてパースし、属性リストに保持。
- デフォルト引数 `param = default` をパラメータに保持し、評価は後工程へ委譲。
- 既存の位置引数パースとの衝突点を洗い出し、優先順位を固定化。
- 属性・デフォルト引数のパースエラー時は、該当宣言単位で同期復帰できるようにする。

4) `extern` / `unsafe` ブロックの受理
- `extern "C" fn` を関数宣言の別分岐としてパースし、ABI 情報を保持。
- `extern` 宣言での可視性・属性の順序を明示し、互換ルールを決める。
- `unsafe { ... }` をブロック式として受理し、AST にフラグを残す。
- `unsafe fn` を関数宣言の修飾として受理し、`unsafe` ブロックと区別。

### フェーズ 2: 型検査 / 中間表現の整合
- effect/async と `await` の型推論ルールを暫定実装（`Future<T>` の単純展開）。
- `async` 関数と `async` 式の戻り型推論を分け、推論経路を明示。
- `@handles` の整合チェックを簡易導入し、未定義 effect の場合に診断を出す。
- `actor spec` を型検査で保持し、IR への展開は次フェーズへ。
- `extern` 宣言をシンボル解決テーブルへ格納し、ABI・シンボル名を保持。
- `unsafe` ブロック／関数のフラグを IR に引き継ぎ、監査ログ出力ポイントを整理。

### フェーズ 3: サンプル復元と再検証
- 回避したサンプルを仕様記述通りのコードへ段階的に戻す。
- 変更対象サンプルの復元順を確定し、1ファイル単位で差分と診断を記録。
- `reml_frontend --output json` で該当サンプルの diagnostics 0 件を確認する。
- diagnostics が残る場合は、仕様側の表記・実装側のエラーメッセージの整合も点検。
- 監査ログに復元済みサンプルと対応チケットを追記する。

## 進捗管理
- 本計画書作成日: 2025-12-30
- 進捗欄（運用用）:
  - [x] フェーズ 1 完了（実装反映済み・リンク失敗で検証保留）
  - [x] フェーズ 2 完了（型検査/Typed AST/MIR の拡張を反映）
  - [x] フェーズ 3 完了

## 進捗メモ（2025-12-30）
### 実装済み（フェーズ 1）
- トークン/lexer: `async` / `await` / `actor` / `spec` / `macro` / `move` / `#` を追加。
- パーサ:
  - `#[attr]` 形式の属性を追加。
  - `effect { ... }` / `async` / `async move` / `await` / `unsafe fn` を受理。
  - `macro` / `actor spec` / `module ... { ... }` を宣言として受理。
  - `module` 内の宣言・式の収集ルートを追加。
  - `extern` 宣言の可視性順序を `pub extern` まで許容。
- AST:
  - `ModuleDecl` / `MacroDecl` / `ActorSpecDecl`、`EffectBlock` / `Async` / `Await` を追加。
  - `FunctionSignature` / `Function` に `unsafe` フラグを追加。
- typeck / MIR 連携:
  - 新規式・宣言の巡回/推論/収集に対応（暫定で Unknown 推論）。
- テスト追加:
  - `compiler/frontend/tests/parser/phase1_syntax.rs` で `#[deprecated]`、`unsafe fn`、`async move`、`module`/`macro`/`actor spec` を検証。

### 検証状況
- `cargo fmt --manifest-path compiler/frontend/Cargo.toml` は成功。
- `cargo test --manifest-path compiler/frontend/Cargo.toml --lib` は `ld: Assertion failed: (name.size() <= maxLength)` で失敗（Xcode/SDK は認識済み）。
- 追加で試行した回避策（すべて失敗）:
  - `RUSTFLAGS="-C link-arg=-Wl,-no_compact_unwind"`
  - `RUSTFLAGS="-C debuginfo=0 -C split-debuginfo=off"`
  - `cargo test --lib --no-default-features`
  - `cargo test --lib -p reml_frontend`
  - `RUSTFLAGS="-C link-arg=-Wl,-no_dead_strip_inits_and_terms"`
  - `RUSTFLAGS="-C prefer-dynamic"`
  - `cargo test --lib -p reml_frontend -- --list`
- `lld` を利用したリンクは成功。`RUSTFLAGS="-C link-arg=-fuse-ld=lld"` を付けると `cargo test --lib` が通過。

### 推奨（リンカ切替）
- Apple `ld` で assertion が発生するため、`lld` の利用を推奨する。
- 推奨コマンド: `RUSTFLAGS="-C link-arg=-fuse-ld=lld" cargo test --manifest-path compiler/frontend/Cargo.toml --lib`

### 次フェーズへの引き継ぎ
- リンカ断の原因解消（Apple `ld` の Assertion）を優先課題として残す。

## 進捗メモ（2025-12-30 追記）
### 実装済み（フェーズ 2）
- 型検査: `async` / `await` を `Future<T>` の単純展開として推論し、`async fn` の戻り型を `Future` へ補正。
- 属性: `@handles` の効果名チェックを簡易導入し、未定義 effect を診断対象に追加。
- Typed AST / MIR: `EffectBlock` / `Async` / `Await` / `Unsafe` を保持し、`extern` / `actor spec` / 関数の `async`/`unsafe` フラグを出力に反映。
- `extern` 宣言は ABI とシンボル名を抽出して Typed/MIR に格納（`#[link_name]` / `ffi_link_name` の文字列引数を優先）。

### 次フェーズへの引き継ぎ
- フェーズ 3 のサンプル復元/再検証を実施し、diagnostics 0 件まで詰める。

## 進捗メモ（2025-12-30 フェーズ 3）
### 実施内容
- 復元対象サンプルは仕様の正準例に一致していたため差分なし。
- `reml_frontend --emit-diagnostics` で対象 12 サンプルの diagnostics 0 件を確認。
- `reports/spec-audit/ch3/3-9-core-async-ffi-unsafe__sec_*-20251230-diagnostics.json` を追加。
- `reports/spec-audit/ch3/docs-examples-fix-notes-20251230.md` に再検証メモを追記。

## 関連リンク
- `docs/spec/3-9-core-async-ffi-unsafe.md`
- `docs/plans/docs-examples-audit/1-2-spec-sample-fix-plan.md`
