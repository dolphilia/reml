# 1.2 実装ギャップ対応計画（Rust Frontend / 2025-12-27）

`docs/spec/2-7-core-parse-streaming.md` のサンプル修正で判明した **仕様と実装のギャップ** を整理し、Rust Frontend 側で追随するための対応計画を定義する。

## 目的
- 仕様で示される `enum` / `trait` / 変種ペイロード付き合成型の構文を Rust Frontend が受理できるようにする。
- フォールバックで簡略化したサンプルを正準例へ戻す。

## 対象範囲
- 仕様章: `docs/spec/2-7-core-parse-streaming.md`
- サンプル: `examples/docs-examples/spec/2-7-core-parse-streaming/*.reml`

## ギャップ一覧（簡略化／回避済み）

### 1. `enum` 宣言の未対応
- 影響: `enum Foo = A | B` 形式が `parser.syntax.expected_tokens` で失敗する。
- 該当サンプル:
  - `sec_b_2.reml` (`StreamErrorKind`)
  - `sec_d.reml` (`FlowMode` / `FlowPolicy`)
  - `sec_e.reml` (`PendingReason`)
- 現状の回避: `type` の union（文字列リテラル or 型名 union）へ簡略化。

### 2. `trait` 宣言の未対応
- 影響: `trait Feeder { fn ... }` が構文エラーとなる。
- 該当サンプル:
  - `sec_b_1.reml`
- 現状の回避: `type Feeder = { pull: fn(&mut Feeder, DemandHint) -> FeederYield }` に置換。

### 3. union 変種のインラインペイロード未対応
- 影響: `type StreamOutcome<T> = | Completed { ... } | Pending { ... }` のような変種 + レコードの直結が構文エラーになる。
- 該当サンプル:
  - `sec_a_1-b.reml` (`StreamOutcome`)
  - `sec_d.reml` (`FlowPolicy`)
  - `sec_e.reml` (`StreamEvent`)
- 現状の回避: 変種ごとに `type` を分け、`type StreamOutcome<T> = Completed<T> | Pending<T>` で表現。

## 実装修正計画（Rust Frontend）

### フェーズ 1: 構文受理（`enum` / `trait`）
1) `enum` 宣言のパーサ追加
- 目的: `enum Name = Variant | ...` を受理し AST に保持できるようにする。
- 詳細ステップ:
  - 仕様サンプルから `enum` の最小構文を抽出し、許容するトークン列（`enum` / 識別子 / `=` / `|` / `,` 等）を明記する。
  - 字句: `compiler/frontend/src/token.rs` に `enum` キーワード追加、`keyword_literal` の対応、既存キーワード表と整合を取る。
  - AST: `compiler/frontend/src/parser/ast.rs` に `EnumDecl` / `EnumVariant` などの構造体と `DeclKind::Enum` を追加し、`render` も実装する。
  - パーサ: `compiler/frontend/src/parser/mod.rs` の宣言パーサに `enum` ルールを追加し、既存 `type` / `struct` / `trait` と同じ回復戦略で組み込む。
  - 診断: 期待トークンの収集や `parser.syntax.expected_tokens` のメッセージが `enum` で破綻しないことを確認する。
- 成果物: `sec_b_2.reml` / `sec_d.reml` / `sec_e.reml` が診断 0 件。

2) `trait` 宣言のパーサ追加
- 目的: `trait Name { fn ... }` を受理し AST に保持できるようにする。
- 詳細ステップ:
  - `compiler/frontend/src/parser/ast.rs` の `TraitDecl` / `TraitItem` の現行定義を確認し、足りないフィールド（例: ジェネリクス、`where` 句等）があれば拡張する。
  - `compiler/frontend/src/parser/mod.rs` に `trait` 宣言パーサを実装し、`fn` / `type` / `const` など仕様にある要素のうち必須分をまず受理する。
  - `parser.syntax.expected_tokens` の期待値に `trait` ブロック終端（`}`）が出るケースを追加し、回復時に過剰な診断が出ないことを確認する。
  - `render` 出力がデバッグ用途として有用になるよう、`TraitDecl` の出力ラベルを整える。
- 成果物: `sec_b_1.reml` が診断 0 件。

### フェーズ 2: 変種ペイロード構文の受理
- 目的: `| Variant { field: Type, ... }` を `enum` / `type` union の両方で許可する。
- 詳細ステップ:
  - AST で「変種名 + 省略可能ペイロード（レコード / タプル）」を表現できるよう `TypeKind::Union` の構造を拡張する（例: `TypeUnionVariant` を新設）。
  - `enum` 変種パーサと `type` union のパーサで、`| Variant { ... }` と `| Variant(Type, ...)` の両構文を許可するかを仕様に合わせて確定する。
  - `compiler/frontend/src/parser/mod.rs` の型構文パーサに分岐を追加し、既存の `TypeKind::Record` / `TypeKind::Tuple` と衝突しないよう優先順位を調整する。
  - `render` と診断コードが新しい変種表現を正しく出力できることを確認する。
- 成果物: `sec_a_1-b.reml` / `sec_d.reml` / `sec_e.reml` が正準例のまま診断 0 件。

### フェーズ 3: サンプル復元と再検証
1) サンプルを正準例へ戻す
- `examples/docs-examples/spec/2-7-core-parse-streaming/` を仕様ブロックと一致する形へ復元。
- `docs/spec/2-7-core-parse-streaming.md` のコードブロックも正準例へ戻す。
- `docs/plans/docs-examples-audit/1-2-spec-sample-fix-targets.md` の「修正済み/未修正」欄を実態に合わせて更新する。

2) 再検証
- `cargo build --manifest-path compiler/frontend/Cargo.toml --bin reml_frontend`
- `compiler/frontend/target/debug/reml_frontend --emit-diagnostics <sample>`
- `compiler/frontend/tests/cli/test_diagnostics.rs` に必要なケースを追加し、`enum` / `trait` / 変種ペイロードの診断 0 件を自動確認できるようにする。
- diagnostics 0 件を確認し、`docs/plans/docs-examples-audit/1-2-spec-sample-fix-targets.md` を更新。

## 進捗管理
- 本計画書作成日: 2025-12-27
- 進捗欄（運用用）:
- [x] フェーズ 1 完了
- [x] フェーズ 2 完了
- [x] フェーズ 3 完了

## 関連リンク
- `docs/spec/2-7-core-parse-streaming.md`
- `docs/plans/docs-examples-audit/1-2-spec-sample-fix-plan.md`
