# 1.2 実装ギャップ対応計画（Rust Frontend / 2025-12-29）

`docs/spec/3-16-core-dsl-paradigm-kits.md` のサンプル修正で判明した **仕様と実装のギャップ** を整理し、Rust Frontend 側で追随するための対応計画を定義する。

## 目的
- 仕様に合わせて Rust Frontend の受理範囲を拡張する。
- フォールバックで回避したサンプルを正準例へ戻す。

## 対象範囲
- 仕様章: `docs/spec/3-16-core-dsl-paradigm-kits.md`
- サンプル: `examples/docs-examples/spec/3-16-core-dsl-paradigm-kits/sec_3_2.reml`
- 監査ログ: `reports/spec-audit/ch3/docs-examples-fix-notes-20251229.md`

## ギャップ一覧（簡略化／回避済み）

### 1. 修飾付き関数宣言の未対応
- 影響: `fn Module.func<T>(...)` の形式が `parser.syntax.expected_tokens` 相当で失敗する。
- 該当サンプル:
  - `examples/docs-examples/spec/3-16-core-dsl-paradigm-kits/sec_3_2.reml`
- 現状の回避: `fn call<T>` / `fn lookup<T>` のようにモジュール修飾を外した関数宣言へ置換。

## 実装修正計画（Rust Frontend）

### フェーズ 1: 構文受理（最小限のパース対応）
1) 修飾付き関数宣言のパーサ追加
- 目的: 関数宣言の識別子位置で `QualifiedName` を受理できるようにする。
- 成果物: `fn Core.Dsl.Object.call<Value>(...)` が構文エラーなしで受理される。
- 作業ステップ:
  - 関数宣言を構文解析しているエントリポイントを特定し、宣言名のパース部分を抽出する。
  - 宣言名パーサで `Ident` の代わりに `QualifiedName` を許可し、単一識別子と共通パスで処理できるようにする。
  - `QualifiedName` の直後にジェネリクス（`<T>`）が続くケースを許容し、既存の型引数パースと連結する。
  - `QualifiedName + TypeParams` の AST 形を保持し、従来の `Ident + TypeParams` との差分が後続処理に漏れないようにする。
  - 構文エラー時の期待トークンが既存の `parser.syntax.expected_tokens` と一致するよう、回復分岐を調整する。
  - 最低限のパース確認として、修飾付き宣言の入出力が確認できるユニットテストまたはスナップショットを追加する。

### フェーズ 2: AST/解決パスの整合
1) 宣言名の取り扱い
- 目的: 既存のスコープ解決と衝突しない形で修飾名の宣言を保持する。
- 作業ステップ:
  - 関数宣言 AST に `QualifiedName` を保持できるフィールドを追加し、従来の `Ident` と両対応できる構造にする。
  - AST 生成の段階で `QualifiedName` と型引数の結合情報を欠落させないよう、変換処理を更新する。
  - スコープ登録時に `Module.func` 形式の宣言名を表現できるキー構造へ拡張する。
  - 既存の単一識別子宣言と修飾付き宣言の衝突ルールを整理し、必要なら診断を追加する。
  - 解決処理の途中で参照名の正規化が行われる場合、修飾名が消えないことを確認するテストを追加する。

### フェーズ 3: サンプル復元と再検証
1) サンプルを正準例へ戻す
- `sec_3_2.reml` の関数宣言を `fn Object.call<T>` 形式に復元する。
- `docs/spec/3-16-core-dsl-paradigm-kits.md` の 3.2 節コードブロックを正準例へ戻す。

2) 再検証
- `cargo build --manifest-path compiler/frontend/Cargo.toml --bin reml_frontend` で再ビルドする。
- `compiler/frontend/target/debug/reml_frontend --output json <sample>` を実行し、診断 0 件を確認する。
- `docs/plans/docs-examples-audit/1-2-spec-sample-fix-targets.md` の該当行の注記を更新する。
 - `reports/spec-audit/ch3/docs-examples-fix-notes-20251229.md` に復元内容と結果を記録する。

## 進捗管理
- 本計画書作成日: 2025-12-29
- 進捗欄（運用用）:
  - [ ] フェーズ 1
  - [ ] フェーズ 2
  - [x] フェーズ 3

## 関連リンク
- `docs/spec/3-16-core-dsl-paradigm-kits.md`
- `docs/plans/docs-examples-audit/1-2-spec-sample-fix-plan.md`
