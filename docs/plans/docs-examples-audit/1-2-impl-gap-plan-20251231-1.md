# 1.2 実装ギャップ対応計画（Rust Frontend / 2025-12-31）

`docs/spec/5-1-system-plugin.md` のサンプル修正で判明した **仕様と実装のギャップ** を整理し、Rust Frontend 側で追随するための対応計画を定義する。

## 目的
- 仕様側で提示した構文表現（固定長配列、関数型引数名、struct 型参照）を Rust Frontend で受理できるようにする。
- フォールバックで簡略化したサンプルを正準例へ戻す。

## 対象範囲
- 仕様章: `docs/spec/5-1-system-plugin.md`
- サンプル:
  - `examples/docs-examples/spec/5-1-system-plugin/sec_1.reml`
  - `examples/docs-examples/spec/5-1-system-plugin/sec_2.reml`
- 監査ログ: `reports/spec-audit/ch5/docs-examples-audit-YYYYMMDD.md`

## ギャップ一覧（簡略化／回避済み）

### 1. 固定長配列型 `[T; N]` の未対応
- 影響: `[i64; 6]` が `parser.syntax.expected_tokens` で失敗する。
- 該当サンプル: `examples/docs-examples/spec/5-1-system-plugin/sec_1.reml`
- 現状の回避: `SyscallArgs = [i64]` に置き換え、最大 6 引数はコメントで表現。

### 2. 関数型内の引数名の未対応
- 影響: `fn(fd: i32, buf: Ptr<u8>, len: usize)` が構文エラーになる。
- 該当サンプル: `examples/docs-examples/spec/5-1-system-plugin/sec_2.reml`
- 現状の回避: `fn(i32, Ptr<u8>, usize)` の位置引数へ簡略化。

### 3. `struct` 宣言の型参照が未解決
- 影響: `pub struct LinuxSyscalls { ... }` を `PlatformSyscalls` から参照すると `type.unresolved_ident` になる。
- 該当サンプル: `examples/docs-examples/spec/5-1-system-plugin/sec_2.reml`
- 現状の回避: `pub type LinuxSyscalls = { ... }` のレコード型へ差し替え。

## 実装修正計画（Rust Frontend）

### フェーズ 1: 構文受理の拡張
1) 固定長配列型 `[T; N]` をパース可能にする
- `compiler/frontend` 内の `Type` 構文定義とパーサ実装を確認し、配列型の分岐点を特定する。
- `[` `Type` `;` `Expr` `]` の分岐を追加し、`Expr` のうち整数リテラル（`i64` / `u64`）のみを受理するガードを入れる。
- `N` が整数リテラル以外の場合は `parser.syntax.expected_tokens` に落とし、診断メッセージで `array length must be integer literal` 相当の説明を付ける。
- AST に固定長配列を表す型バリアントが無い場合は追加し、長さ式は `ConstExpr` 相当の最小表現で保持する。
- 既存の `[T]` 可変長配列との曖昧性を回避するため、`[` `Type` `;` の時点で固定長として確定する分岐順を調整する。

2) 関数型引数名の許容
- `fn` 型の引数パーサで `name: Type` の形を追加し、従来の `Type` 単体も継続受理する。
- 引数名はトークン情報として保持し、AST の `FnType` に `param_labels: Vec<Option<Ident>>` を追加して同期させる。
- `param_labels` が未使用でも将来の診断や LSP で参照できるように保持し、`Display` / `Debug` 出力の整合を確認する。
- 既存の関数型パース結果と互換になるよう、引数名無しの場合は `None` を格納する。

### フェーズ 2: 型解決の整備
1) `struct` 型の登録
- `struct` 宣言の収集フェーズを確認し、型環境（`TypeEnv` / `TypeRegistry`）への登録処理を追加する。
- `type` 宣言と同様に `struct` 名を `TypeId` へ紐付け、参照側で `type.unresolved_ident` を回避できるようにする。
- `pub struct` の公開可視性が型解決に影響しないことを確認し、必要なら可視性情報を `TypeDecl` に保持する。
- `struct` と `type` の同名競合時の診断方針を決め、既存の重複定義診断に合流させる。

### フェーズ 3: サンプル復元と再検証
- `examples/docs-examples/spec/5-1-system-plugin/sec_1.reml` を `[i64; 6]` へ復元し、コメントで回避していた説明を削除する。
- `examples/docs-examples/spec/5-1-system-plugin/sec_2.reml` を引数名付き関数型と `pub struct` 定義へ戻す。
- `docs/spec/5-1-system-plugin.md` の該当コードブロックも同じ正準例へ同期させる。
- `compiler/frontend/target/debug/reml_frontend --output json` で診断 0 件を確認し、差分を監査ログへ追記する。
- 監査ログ `reports/spec-audit/ch5/docs-examples-audit-YYYYMMDD.md` に復元結果と診断 0 件を記録する。

## 進捗管理
- 本計画書作成日: 2025-12-31
- 進捗欄（運用用）:
  - [x] フェーズ 1 完了（固定長配列 / 関数型引数名の構文受理）
  - [ ] フェーズ 2 完了（struct 型登録）
  - [x] フェーズ 3 完了（サンプル復元 / 再検証）

## 進捗メモ
- フェーズ 1: Type の固定長配列と関数型引数名は parser/AST 反映済み。
- フェーズ 2: struct 型の型登録は未対応。
- フェーズ 3: `examples/docs-examples/spec/5-1-system-plugin/` の正準例復元は完了。

## 進捗メモ（2025-12-31 フェーズ 3）
- `examples/docs-examples/spec/5-1-system-plugin/sec_1.reml` と `sec_2.reml` を正準例へ復元。
- `docs/spec/5-1-system-plugin.md` のコードブロックを正準例へ同期。
- `reml_frontend --emit-diagnostics` で diagnostics 0 件を確認し、`reports/spec-audit/ch5/docs-examples-audit-20251231.md` に記録。

## 関連リンク
- `docs/spec/5-1-system-plugin.md`
- `docs/plans/docs-examples-audit/1-2-spec-sample-fix-plan.md`
