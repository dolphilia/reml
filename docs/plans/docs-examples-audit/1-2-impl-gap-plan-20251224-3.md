# 1.2 実装ギャップ対応計画（Rust Frontend / 2025-12-24）

`docs/spec/2-1-parser-type.md` のサンプル修正で判明した **仕様と実装のギャップ** を整理し、Rust Frontend 側で追随するための対応計画を定義する。

## 目的
- 仕様に合わせて Rust Frontend の受理範囲を拡張する。
- 回避したサンプルを正準の表記へ戻す。

## 対象範囲
- 仕様章: `docs/spec/2-1-parser-type.md`
- サンプル: `examples/docs-examples/spec/2-1-parser-type/sec_a.reml` / `sec_c.reml` / `sec_d.reml` / `sec_clilsp.reml`
- 監査ログ: `docs/plans/docs-examples-audit/1-2-spec-sample-fix-targets.md`

## ギャップ一覧（簡略化／回避済み）

### 1. 合成型バリアントのラベル付きフィールド未対応
- 影響: `| Ok(value: T, rest: Input, ...)` のような **ラベル付き引数** が `parser.syntax.expected_tokens` で失敗する。
- 該当サンプル:
  - `examples/docs-examples/spec/2-1-parser-type/sec_a.reml`
- 現状の回避: `| Ok(T, Input, Span, Bool)` の **位置引数** に置換。

### 2. タプル型のラベル付きフィールド未対応
- 影響: `List<(name: String, span: Span)>` のような **ラベル付きタプル** が構文エラーになる。
- 該当サンプル:
  - `examples/docs-examples/spec/2-1-parser-type/sec_c.reml`
- 現状の回避: `List<(String, Span)>` に置換。

### 3. 型定義内のデフォルト値未対応
- 影響: `field: Type = default` の **デフォルト値表記** が構文エラーになる。
- 該当サンプル:
  - `examples/docs-examples/spec/2-1-parser-type/sec_d.reml`
- 現状の回避: デフォルト値を削除し、本文・表で既定値を記述。

### 4. 文字列リテラル型と型の和の未対応
- 影響: `"off" | "on" | "auto"` のような **リテラル型の和** が構文エラーになる。
- 該当サンプル:
  - `examples/docs-examples/spec/2-1-parser-type/sec_d.reml`
- 現状の回避: `left_recursion: Str` とし、許容値をコメントに退避。

### 5. レコードリテラルを関数引数に直接渡す構文の未対応
- 影響: `Any::from(DemandHint{...})` のような **引数位置のレコードリテラル** が構文エラーになる。
- 該当サンプル:
  - `examples/docs-examples/spec/2-1-parser-type/sec_clilsp.reml`
- 現状の回避: `let hint = DemandHint{...}; Any::from(hint)` に分解。

## 実装修正計画（Rust Frontend）

### フェーズ 1: 構文受理（Parser/AST）
進捗: 1)〜5) は実装済み。テストは再実行推奨（前回タイムアウトのため完走未確認）。
1) バリアントのラベル付きフィールド
- 対象: `TypeVariant` の引数パース、型 AST（variant 引数のノード）。
- 実装手順:
  - パーサで `name: Type` を variant 引数として受理（`,` 区切り）。
  - AST に `label: Option<Ident>` を追加し、従来の位置引数と両立させる。
  - 既存の `Ok(T, Input, ...)` 形式はそのまま受理（後方互換）。
- 受理基準: `| Ok(value: T, rest: Input)` がパース可能で、`sec_a.reml` が diagnostics 0 件。

2) タプル型のラベル付きフィールド
- 対象: 型式パーサのタプル分岐、型 AST（tuple element）。
- 実装手順:
  - タプル型要素のパースに `name: Type` を許容。
  - AST に `label: Option<Ident>` を追加し、`(Type, Type)` と併存させる。
- 受理基準: `List<(name: String, span: Span)>` がパース可能。

3) 型定義内のデフォルト値
- 対象: レコード型フィールドの構文、型 AST（record field）。
- 実装手順:
  - `field: Type = Expr` を受理し、`default_expr: Option<Expr>` を保持。
  - `=` の直後は式パーサへ委譲（`{}` ブロック式やリテラル式を許可）。
- 受理基準: `RunConfig` のフィールド既定値が構文エラーにならない。

4) リテラル型と和型
- 対象: 型式パーサ（literal type）、型 AST（type union）。
- 実装手順:
  - 文字列リテラル（`"..."`）を型の一形として導入。
  - `Type | Type` の和型に literal type を混在可能にする。
- 受理基準: `"off" | "on" | "auto"` が型としてパース可能。

5) 引数位置のレコードリテラル
- 対象: 式パーサ（primary expression）、関数呼び出し引数。
- 実装手順:
  - `Type{ ... }` を primary expression として扱う。
  - 既存のブロック式 `{ ... }` と衝突しないよう、先頭トークンが `UpperIdentifier` のときに型リテラルとして分岐。
- 受理基準: `Any::from(DemandHint{ ... })` が単一式としてパース可能。

### フェーズ 2: 解析後の取り扱い（Typer/Lowering）
- 実装方針（暫定）:
  - ラベル付きフィールドは **型推論に影響させない**。AST から Typed AST へラベルを引き継ぎ、診断/IDE 表示にのみ利用。
  - デフォルト値は **評価しない**。Typed AST に保持し、コード生成はスキップ（警告は出さない）。
  - リテラル型は **`Str` 制約の sugar** とみなす。`"off" | "on"` は `Str` と互換扱い。
- 影響範囲:
  - `typeck` で型ラベル・既定式の通過のみ確認（新しい制約は導入しない）。
  - 診断 JSON への追加は行わず、既存スキーマを保持。
- 進捗:
  - `typeck` の通過対応は実装済み。
  - Typed AST に型注釈文字列（引数/戻り値）を保持する処理を追加済み。
  - `--emit-diagnostics` の差分確認済み（`sec_a.reml` / `sec_c.reml` は run_id・パス差分のみ）。
- 実装メモ:
  - Typed AST へ型注釈文字列を保持（関数引数・戻り値の annotation を追加）。
  - 非 NFC 識別子は仕様どおりエラー扱い（テスト更新で整合済み）。
- 受け入れ基準:
  - フェーズ 1 の構文追加が `typeck` で落ちないこと。
  - 既存の `--emit-diagnostics` 出力が変化しないこと（差分が必要な場合は別途計画化）。

### フェーズ 3: サンプル復元と再検証
- 復元対象:
  - `docs/spec/2-1-parser-type.md` の A/C/D 節のコードブロック。
  - `examples/docs-examples/spec/2-1-parser-type/sec_a.reml` / `sec_c.reml` / `sec_d.reml` / `sec_clilsp.reml`。
- 復元手順:
  - `sec_a.reml`: `Ok(value: T, rest: Input, ...)` 形式へ戻す。
  - `sec_c.reml`: `List<(name: String, span: Span)>` 形式へ戻す。
  - `sec_d.reml`: デフォルト値と `"off" | "on" | "auto"` を元に戻す。
  - `sec_clilsp.reml`: `Any::from(DemandHint{...})` を再度 inline する。
- 検証:
  - `compiler/frontend/target/debug/reml_frontend examples/docs-examples/spec/2-1-parser-type/sec_*.reml` を再実行し、diagnostics 0 件を確認。
  - `docs/plans/docs-examples-audit/1-2-spec-sample-fix-targets.md` の該当行を `done` のまま維持。
  - `reports/spec-audit/summary.md` と `reports/spec-audit/ch2/docs-examples-fix-notes-YYYYMMDD.md` に実行記録を追記。

## 進捗管理
- 本計画書作成日: 2025-12-24
- 進捗欄（運用用）:
- [x] フェーズ 1 完了（Parser/AST 実装済み）
- [x] フェーズ 2 完了（typeck 通過 + 診断出力差分確認済み）
- [x] フェーズ 3 完了（サンプル復元・再検証を実施）
- [x] 試験: `ascii_profile_reports_unicode_rejection` の無限ループ修正と単体再実行済み

## 作業ログ
- 2025-12-26: フェーズ 3 の再検証を実施し、`sec_*` の diagnostics 0 件を確認。
- 2025-12-26: Unicode 識別子の受理拡張（emoji/ZWJ/bidi を字句で取り込み）と仕様更新を実施し、`lexer_unicode_identifier` が pass。

## 関連リンク
- `docs/spec/2-1-parser-type.md`
- `docs/plans/docs-examples-audit/1-2-spec-sample-fix-plan.md`
- `docs/plans/docs-examples-audit/1-2-spec-sample-fix-targets.md`
