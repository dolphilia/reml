# 1.2 実装ギャップ対応計画（Rust Frontend / 2025-12-29）

`docs/spec/3-5-core-io-path.md` のサンプル修正で判明した **識別子の予約語扱い** によるギャップを整理し、Rust Frontend 側の対応計画をまとめる。

## 目的
- 仕様に合わせて `operation` / `pattern` を識別子として受理できるようにする。
- フォールバックで避けた名称を正準例へ戻す。

## 対象範囲
- 仕様章: `docs/spec/3-5-core-io-path.md`
- サンプル:
  - `examples/docs-examples/spec/3-5-core-io-path/sec_2-b.reml`
  - `examples/docs-examples/spec/3-5-core-io-path/sec_4.reml`
  - `examples/docs-examples/spec/3-5-core-io-path/sec_8_2.reml`

## ギャップ一覧（名称回避済み）

### 1. `operation` が識別子として使えない
- 影響: レコードフィールドやパラメータ名で `parser.syntax.expected_tokens` が発生する。
- 該当サンプル:
  - `examples/docs-examples/spec/3-5-core-io-path/sec_2-b.reml`（`operation_name` に変更）
  - `examples/docs-examples/spec/3-5-core-io-path/sec_8_2.reml`（`op` / `ops` に変更）
- 現状の回避: `operation_name` / `op` / `ops` へリネーム。

### 2. `pattern` が識別子として使えない
- 影響: パラメータ名で `parser.syntax.expected_tokens` が発生する。
- 該当サンプル:
  - `examples/docs-examples/spec/3-5-core-io-path/sec_4.reml`（`pat` に変更）
- 現状の回避: `pat` へリネーム。

## 実装修正計画（Rust Frontend）

### フェーズ 1: 予約語の扱い見直し
1) 予約語の定義箇所を特定する
- `compiler/frontend` でキーワード一覧・トークン定義・識別子判定の実装位置を洗い出す。
- `operation` / `pattern` がどの段階（レキサ・パーサ・構文解析補助）で予約語扱いされているかを記録する。

2) 文脈キーワード化の設計を決める
- `operation` / `pattern` を「構文上の予約位置のみ有効」に限定し、通常の識別子位置では許可する方針を明文化する。
- 許容する識別子位置を具体化する（フィールド名 / 変数名 / パラメータ名 / 型引数名 / レコードキー）。
- 既存構文で `operation` / `pattern` が使われる箇所を列挙し、当該箇所のみキーワード判定を残す。

3) レキサの振る舞いを調整する
- キーワードの自動変換を行っている場合は、`operation` / `pattern` を除外するか、文脈判定に委譲する。
- 影響範囲（トークン種別の変更、予約語表の更新、識別子正規化処理）を記録する。

4) パーサ側の受理条件を更新する
- 構文位置ごとの「キーワード必須」判定を見直し、対象構文でのみ `operation` / `pattern` をキーワードとして扱う。
- 既存の識別子受理ロジックに副作用が出ないことを確認する（他の予約語・文脈キーワードの扱いを含む）。

5) 診断とエラーハンドリングの調整
- 失敗時に `parser.syntax.expected_tokens` を出している箇所を特定し、文脈キーワード化後のエラー回復を確認する。
- 期待トークンの候補に `operation` / `pattern` が誤って出ないかを検査する。

### フェーズ 2: サンプルと仕様の復元
1) サンプルの正準例復元
- `sec_2-b.reml`: `operation_name` を `operation` に戻す。
- `sec_4.reml`: `pat` を `pattern` に戻す。
- `sec_8_2.reml`: `op` / `ops` を `operation` / `operations` に戻す。

2) 検証
- `compiler/frontend/target/debug/reml_frontend --output json <sample>` を再実行し、診断 0 件を確認する。
- レキサ・パーサの変更が他のサンプルに波及していないか、必要に応じて `examples/docs-examples/spec/3-5-core-io-path/` 全体を確認する。
- `docs/plans/docs-examples-audit/1-2-spec-sample-fix-targets.md` の備考に実装対応完了を記録する。

## 進捗管理
- 本計画書作成日: 2025-12-29
- 進捗欄（運用用）:
  - [ ] フェーズ 1 完了
  - [ ] フェーズ 2 完了

## 関連リンク
- `docs/spec/3-5-core-io-path.md`
- `docs/plans/docs-examples-audit/1-2-spec-sample-fix-plan.md`
