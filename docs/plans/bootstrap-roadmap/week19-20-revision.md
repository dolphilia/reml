# Week 19-20 実装計画の修正

## 背景

Phase 2 Week 19-20 で「制約収集の型推論統合完成」と「辞書生成パスの実装」を目標としていましたが、以下の問題が判明しました：

1. **型推論結果の変更範囲が広大**: `infer_result` 型に制約リストを追加すると、100箇所以上のパターンマッチと関数呼び出しの修正が必要
2. **既存テストへの影響**: 182件のコンパイラテスト全体に影響し、回帰リスクが高い
3. **時間制約**: Week 19-20 の期間で完全な統合は困難

## 修正された実装計画（Week 19-20）

### 優先度 High: インフラ準備と文書化

#### タスク1: 制約収集の設計文書化
- 二項演算子で生成すべきトレイト制約を明示（コメント形式）
- `Add`, `Sub`, `Mul`, `Eq`, `Ord` 等の演算子 → トレイト制約のマッピング
- 変更ファイル: `type_inference.ml` の `infer_binary_op` 関数

#### タスク2: 統合ポイントの明確化
- `Constraint_solver.solve_constraints` の呼び出しタイミングを設計
- 関数宣言の `generalize` 時に制約を含める方法を文書化
- 変更ファイル: `type_inference.ml` の `infer_decl` 関数周辺

#### タスク3: 辞書生成パスの基盤整備
- Core IR の辞書ノード（`DictConstruct`, `DictMethodCall`）の使用例をコメント追加
- `desugar.ml` での辞書生成ロジックの設計コメント追加
- LLVM CodeGen との接続ポイント明示

### 優先度 Medium: 小規模な実装

#### タスク4: 制約収集ヘルパー関数の追加
- `collect_trait_constraint` 関数を新規追加（未使用だが将来の統合準備）
- 演算子からトレイト名へのマッピング関数
- 変更ファイル: `type_inference.ml`

#### タスク5: テストケースの準備
- Week 21-22 での統合に備えたテストケースを作成
- 制約収集が必要なパターンを列挙
- 変更ファイル: `tests/test_constraint_integration.ml` (新規)

## Week 21-22 への引き継ぎ

Week 19-20 で整備したインフラと文書を基に、Week 21-22 で以下を実施：

1. **本格的な制約収集統合**
   - `infer_result` 型の拡張または代替アプローチの採用
   - 全 `infer_expr` 呼び出しの更新
   - 既存テストの修正

2. **辞書生成パスの実装**
   - `desugar.ml` での辞書ノード生成
   - 辞書引数の自動挿入

3. **LLVM IR への lowering**
   - `codegen.ml` での辞書構造体対応

## 成功基準（Week 19-20）

- ✅ 制約収集の設計が文書化され、コードコメントとして記録されている
- ✅ `Constraint_solver` との統合ポイントが明確化されている
- ✅ 辞書生成パスの設計コメントが追加されている
- ✅ Week 21-22 へのスムーズな引き継ぎが可能

## リスク軽減

この修正により：
- 既存テスト（182件）への影響を最小化
- 段階的な実装による回帰リスク低減
- Week 21-22 での集中的な実装に向けた準備完了
