# 1.1 Parser 実装詳細計画

## 目的
- Phase 1 のマイルストーン M1 を達成できるよう、`1-1-syntax.md` の式・宣言構文を全て OCaml 製パーサで扱える状態にする。
- `2-0-parser-api-overview.md` が定義する `Parser<T>` 契約を OCaml の抽象データ型で写像し、後続フェーズで Reml 実装へ移植しやすい構造を確立する。
- エラーレポート用の Span 情報を AST に格納し、`2-5-error.md` の診断モデルと整合を取る。

## スコープ
- **含む**: 字句解析・構文解析の OCaml 実装、Menhir 等のパーサジェネレータ設定、AST 生成、Span 付与、演算子優先順位テーブル（固定版）。
- **含まない**: DSL 用構文拡張、ユーザー定義演算子テーブル、パーサと連動する型解決。これらは Phase 2 以降で実装する。
- **前提**: LLVM toolchain セットアップ、Menhir または ocamlyacc のビルド環境、既存サンプル（`examples/language-impl-comparison/`）。

## 作業ブレークダウン

### 1. 文法資産の抽出と設計（1週目）
**担当領域**: 構文仕様の形式化

1.1. **構文要素の棚卸し**
- `1-1-syntax.md` から式・宣言・パターン・型注釈・モジュールヘッダの全構文要素をリスト化
- 優先順位テーブル（`precedence` 宣言）を抽出し、固定演算子リストを作成
- 予約語・演算子トークン一覧を UTF-8/XID 前提で網羅し、Unicode 識別子ルールを `1-1-syntax.md` A.3 に沿って整理
- 宣言カテゴリ（`let`/`fn`/`type`/`trait`/`impl`/`extern`/`effect`/`handler`/`module` 等）と DSL 属性の AST への写像を確認

1.2. **AST ノード設計**
- 式ノード: `Expr::Literal | Call | Lambda | Match | Pipe | ModulePath | ...`
- 宣言ノード: `Decl::Let | Fn | Type | Trait | Impl | Extern | Effect | Handler | Module | Use | Precedence | Attribute | ...`
- パターンノード: `Pattern::Var | Tuple | Record | Enum | Wildcard | Rest | ...`
- 各ノードに `Span { start: usize, end: usize }` を付与し、属性・効果注釈を保持するメタデータ領域を確保

1.3. **文法ドラフト作成**
- Menhir用 `.mly` ファイルのスケルトンを作成
- 字句解析用 `.mll` ファイルのトークン定義を作成
- OCamlの型定義 `ast.ml` を作成

**成果物**: `parser/ast.ml`, `parser/parser.mly`, `parser/lexer.mll` のドラフト版

### 2. Lexer 実装（1-2週目）
**担当領域**: 字句解析

2.1. **基本トークン実装**
- 識別子: Unicode `XID_Start` + `XID_Continue*`（`1-1-syntax.md` A.3 に準拠）
- 数値リテラル: 整数、浮動小数点、2/8/16 進数、下線区切り
- 文字列リテラル: エスケープシーケンス処理、生文字列、複数行文字列
- コメント: 行コメント `//`、ブロックコメント `/* */`（入れ子対応）
- 文字リテラル・ブール値・タプル/配列表現などのリテラル種別

2.2. **空白処理とレイアウト**
- 空白・タブ・改行の扱いと文末候補（`1-1-syntax.md` B.3）
- 位置情報（行番号、列番号）の追跡
- Unicode 正規化や BOM 有無の確認

2.3. **エラーハンドリング**
- 不正文字の検出とレポート
- 未終了文字列・コメントのエラー生成
- Span情報付きエラーメッセージ

**成果物**: `lexer.mll` 完成版、字句解析テスト

### 3. Parser 実装（2-3週目）
**担当領域**: 構文解析

3.1. **式パーサ実装**
- 演算子優先順位の実装（固定テーブルを使用）
- パイプ演算子 `|>` の左結合処理
- 関数適用・ラムダ式・条件式
- パターンマッチ式 `match`

3.2. **宣言パーサ実装**
- `let`/`var` 束縛宣言
- 関数宣言 `fn`
- 型定義 `type`（ADT/alias/newtype）
- トレイト宣言 `trait` と `impl`
- モジュール `module` ヘッダと `use` 宣言
- `extern` 宣言と効果宣言 (`effect`/`handler`)
- DSL 属性（`@dsl_export`, `@requires_capability` 等）の付与

3.3. **型注釈パーサ**
- 基本型: `i32`, `f64`, `bool`, `string`
- 複合型: タプル、レコード、関数型 `A -> B`
- ジェネリック型パラメータ `<T>`

**成果物**: `parser.mly` 完成版、構文解析テスト

### 4. AST と Span 統合（3週目）
**担当領域**: AST構築とメタデータ

4.1. **Span情報の付与**
- 全ASTノードに開始・終了位置を記録
- ファイル名・ソースコードへの参照を保持
- ネストした式での位置情報の正確な計算

4.2. **ASTビルダー実装**
- パーサアクションからASTノードを構築
- 型安全なビルダーパターンの適用
- デバッグ用のAST pretty printer

4.3. **診断情報の準備**
- エラー位置の正確な特定機能
- 期待トークン情報の収集
- `2-5-error.md` のフォーマットとの整合

**成果物**: Span統合版AST、`--emit-ast` CLI機能

### 5. パーサジェネレータ統合とビルド（3-4週目）
**担当領域**: ビルドシステム

5.1. **Dune統合**
- `dune` ファイルの作成と Menhir ルール定義
- OCaml依存関係の管理
- 差分ビルドの最適化

5.2. **CI/CD整備**
- GitHub Actions での自動ビルド設定
- Menhir/OCamlコンパイラのバージョン固定
- ビルド成果物のアーティファクト保存

5.3. **依存関係管理**
- `opam` パッケージ定義の作成
- バージョン制約の明示（Menhir >= 20201216）
- ドキュメントへのバージョン情報記録

**成果物**: 完全なビルドシステム、CI設定

### 6. エラー回復戦略（4週目）
**担当領域**: 診断とエラー処理

6.1. **エラー回復ポイント定義**
- セミコロン欠落時の自動挿入判定
- 括弧不一致の検出と提案
- 予期しないトークンでの同期ポイント

6.2. **期待値提示**
- `2-5-error.md` に従った期待トークン集合の構築
- コンテキスト依存の提案メッセージ
- 複数候補がある場合のランク付け

6.3. **診断メッセージ生成**
- Span情報を使った正確な位置表示
- ソースコードスニペットの抽出
- カラー出力対応（オプション）

**成果物**: エラー回復機能、診断メッセージシステム

### 7. テスト整備とゴールデンテスト（4週目）
**担当領域**: 品質保証

7.1. **ユニットテスト作成**
- 字句解析の境界ケーステスト
- 構文解析の成功/失敗ケース
- エラー回復の動作検証

7.2. **ゴールデンテスト実装**
- `examples/language-impl-comparison/` のサンプルを使用
- AST出力のスナップショット保存
- 差分検出の自動化（`dune runtest`）

7.3. **性能計測**
- 10MBソースのパース時間測定
- メモリ使用量のプロファイリング
- `0-3-audit-and-metrics.md` への記録

**成果物**: 完全なテストスイート、性能ベースライン

### 8. ドキュメント整備とレビュー準備（4週目）
**担当領域**: ドキュメント

8.1. **技術文書更新**
- 構文表・優先順位表の `1-0-phase1-bootstrap.md` への追加
- AST設計の詳細を `docs/notes/` に記録
- エラー回復戦略の文書化

8.2. **メトリクス記録**
- パース時間・メモリ使用量を `0-3-audit-and-metrics.md` に記録
- テストカバレッジの報告
- 既知の制限事項・TODOリストの明示

8.3. **レビュー資料作成**
- M1マイルストーン達成報告書
- AST/診断のサンプル出力
- 次フェーズへの引き継ぎ事項

**成果物**: 完全なドキュメント、レビュー資料

## 成果物と検証
- `parser/` ディレクトリ（仮）に OCaml 実装を配置し、CI で `dune build parser` が通ること。
- AST ゴールデンテストと診断サンプルテストを GitHub Actions x86_64 Linux ランナーで実行し、失敗時に差分を表示する仕組みを導入。
- Span 情報を含む AST ダンプ (`--emit-ast`) を CLI で出力できるようにする。

## リスクとフォローアップ
- Menhir の依存が開発者環境ごとにばらつくリスクがあるため、`0-3-audit-and-metrics.md` に必要なバージョン固定情報を記録。
- 演算子優先順位の固定テーブルが Phase 2 で拡張される見込みなので、テーブル定義を外部 JSON/再読込可能な形式に切り出し、後続フェーズで差し替えやすくしておく。
- ストリーミングパーサ API (`2-7-core-parse-streaming.md`) との整合は Phase 3 で必須となるため、現段階で AST 生成を純粋関数化し副作用を最小限にする。

## 参考資料
- [1-0-phase1-bootstrap.md](1-0-phase1-bootstrap.md)
- [1-1-syntax.md](../../spec/1-1-syntax.md)
- [2-0-parser-api-overview.md](../../spec/2-0-parser-api-overview.md)
- [2-5-error.md](../../spec/2-5-error.md)
- [guides/llvm-integration-notes.md](../../guides/llvm-integration-notes.md)
