# 4.2 マルチターゲットリリースパイプライン計画

## 目的
- Phase 4 マイルストーン M2 に合わせ、Linux/Windows/macOS 向けの自動ビルド・テスト・署名・配布パイプラインを構築し、正式リリースを支える。
- [4-3-developer-toolchain.md](../../spec/4-3-developer-toolchain.md) の手順を具体化し、リリースノートと成果物の配布を標準化する。

## スコープ
- **含む**: CI/CD 構成、成果物署名、圧縮形式統一、配布ポータル更新、ログ記録。
- **含まない**: 新規ターゲット追加、商用配布インフラ。必要な場合は別計画。
- **前提**: セルフホストビルドが安定し、主要ターゲットの成果物が生成できる。

## 作業ブレークダウン

### 1. リリースフロー設計（75-76週目）
**担当領域**: プロセス設計

1.1. **リリースフロー全体設計**
- ビルド → テスト → 署名 → パッケージング → 配布の5段階フロー定義
- ターゲット別の並行処理戦略（Linux/Windows/macOS同時ビルド）
- 失敗時のロールバック手順とフォールバック戦略
- リリース承認プロセスの定義（手動ゲート vs 自動リリース）

1.2. **バージョニング戦略**
- セマンティックバージョニング（SemVer）の採用確認
- Git タグとリリースバージョンの紐付けルール
- ビルドメタデータの埋め込み（commit hash、ビルド日時）
- プレリリース版の命名規則（alpha、beta、rc）

1.3. **成果物仕様の策定**
- アーカイブ形式の統一（`.tar.gz` for Linux/macOS、`.zip` for Windows）
- ファイル構成テンプレート（`bin/`、`lib/`、`doc/`、`README.md`）
- ターゲット別のファイル命名規則（`remlc-{version}-{target}.{ext}`）
- チェックサム形式の選定（SHA256）

1.4. **ステークホルダーレビュー**
- リリースフロー案の作成と共有
- チーム内レビューと承認
- ドキュメント化（フローチャート、手順書）
- Phase 4-1（互換性検証）との連携確認

**成果物**: リリースフロー設計書、バージョニング仕様、成果物仕様、承認記録

### 2. CI/CD ワークフロー実装（76-77週目）
**担当領域**: 自動化インフラ

2.1. **GitHub Actions ワークフローの基盤構築**
- リリース用ワークフロー定義（`.github/workflows/release.yml`）
- トリガー条件の設定（タグプッシュ: `v*.*.*`）
- マトリクス戦略の実装（3ターゲット並行ビルド）
- シークレット管理（署名鍵、証明書の安全な保管）

2.2. **ビルドジョブの実装**
- Phase 3 計画（[3-0-phase3-self-host.md](3-0-phase3-self-host.md)）で整備したセルフホストビルドスクリプトの統合
- ターゲット別環境セットアップ（Ubuntu/Windows/macOS ランナー）
- 依存関係のキャッシュ戦略（LLVM、Rust toolchain、標準ライブラリ）
- ビルド成果物のアーティファクトとしての保存

2.3. **テストジョブの実装**
- ビルド直後の自動テスト実行
- スモークテスト（Hello World、基本機能）
- 統合テスト（標準ライブラリ、サンプルコード）
- テスト失敗時のビルド停止とログ収集

2.4. **CI/CD デバッグと最適化**
- ローカル環境でのワークフローテスト（act 等のツール活用）
- 並行実行の最適化（ターゲット間の依存関係最小化）
- タイムアウト設定とリトライ戦略
- ログ出力の最適化（重要情報のハイライト）

**成果物**: GitHub Actions ワークフロー、ビルド/テストジョブ、デバッグログ

### 3. 署名インフラ整備（77-78週目）
**担当領域**: セキュリティとコード署名

3.1. **Linux 署名（GPG）**
- GPG キーペアの生成と管理
- 署名スクリプトの作成（`.tar.gz` と `.asc` の生成）
- GitHub Secrets への秘密鍵の安全な保存
- CI での自動署名フローの実装（`gpg --detach-sign`）

3.2. **Windows 署名（Authenticode）**
- コードサイニング証明書の取得（認証局からの購入）
- 証明書の GitHub Secrets への保存（PFX 形式）
- SignTool.exe を使った署名スクリプト作成
- Windows ランナーでの署名自動化

3.3. **macOS 署名と Notarization**
- Developer ID Application 証明書の取得
- `codesign` による署名スクリプト作成
- Apple Notarization の自動化（`notarytool submit`）
- Notarization 完了待ちとステータス確認の実装

3.4. **署名検証手順の整備**
- ユーザー向け署名検証ガイドの作成
- GPG 公開鍵の公開（GitHub、キーサーバー）
- Windows/macOS での検証手順（GUI/CLI 両方）
- CI での署名検証テスト（署名後の自動検証）

**成果物**: 署名スクリプト群、署名済み成果物、検証ガイド、公開鍵

### 4. 成果物パッケージング（78-79週目）
**担当領域**: アーカイブ作成

4.1. **ターゲット別ディレクトリ構成**
- 標準ディレクトリレイアウトの定義
- `bin/`: コンパイラバイナリ（`remlc`、`reml`）
- `lib/`: 標準ライブラリ、ランタイムライブラリ
- `doc/`: ライセンス、README、インストールガイド

4.2. **ターゲット別 README の作成**
- インストール手順（OS 別）
- 環境変数設定（PATH、REML_HOME 等）
- 動作確認コマンド（`remlc --version`、Hello World）
- トラブルシューティング（よくある問題と解決策）

4.3. **アーカイブ作成スクリプト**
- Linux/macOS: `tar czf` によるアーカイブ作成
- Windows: `7z` または PowerShell による ZIP 作成
- パーミッション設定（実行権限の保持）
- アーカイブ内パス構造の検証

4.4. **チェックサム生成**
- SHA256 チェックサム生成（全アーカイブ）
- チェックサムファイルの作成（`SHA256SUMS`）
- 署名付きチェックサム（GPG 署名）
- 検証スクリプトの提供（`sha256sum -c` 等）

**成果物**: パッケージング済みアーカイブ、ターゲット別 README、チェックサムファイル

### 5. 配布チャネル更新（79-80週目）
**担当領域**: リリース配布

5.1. **GitHub Releases の更新**
- リリースページの自動作成（GitHub API 活用）
- アーティファクトのアップロード（アーカイブ、署名、チェックサム）
- リリースノートの自動生成（6. で作成）
- プレリリース/正式版のマーキング

5.2. **配布サイトの更新**
- [4-2-registry-distribution.md](../../spec/4-2-registry-distribution.md) に基づくレジストリ更新
- ダウンロードページの HTML/Markdown 更新
- ダイレクトリンクの提供（最新版、特定バージョン）
- ダウンロード統計の設定（GitHub Insights 活用）

5.3. **パッケージマネージャー対応**
- Linux: apt/yum リポジトリ準備（将来対応）
- macOS: Homebrew Tap 作成（オプション）
- Windows: Chocolatey/Scoop 対応検討（オプション）
- 現時点では手動インストール優先、Phase 4 以降で検討

5.4. **ミラー・CDN 設定**
- GitHub Releases をプライマリ配布先として活用
- 必要に応じてミラーサイトの検討
- CDN 活用による高速ダウンロード（将来対応）
- 配布ログの監視（アクセス統計）

**成果物**: GitHub Releases 更新、配布サイト更新、ダウンロードリンク集

### 6. リリースノート作成（80-81週目）
**担当領域**: ドキュメント生成

6.1. **リリースノートテンプレート作成**
- [4-5-roadmap-metrics.md](../../spec/4-5-roadmap-metrics.md) に基づくテンプレート定義
- セクション構成: サマリ、新機能、修正、既知の問題、移行ガイド
- Markdown 形式での標準化
- バージョン情報の自動埋め込み

6.2. **変更履歴の収集**
- Git コミット履歴からの自動抽出
- コミットメッセージの分類（feat/fix/docs/refactor）
- プルリクエストタイトルの活用
- 手動でのハイライト追加（重要な変更）

6.3. **リリースノートの自動生成**
- 変更履歴をテンプレートに適用
- 自動分類とグルーピング（機能別、コンポーネント別）
- リンク生成（PR 番号、Issue 番号）
- 最終レビューと手動調整

6.4. **多言語対応の検討**
- 日本語版リリースノートの作成（主要言語）
- 英語版の提供（国際対応）
- 翻訳フローの確立（将来対応）
- 現時点では日本語優先

**成果物**: リリースノートテンプレート、自動生成スクリプト、リリースノート（日本語版）

### 7. 検証とテスト（81-82週目）
**担当領域**: 品質保証

7.1. **エンドツーエンドテスト**
- リリースパイプライン全体の実行テスト
- テスト環境でのリリース実行（タグ: `v0.9.0-rc1` 等）
- 全ターゲットでのアーティファクト生成確認
- 署名・チェックサムの検証

7.2. **ダウンロード・インストール検証**
- 各ターゲットでのダウンロードテスト
- アーカイブ展開とファイル構成確認
- インストール手順の実行（README 記載内容）
- 動作確認（Hello World、基本機能）

7.3. **署名検証テスト**
- GPG 署名検証（Linux）
- Authenticode 署名検証（Windows）
- Notarization 検証（macOS）
- 検証手順書との整合確認

7.4. **ロールバックテスト**
- リリース失敗時のロールバック手順確認
- アーティファクト削除とクリーンアップ
- リトライ処理のテスト
- エラー通知の動作確認

**成果物**: 検証レポート、テストログ、修正事項リスト

### 8. 本番リリース実行とドキュメント化（82-83週目）
**担当領域**: 運用と記録

8.1. **本番リリース準備**
- 最終レビュー（コード、ドキュメント、成果物）
- チェックリストの確認（4-5 の後方互換チェックリストと連携）
- リリース承認の取得
- リリース日時の決定とアナウンス

8.2. **本番リリース実行**
- Git タグのプッシュ（`v1.0.0` 等）
- CI/CD パイプラインの自動実行
- リリース進行の監視（GitHub Actions ダッシュボード）
- 問題発生時の即座対応

8.3. **リリース後検証**
- 配布サイトの確認（リンク、ダウンロード可能性）
- 署名検証の再確認
- コミュニティへの告知（4-3、4-4 と連携）
- 初期フィードバックの収集

8.4. **ドキュメント化と監査記録**
- リリースプロセスの記録（実行ログ、タイムライン）
- `docs/guides/tooling/audit-metrics.md` への記録（署名情報、チェックサム、配布URL）
- 問題点と改善事項の記録（`0-4-risk-handling.md`）
- 次回リリースへの改善提案

**成果物**: 本番リリース成果物、リリース記録、監査ログ、改善提案

## 成果物と検証
- 3 ターゲット全てのアーティファクトが自動生成され、署名検証が通る。
- 配布ページが更新され、ユーザーがダウンロード・検証できる。
- CI/CD ログが保存され、再現手順がドキュメント化される。
- リリースプロセスが `docs/guides/tooling/audit-metrics.md` に記録される。

## リスクとフォローアップ
- 署名用証明書の更新・管理がリスクとなるため、キーローテーション手順をドキュメント化。
- Notarization など外部サービスの障害に備え、リトライ戦略と SLA を `0-4-risk-handling.md` に明記。
- 成果物サイズが増大する場合、圧縮や不要ファイル除外を検討。
- CI/CD パイプラインの複雑性が増すため、定期的なメンテナンスとドキュメント更新を計画。
- 署名鍵の漏洩リスクに備え、緊急対応手順（鍵の失効、再発行）を `0-4-risk-handling.md` に記録。

## 参考資料
- [4-0-phase4-migration.md](4-0-phase4-migration.md)
- [6-1-multitarget-compatibility-verification.md](6-1-multitarget-compatibility-verification.md)
- [3-0-phase3-self-host.md](3-0-phase3-self-host.md)
- [4-3-developer-toolchain.md](../../spec/4-3-developer-toolchain.md)
- [4-2-registry-distribution.md](../../spec/4-2-registry-distribution.md)
- [4-5-roadmap-metrics.md](../../spec/4-5-roadmap-metrics.md)
- [docs/guides/tooling/audit-metrics.md](../guides/tooling/audit-metrics.md)
- [0-4-risk-handling.md](0-4-risk-handling.md)
