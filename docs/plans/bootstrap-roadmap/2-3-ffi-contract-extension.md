# 2.3 FFI 契約拡張計画

## 目的
- Phase 2 で `3-9-core-async-ffi-unsafe.md` に定義された ABI/所有権契約を OCaml 実装へ反映し、x86_64 Linux (System V) と Windows x64 (MSVC) の両方でブリッジコードを検証する。
- `AuditEnvelope` に FFI 呼び出しのメタデータを記録し、診断と監査の一貫性を確保する。

## スコープ
- **含む**: FFI 宣言構文の Parser 拡張、Typer による ABI/所有権チェック、ブリッジコード生成、プラットフォーム別ビルド、監査ログ拡張。
- **含まない**: 非同期ランタイム実装の刷新、プラグイン経由の FFI 自動生成。これらは Phase 3 以降。
- **前提**: Phase 1 のランタイム連携が完成し、Phase 2 の効果システム統合と衝突しない設計であること。

## 作業ブレークダウン

### 1. ABI モデル設計と仕様整理（29-30週目）
**担当領域**: FFI 基盤設計

1.1. **ABI 仕様の抽出**
- `3-9-core-async-ffi-unsafe.md` の ABI テーブルを OCaml データ型に写像
- System V ABI (x86_64 Linux) と MSVC ABI (x86_64 Windows) の差分整理
- 呼出規約（calling convention）の形式化
- 構造体レイアウト・アライメントルールの定義

1.2. **所有権契約の設計**
- `docs/notes/llvm-spec-status-survey.md` §2.4 の RC 契約を OCaml データ構造化（`Ownership::Transferred`/`Borrowed` 等）
- FFI 境界での所有権移転ルール
- メモリ安全性の検証ポリシー
- `effect {ffi}`/`effect {unsafe}` 境界との連携

1.3. **ターゲット設定システム**
- ターゲット別の ABI 設定テーブル
- コンパイル時のターゲット切替ロジック
- `--target` フラグの処理
- Phase 2 型クラス・効果との統合方針

**成果物**: ABI データモデル、所有権設計、ターゲット設定

### 2. Parser/AST 拡張（30週目）
**担当領域**: FFI 構文解析

2.1. **FFI 宣言構文の実装**
- `extern "C"` ヘッダおよび複数宣言ブロックの構文（1-1 §B.4）
- ライブラリ指定や名前マングリングのオプションを既存仕様の拡張ポイント（コメント/属性）として扱い、新構文を導入しない
- 所有権契約はシグネチャ付随メタデータとして格納（構文レイヤでは属性追加を行わない）

2.2. **AST ノード拡張**
- `Decl::Extern` ノードの追加
- ターゲットトリプル/呼出規約/所有権メタデータを保持するフィールド
- Span 情報の保持
- デバッグ用の AST pretty printer 更新

2.3. **パーサテスト整備**
- FFI 宣言の正常系テスト
- ABI/所有権注釈のエラーケース
- ゴールデンテスト（AST 出力）
- Phase 1 パーサとの統合検証

**成果物**: 拡張 Parser、FFI AST、パーサテスト

### 3. Typer 統合と ABI 検証（30-31週目）
**担当領域**: 型検証と整合性チェック

3.1. **FFI 型の検証**
- FFI 境界で許可される型のホワイトリスト
- ポインタ型・参照型の検証
- 構造体レイアウトの互換性チェック
- 型サイズ・アライメントの計算

3.2. **所有権注釈の検証**
- 所有権の整合性チェック
- Unsafe ブロックの必要性判定
- 所有権違反の検出とエラー報告
- 借用規則の FFI への適用

3.3. **ABI 整合性チェック**
- ターゲット別の ABI ルール適用
- 呼出規約の検証
- 名前マングリングの生成
- Phase 2 効果システムとの連携（`effect {ffi}`, `effect {unsafe}` による契約確認）

**成果物**: FFI 型検証、所有権チェック、ABI 検証

### 4. ブリッジコード生成（31-32週目）
**担当領域**: コード生成

4.1. **Stub 生成ロジック**
- ターゲット別の stub テンプレート
- 引数マーシャリング（Reml 型 → C 型）
- 戻り値マーシャリング（C 型 → Reml 型）
- エラーハンドリング（NULL チェック等）

4.2. **LLVM IR への lowering**
- FFI 関数宣言の LLVM IR 生成
- 呼出規約の LLVM 属性への変換
- 構造体レイアウトの LLVM 型への写像
- デバッグ情報の保持

4.3. **C ヘッダ生成の検討**
- `cbindgen` 等のツール調査
- Reml 型から C ヘッダへの自動生成
- ライセンス・再現性の確認
- Phase 3 での本格導入の方針決定

**成果物**: Stub 生成、LLVM lowering、ヘッダ生成調査

### 5. 監査ログ統合（32週目）
**担当領域**: 診断と監査

5.1. **FFI メタデータの記録**
- `AuditEnvelope.metadata` に `bridge.stage.*` を追加
- ABI 種別・所有権注釈の記録
- FFI 呼び出しのトレース情報
- Phase 2 診断タスクとの連携

5.2. **診断メッセージの実装**
- FFI 型エラーの詳細メッセージ
- 所有権違反の説明と修正提案
- ABI ミスマッチの検出とレポート
- `3-6-core-diagnostics-audit.md` との整合

5.3. **監査ログの出力**
- `--emit-audit` での FFI 情報出力
- JSON スキーマの定義
- CI でのスキーマ検証
- `0-3-audit-and-metrics.md` への記録

**成果物**: FFI 監査ログ、診断メッセージ、スキーマ

### 6. プラットフォーム別テスト（32-33週目）
**担当領域**: クロスプラットフォーム検証

6.1. **Linux x86_64 テスト**
- System V ABI のサンプル FFI 呼び出し
- libc 関数の呼び出しテスト（`printf`, `malloc` 等）
- 構造体渡し・戻りのテスト
- 所有権注釈の検証テスト

6.2. **Windows x64 テスト**
- MSVC ABI のサンプル FFI 呼び出し
- Windows API の呼び出しテスト（`MessageBoxW` 等）
- ABI 差分の動作検証
- Phase 2 Windows タスクとの連携

6.3. **CI/CD 統合**
- GitHub Actions に FFI テストジョブ追加
- Linux/Windows 両方でのテスト実行
- テストカバレッジの計測（>75%）
- ビルド時間の監視

**成果物**: プラットフォーム別テスト、CI 設定

### 7. ランタイム連携とテスト（33週目）
**担当領域**: ランタイム統合

7.1. **ランタイム C コードの拡張**
- FFI ヘルパー関数の実装
- メモリ管理の FFI 対応
- エラーハンドリングの統一
- Phase 1 ランタイムとの統合

7.2. **統合テスト**
- Reml → FFI → C → Reml のラウンドトリップ
- 複雑な構造体の受け渡し
- コールバック関数の検証
- メモリリークの検出（valgrind）

7.3. **性能計測**
- FFI 呼び出しのオーバーヘッド測定
- マーシャリングコストの評価
- `0-3-audit-and-metrics.md` への記録
- 最適化機会の特定

**成果物**: ランタイム拡張、統合テスト、性能計測

### 8. ドキュメント更新と引き継ぎ（33-34週目）
**担当領域**: 仕様整合と引き継ぎ

8.1. **仕様書フィードバック**
- `3-9-core-async-ffi-unsafe.md` への実装差分の反映
- ABI 差分の詳細化
- 所有権契約の擬似コードを追加
- 新規サンプルコードの追加

8.2. **ガイド更新**
- `docs/guides/runtime-bridges.md` の FFI セクション更新
- プラットフォーム別の注意事項を追記
- cbindgen 等のツール使用例
- トラブルシューティング情報

8.3. **Phase 3 準備**
- FFI のセルフホスト移植計画
- 残存課題の `docs/notes/` への記録
- 非同期 FFI の将来設計検討
- メトリクスの CI レポート化

**成果物**: 更新仕様書、ガイド、引き継ぎ文書

## 成果物と検証
- 双方のターゲットで FFI サンプルが成功し、所有権違反時に診断が出力される。
- `AuditEnvelope` に FFI 呼び出しのトレースが追加され、`0-3-audit-and-metrics.md` で確認できる。
- 仕様ドキュメントの更新がレビュー済みで、記録が残る。

## リスクとフォローアップ
- Windows (MSVC) の呼出規約差異によりバグが潜む恐れがあるため、`2-6-windows-support.md` と連携してテストケースを共有。
- 所有権注釈の表現力が不足している場合、Phase 3 で DSL 拡張を検討する。
- FFI ブリッジ生成に外部ツールを使う場合はライセンス・再現性を `0-3-audit-and-metrics.md` に記録。

## 参考資料
- [2-0-phase2-stabilization.md](2-0-phase2-stabilization.md)
- [3-9-core-async-ffi-unsafe.md](../../spec/3-9-core-async-ffi-unsafe.md)
- [guides/runtime-bridges.md](../../guides/runtime-bridges.md)
- [0-3-audit-and-metrics.md](0-3-audit-and-metrics.md)
- [0-4-risk-handling.md](0-4-risk-handling.md)
