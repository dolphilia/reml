# 4.1 マルチターゲット互換性検証計画

## 目的
- Phase 4 マイルストーン M1 を達成するため、x86_64 Linux/Windows/ARM64 macOS の 3 ターゲットで LLVM IR・バイナリ・診断の差分を検証し、承認閾値内に収束させる。
- リリース前の最終互換性チェックリストを運用し、OCaml 実装からの移行リスクを解消する。

## スコープ
- **含む**: 差分比較ツール整備、ターゲット別成果物の収集、診断メッセージ比較、レビュー手順、ログ記録。
- **含まない**: 新規ターゲットの追加、JIT。必要に応じて別計画。
- **前提**: Phase 3 でセルフホストビルドが成功し、マルチターゲット成果物が生成できること。

## 作業ブレークダウン

### 1. 比較基準と許容差分の定義（75-76週目）
**担当領域**: 検証基準の策定

1.1. **許容差分リストの作成**
- `docs/notes/llvm-spec-status-survey.md` の Phase 3 知見を参照
- ターゲット固有の差分を分類（ABI、デバッグ情報、最適化等）
- 許容可能な差分の明確化（例: タイムスタンプ、絶対パス）
- 却下すべき差分の定義（例: 機能差異、性能劣化）

1.2. **IR 比較基準**
- LLVM IR の構造的等価性の定義
- 命令順序の許容範囲（最適化による変動）
- メタデータの扱い（デバッグ情報、ソース位置等）
- 型システムの一致性（型定義、属性）

1.3. **バイナリ比較基準**
- 実行可能ファイルのセクション別比較
- シンボルテーブルの一致性
- 再配置情報の差分許容
- デバッグセクション（DWARF）の扱い

1.4. **診断比較基準**
- [3-6-core-diagnostics-audit.md](../../spec/3-6-core-diagnostics-audit.md) のキー定義を参照
- メッセージテキストの一致性（ワーディング）
- 位置情報の正確性（Span）
- エラーコードの整合性
- 診断レベル（error/warning/info）の一致

**成果物**: 比較基準文書、許容差分リスト、検証マトリクス

### 2. 差分検証ツール実装（76-77週目）
**担当領域**: 自動化インフラ

2.1. **LLVM IR 差分ツール**
- `llvm-diff` のラッパースクリプト作成
- 構造的差分の抽出とフィルタリング
- 許容差分の自動除外
- レポート生成（JSON、Markdown 形式）

2.2. **バイナリ差分ツール**
- `objdump`、`readelf`、`dwarfdump` の統合
- セクション別の比較処理
- シンボル差分の抽出
- 視覚的な diff 表示（side-by-side 比較）

2.3. **診断差分ツール**
- CLI 出力のキャプチャと正規化
- 診断キーの抽出と照合
- テキスト差分の生成（unified diff）
- 位置情報の正規化（絶対パス → 相対パス変換）

2.4. **統合レポート生成**
- 全ツールの出力を統合
- サマリレポート（合格/警告/失敗のカウント）
- 詳細レポート（差分箇所のリスト、例示）
- トレンド分析（過去ビルドとの比較）

**成果物**: 差分検証ツール群、レポート生成スクリプト、CI 統合設定

### 3. ターゲット別成果物収集（77-78週目）
**担当領域**: マルチターゲット対応

3.1. **x86_64 Linux 成果物**
- OCaml 実装からの LLVM IR、バイナリ
- Reml 実装からの LLVM IR、バイナリ
- CLI 診断出力（サンプルコード実行結果）
- 性能メトリクス（コンパイル時間、実行時間）

3.2. **Windows x64 成果物**
- MSVC ABI 対応のバイナリ
- PE 形式の実行ファイル
- Windows 固有の診断メッセージ
- クロスコンパイル vs ネイティブビルドの比較

3.3. **ARM64 macOS 成果物**
- ARM64 ABI 対応のバイナリ
- Mach-O 形式の実行ファイル
- macOS 固有の診断メッセージ
- codesign 署名情報（Phase 4-2 との連携）

3.4. **成果物の整理と保存**
- ターゲット別ディレクトリ構造の統一
- 命名規則の徹底（`remlc-{ocaml|reml}-{target}-{version}`）
- CI アーティファクトとしての保存
- ローカル検証用のダウンロード手順

**成果物**: 3 ターゲット全ての成果物、整理済みアーティファクト

### 4. 差分比較実行と分析（78-79週目）
**担当領域**: 実測と評価

4.1. **IR 比較実行**
- 各ターゲットで OCaml 実装 vs Reml 実装の IR 比較
- 差分箇所の抽出と分類
- 許容差分の除外処理
- 未解決差分のフラグ付け

4.2. **バイナリ比較実行**
- 実行ファイルのバイト単位比較
- セクション別の差分分析
- シンボルテーブルの照合
- デバッグ情報の差分評価

4.3. **診断比較実行**
- 標準テストスイートでの診断収集
- エラーメッセージの比較
- 診断キーの一致率計算
- 不一致箇所の詳細分析

4.4. **性能比較**
- コンパイル時間の比較（OCaml 実装 vs Reml 実装）
- 実行時間の比較（生成バイナリ）
- メモリ使用量の比較
- Phase 2 ベースラインとの比較（±5% 目標）

**成果物**: 比較実行レポート、差分リスト、性能比較表

### 5. レビュー運用とエスカレーション（79-80週目）
**担当領域**: ガバナンスと意思決定

5.1. **レビュア割当と準備**
- ターゲット別レビュア指定（各ターゲット 1-2 名）
- レビュー資料の配布（レポート、サンプル差分）
- レビュー基準の共有
- レビュースケジュールの調整

5.2. **差分レビュー実施**
- 許容差分の再確認と承認
- 未解決差分の評価（修正必要 vs 延期可）
- 性能差異の評価
- 診断不一致の重要度判定

5.3. **承認プロセス**
- レビューコメントの収集
- 承認/条件付き承認/却下の判定
- 修正タスクの起票（却下項目）
- 承認記録の `0-3-audit-and-metrics.md` への追記

5.4. **エスカレーション処理**
- 重大な差分の早期エスカレーション
- Phase 4 リリース判定への影響評価
- リスク `0-4-risk-handling.md` への記録
- 修正期限の設定（Phase 4-2 開始前）

**成果物**: レビュー記録、承認済み差分リスト、修正タスクリスト

### 6. 修正タスク実行と再検証（80-81週目）
**担当領域**: 品質改善

6.1. **却下差分の修正**
- 優先度別の修正タスク実行
- ソースコード修正（Reml 実装）
- ビルドオプションの調整
- 再ビルドと検証

6.2. **修正後の再比較**
- 修正箇所の IR/バイナリ再生成
- 差分ツールの再実行
- 修正効果の確認
- 残存差分の再評価

6.3. **回帰テスト**
- 修正による副作用の確認
- 他ターゲットへの影響チェック
- 性能への影響測定
- CI での全テスト実行

6.4. **最終承認**
- レビュアによる再レビュー
- 最終承認の取得
- `0-3-audit-and-metrics.md` の更新
- M1 マイルストーン達成の宣言

**成果物**: 修正済み実装、再検証レポート、最終承認記録

### 7. ドキュメント化とナレッジ共有（81週目）
**担当領域**: 記録と継承

7.1. **差分レポート整理**
- 全ターゲットの最終差分リスト
- 許容差分の明示とその理由
- 修正履歴の記録
- 未解決課題（Phase 4 以降）のリスト

7.2. **検証手順書作成**
- ローカル環境での検証手順
- CI での自動検証設定
- トラブルシューティング
- 検証ツールの使い方ガイド

7.3. **ナレッジ記録**
- `docs/notes/llvm-spec-status-survey.md` への追記
- ターゲット固有の問題と解決策
- 将来の拡張ポイント（新規ターゲット追加時）
- レビュー過程での知見

7.4. **Phase 4-2 への引き継ぎ**
- リリースパイプラインへの要件伝達
- 検証済み成果物の引き渡し
- CI 設定の共有
- 継続監視項目の明示

**成果物**: 差分レポート最終版、検証手順書、ナレッジドキュメント、引き継ぎ資料

### 8. CI 統合と継続監視（81-82週目）
**担当領域**: 運用基盤

8.1. **CI ジョブ作成**
- 3 ターゲットでの差分検証ジョブ
- 定期実行（nightly or PR ごと）
- 失敗時の通知設定
- レポートの自動アーカイブ

8.2. **レグレッション検出**
- 過去ビルドとの比較
- 新規差分の自動検出
- 閾値超過時のビルド失敗
- 差分トレンドの可視化

8.3. **ダッシュボード構築**
- 差分サマリの表示（合格率、差分数）
- ターゲット別の状態一覧
- 性能トレンドグラフ
- GitHub Pages または CI レポート機能の活用

8.4. **継続改善**
- 検証ツールの改善フィードバック
- 新規差分パターンの追加
- Phase 4 以降での継続運用計画
- 定期レビューのスケジュール化

**成果物**: CI 統合設定、レグレッション検出システム、ダッシュボード

## 成果物と検証
- 3 ターゲットそれぞれで差分レポートが生成され、レビュア承認済みであること。
- 診断メッセージの差分がゼロ、もしくは承認済み改善のみであること。
- 記録が `0-3-audit-and-metrics.md` / `0-4-risk-handling.md` に残されていること。

## リスクとフォローアップ
- 比較ツールの出力が煩雑な場合、サマリを自動生成しレビュー効率を高める。
- ターゲット固有の問題が未解決の場合、リリーススケジュールに影響するため優先修正。
- デバッグ情報差分は許容範囲を明示的に定義し、将来の拡張 (DWARF バージョン差等) に備える。

## 参考資料
- [4-0-phase4-migration.md](4-0-phase4-migration.md)
- [3-6-core-diagnostics-audit.md](../../spec/3-6-core-diagnostics-audit.md)
- [notes/llvm-spec-status-survey.md](../../notes/llvm-spec-status-survey.md)
- [0-3-audit-and-metrics.md](0-3-audit-and-metrics.md)
- [0-4-risk-handling.md](0-4-risk-handling.md)

