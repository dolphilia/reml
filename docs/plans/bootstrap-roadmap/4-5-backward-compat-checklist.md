# 4.5 後方互換チェックリスト実施計画

## 目的
- Phase 4 で OCaml 実装を LTS 化する前に、後方互換チェックリストを運用し、セルフホスト版が必要条件（IR 一致率 95% 以上、診断 100%、性能 ±5%）を満たすことを確認する。
- チェックリストと結果を `0-3-audit-and-metrics.md` に記録し、コミュニティへ透明性を提供する。

## スコープ
- **含む**: チェックリスト策定、検証自動化、レビュー記録、LTS ブランチ化計画、アーカイブ手順。
- **含まない**: 新規機能検証、セキュリティ監査。必要に応じて別途実施。
- **前提**: 互換性検証・リリースパイプラインが整備され、測定基盤が存在する。

## 作業ブレークダウン

### 1. チェックリスト策定と基準定義（85週目前半）
**担当領域**: 検証基準設計

1.1. **チェックリスト項目の定義**
- IR 一致率項目（関数単位で 95% 以上）
- 診断整合性項目（主要エラーケースで 100% 一致）
- 性能差異項目（±5% 以内）
- ターゲット別エンドツーエンドテスト項目
- 各項目の合格基準と許容範囲

1.2. **測定手順の策定**
- LLVM IR 比較手順（`llvm-diff` 活用）
- 診断メッセージ比較手順（テキスト差分）
- 性能測定手順（ベンチマークスイート）
- エンドツーエンドテスト手順（統合テスト）
- 測定環境の標準化（OS、ハードウェア）

1.3. **閾値と許容差分の設定**
- IR 一致率 95% の根拠（Phase 3 実績基づく）
- 診断 100% 一致の例外ケース定義
- 性能 ±5% の計測誤差範囲
- ターゲット固有の許容差分
- 閾値超過時のエスカレーション基準

1.4. **担当者割当とレビュー体制**
- 各項目の測定担当者割当
- レビュア指定（`0-3-audit-and-metrics.md` §0.3.4 準拠）
- レビュー頻度と報告フォーマット
- エスカレーションフローの定義

**成果物**: チェックリスト項目定義、測定手順書、閾値設定文書、担当者割当表

### 2. 自動化スクリプト開発（85週目後半）
**担当領域**: 検証インフラ

2.1. **LLVM IR 差分集約スクリプト**
- 4-1 の差分ツールを再利用・拡張
- 関数単位の一致率計算機能
- 許容差分の自動除外機能
- レポート生成（JSON、Markdown）

2.2. **診断比較スクリプト**
- テストスイートからの診断収集
- OCaml 版 vs セルフホスト版の差分抽出
- 診断キーの照合（[3-6-core-diagnostics-audit.md](../../spec/3-6-core-diagnostics-audit.md) 準拠）
- 不一致箇所のカテゴリ分類（重大/軽微）

2.3. **性能測定スクリプト**
- Phase 3 ベンチマークの再実行
- コンパイル時間、実行時間、メモリ使用量の計測
- 差分計算と ±5% 判定
- トレンド分析（過去データとの比較）

2.4. **統合レポート生成**
- 全スクリプトの結果を統合
- サマリレポート（合格/警告/失敗）
- 詳細レポート（項目別結果、差分詳細）
- CI 統合用の JSON 出力

**成果物**: IR差分スクリプト、診断比較スクリプト、性能測定スクリプト、統合レポートツール

### 3. 検証実行とデータ収集（85-86週目）
**担当領域**: 実測と評価

3.1. **ターゲット別検証実行**
- x86_64 Linux での検証実行
- Windows x64 での検証実行
- ARM64 macOS での検証実行
- クロスコンパイル成果物の検証

3.2. **IR 一致率の測定**
- 標準ライブラリ全関数の IR 比較
- サンプルコードの IR 比較
- 一致率の計算（関数単位）
- 不一致箇所の分類と記録

3.3. **診断整合性の測定**
- エラーケーステストスイートの実行
- 診断メッセージの収集と比較
- 一致率の計算（主要エラーケース）
- 不一致メッセージの詳細分析

3.4. **性能差異の測定**
- Phase 3 ベースラインとの比較
- コンパイル時間、実行時間、メモリ使用量
- 差分の計算と ±5% 判定
- 性能劣化箇所の特定

**成果物**: ターゲット別検証結果、IR一致率データ、診断比較データ、性能測定データ

### 4. レビュー会議と判定（86週目前半）
**担当領域**: 評価と意思決定

4.1. **レビュー資料の準備**
- 検証結果サマリの作成
- 詳細レポートの整理
- 未達項目のハイライト
- 改善提案の準備

4.2. **レビュー会議の実施**
- ターゲット別レビュア参加
- 検証結果の報告と議論
- 合格/猶予/改善の判定
- 未達項目の対応方針決定

4.3. **判定結果の記録**
- 各項目の判定結果（合格/猶予/改善）
- 合格項目の承認記録
- 猶予項目の条件と期限
- 改善項目のタスク起票

4.4. **未達項目の対応計画**
- 改善タスクの優先度設定
- 担当者割当と期限設定
- `0-4-risk-handling.md` への登録
- フォローアップスケジュール

**成果物**: レビュー議事録、判定結果記録、改善タスクリスト、フォローアップ計画

### 5. 改善タスク実行と再検証（86週目、必要に応じて延長）
**担当領域**: 品質改善

5.1. **改善タスクの実施**
- 未達項目の修正（セルフホスト版）
- ソースコード修正、ビルド設定調整
- 再ビルドと成果物生成
- 修正効果の確認

5.2. **再検証の実行**
- 修正箇所の再測定
- IR/診断/性能の再比較
- 改善効果の確認
- 副作用（回帰）の確認

5.3. **回帰テスト**
- 修正による他項目への影響確認
- 全ターゲットでの回帰テスト
- CI での全テスト実行
- 既存合格項目の再確認

5.4. **再レビューと最終承認**
- 改善結果のレビュー
- レビュアによる再判定
- 最終承認の取得
- `0-3-audit-and-metrics.md` への記録

**成果物**: 改善済み実装、再検証結果、回帰テストレポート、最終承認記録

### 6. LTS ブランチ化準備（86週目中盤）
**担当領域**: OCaml実装の長期保守

6.1. **LTS ブランチ戦略の策定**
- ブランチ名とバージョニング（例: `ocaml-lts-1.0`）
- サポート範囲の定義（セキュリティパッチのみ vs バグ修正含む）
- サポート期間の設定（例: 12ヶ月間）
- 終了条件と延長判断基準

6.2. **LTS ブランチの作成**
- OCaml 実装の最終安定版からブランチ作成
- タグ付与（`ocaml-lts-v1.0.0`）
- CI 設定の調整（LTS 用ビルド設定）
- ドキュメントへのブランチ情報追加

6.3. **LTS サポートポリシーの文書化**
- サポート範囲の明示（セキュリティ、バグ修正）
- サポート期間と終了日
- 更新フロー（パッチリリース手順）
- サポート終了後の対応（アーカイブ化）

6.4. **LTS 保守体制の整備**
- 保守担当者の割当
- セキュリティパッチ対応フロー
- バグ報告受付窓口
- 緊急対応手順

**成果物**: LTS ブランチ、サポートポリシー文書、保守体制定義、CI設定

### 7. アーカイブ告知準備（86週目後半）
**担当領域**: コミュニティコミュニケーション

7.1. **告知文草案の作成**
- OCaml 実装の LTS 化告知
- セルフホスト版への移行推奨
- LTS サポート範囲と期間の説明
- サポート終了後の対応案内

7.2. **移行スケジュールの明示**
- LTS サポート開始日
- セルフホスト版への移行推奨期間
- LTS サポート終了日（予定）
- アーカイブ化実施日

7.3. **代替手順の提供**
- セルフホスト版への移行ガイド（4-4と連携）
- LTS 版の利用方法
- トラブルシューティング
- サポート窓口情報

7.4. **告知チャネルの準備**
- 公式サイトでの告知ページ
- メーリングリスト、フォーラム投稿案
- GitHub Discussions での FAQ
- リリースノートへの記載

**成果物**: アーカイブ告知文、移行スケジュール、代替手順ガイド、告知チャネル別資料

### 8. 最終記録とフォローアップ（87週目）
**担当領域**: 完了検証と継続監視

8.1. **チェックリスト完了記録**
- 全項目の最終判定結果
- 合格項目の承認記録
- 猶予項目の条件と期限
- 未達成項目の Phase 4 以降への引き継ぎ

8.2. **`0-3-audit-and-metrics.md` への記録**
- チェックリスト結果の記録
- IR 一致率、診断整合性、性能差異の最終値
- レビュアによる承認記録
- 未解決課題のリスト

8.3. **`0-4-risk-handling.md` への記録**
- 未達成項目のリスク登録
- 対応期限と担当者
- エスカレーション基準
- フォローアップ計画

8.4. **継続監視計画**
- LTS サポート期間中の監視項目
- セキュリティパッチ対応フロー
- コミュニティフィードバック収集
- Phase 4-6 との連携事項

**成果物**: 完了記録、メトリクス記録、リスク台帳更新、継続監視計画

## 成果物と検証
- チェックリスト結果が公開され、各項目が達成・未達ともに明示される。
- LTS ブランチが作成され、保守ポリシーが文書化される。
- コミュニティへの告知が完了し、フィードバック窓口が案内される。

## リスクとフォローアップ
- 測定環境の違いで結果がぶれる場合は再計測し、メトリクス取得方法を統一。
- 未達成項目が残る場合はリリースまでの改善計画を立案し、`0-4-risk-handling.md` でステータス管理。
- LTS サポートの負荷が高い場合、サポート頻度と SLA を再評価する。

## 参考資料
- [4-0-phase4-migration.md](4-0-phase4-migration.md)
- [0-3-audit-and-metrics.md](0-3-audit-and-metrics.md)
- [0-4-risk-handling.md](0-4-risk-handling.md)
- [notes/llvm-spec-status-survey.md](../../notes/llvm-spec-status-survey.md)

