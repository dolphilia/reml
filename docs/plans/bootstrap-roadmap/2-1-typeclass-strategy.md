# 2.1 型クラス実装戦略評価計画

## 目的
- Phase 2 マイルストーン M1 に向け、辞書渡し方式を主実装としつつモノモルフィゼーションを PoC 規模で比較し、採用方針を決定する。
- [1-2-types-Inference.md](../../spec/1-2-types-Inference.md) の型クラス仕様と `docs/notes/llvm-spec-status-survey.md` に整理された懸案を検証し、Phase 3 以降のセルフホスト化に備える。

## スコープ
- **含む**: 辞書生成・渡しの実装、代表型クラス (`Eq`, `Ord`, `Collector`) の性能測定、PoC モノモルフィゼーションの評価、メトリクス記録。
- **含まない**: 全型クラスのモノモルフィゼーション、特殊化の最適化、プラグイン型クラスの処理。必要に応じて Phase 3 で検討。
- **前提**: Phase 1 の Typer/Core IR/LLVM が安定稼働し、辞書引数を扱える拡張が可能であること。

## 作業ディレクトリ
- `compiler/ocaml/src/typer` : 型クラス辞書渡しの実装および PoC モジュール
- `compiler/ocaml/src/codegen` : LLVM への辞書引数連携
- `compiler/ocaml/tests` : 型クラス関連の回帰テスト
- `docs/notes/dsl-plugin-roadmap.md`, `docs/notes/llvm-spec-status-survey.md` : 評価結果・リスクのログ
- `docs/spec/1-2-types-Inference.md` : 仕様差分が発生した際の更新対象

## 作業ブレークダウン

### 1. 辞書渡し型システム設計（17-18週目）
**担当領域**: 型クラス基盤設計

1.1. **辞書データ構造定義**
- [1-2-types-Inference.md](../../spec/1-2-types-Inference.md) の型クラス仕様を OCaml データ型に写像
- 辞書レイアウト: `{ vtable: fn_ptr[], type_info: metadata }` の設計
- Core IR に `DictType`, `DictInstance`, `DictParam` ノードを追加
- ABI との整合性を確保（Phase 2 FFI タスクと連携）

1.2. **制約解決エンジン設計**
- Typer に制約収集・単一化・解決のパイプラインを追加
- `Eq`, `Ord`, `Collector` の制約規則を実装（`Collector` は `Core.Iter` で公開されるビルダトレイト）
- 制約グラフの構築と依存関係の追跡
- 循環依存・未解決制約の検出ロジック

1.3. **辞書生成パス構築**
- インスタンス宣言から辞書初期化コードを生成
- 型パラメータごとの辞書引数挿入ポイントの決定
- 選択子（メソッド呼び出し）の vtable インデックス計算
- LLVM IR への辞書構造体の lowering

**成果物**: 辞書型定義、制約解決エンジン、辞書生成パス

### 2. Typer 統合と制約解決（18-19週目）
**担当領域**: 型推論拡張

2.1. **型推論パイプライン拡張**
- 既存の Hindley-Milner 推論に制約収集を統合
- 型クラス制約の単一化ルール実装
- スーパークラス制約の伝播処理
- デフォルト実装の解決ルール

2.2. **辞書引数の自動挿入**
- 関数シグネチャへの辞書パラメータ追加
- 呼び出し側での辞書引数の自動供給
- ネストした型クラス制約の展開
- 高階関数での辞書伝播

2.3. **選択子展開**
- メソッド呼び出しを vtable アクセスに変換
- インライン展開の最適化判定
- デバッグ情報の保持（元のメソッド名）

**成果物**: 拡張 Typer、辞書引数挿入、選択子展開

### 3. PoC モノモルフィゼーション実装（19-20週目）
**担当領域**: 代替手法の評価

3.1. **テンプレート展開エンジン**
- `Eq`, `Ord`, `Collector` に限定したインスタンス化
- 型パラメータの具体型への置換ルール
- シンボル名のマングリング規約
- 展開済みコードの重複排除

3.2. **コード生成比較**
- 辞書渡し版と PoC 版の並行生成
- LLVM IR の差分抽出とサイズ計測
- 最適化レベル別の比較（`-O0`, `-O2`, `-O3`）
- インライン展開率の測定

3.3. **単体テスト実装**
- 代表型クラスの全メソッドテスト
- 制約の複雑な組み合わせケース
- エラーケース（未実装インスタンス）のテスト
- ゴールデンテスト（AST/IR スナップショット）

**成果物**: PoC モノモルフィゼーション、比較テスト

### 4. 性能・コードサイズ計測（20-21週目）
**担当領域**: 定量評価

4.1. **ベンチマーク設計**
- `0-3-audit-and-metrics.md` の計測規約に準拠
- マイクロベンチマーク: 単純なメソッド呼び出し（10^6 回）
- マクロベンチマーク: コレクション操作（sort, filter, map）
- コードサイズ: インスタンス数とバイナリサイズの関係

4.2. **計測自動化**
- CI で実行可能な計測スクリプト（OCaml/Shell）
- 辞書渡し vs PoC のレポート生成
- メモリ使用量のプロファイリング（valgrind/perf）
- 結果の JSON 出力と視覚化

4.3. **評価基準の設定**
- 実行時間のオーバーヘッド許容値（<10%）
- コードサイズの許容増加率（<30%）
- コンパイル時間の上限（<2x）
- 総合スコアリングと判定基準

**成果物**: ベンチマーク、計測レポート、評価基準

### 5. 診断システム強化（21-22週目）
**担当領域**: エラー報告

5.1. **型クラス診断拡張**
- [3-6-core-diagnostics-audit.md](../../spec/3-6-core-diagnostics-audit.md) に `extensions.typeclass.*` の定義を追記
- 制約解決失敗時の詳細メッセージ
- 候補インスタンスの提示（"Did you mean...?"）
- スーパークラス制約の欠落検出

5.2. **辞書情報の診断統合**
- 辞書引数の型情報を診断に含める
- vtable レイアウトのデバッグ出力（`--emit-dict-layout`）
- 制約グラフの可視化（Graphviz 形式）
- `AuditEnvelope.metadata` への辞書メタデータ記録

5.3. **エラー回復戦略**
- 未解決制約時のデフォルト型推定
- 部分的な辞書生成による継続処理
- Phase 1 の診断システムとの統合

**成果物**: 型クラス診断、辞書デバッグ機能

### 6. 評価レビューと方針決定（22-23週目）
**担当領域**: 意思決定

6.1. **評価結果の集約**
- 性能・コードサイズ・コンパイル時間の総合評価
- 開発コスト（実装・保守）の見積もり
- セルフホスト時の影響分析
- Phase 3 以降の拡張性評価

6.2. **採用方針の決定**
- 辞書渡しを主実装とする根拠の文書化
- PoC モノモルフィゼーションの却下理由（または採用条件）
- ハイブリッド手法の可能性検討
- 決定プロセスの `0-4-risk-handling.md` への記録

6.3. **Phase 3 への引き継ぎ**
- セルフホスト型チェッカへの移植計画
- 残存課題の `docs/notes/llvm-spec-status-survey.md` への記録
- プラグイン型クラスの設計検討事項
- メトリクスの CI レポート化

**成果物**: 評価報告書、採用方針、引き継ぎドキュメント

### 7. ドキュメント更新と仕様同期（23週目）
**担当領域**: 仕様整合

7.1. **仕様書フィードバック**
- [1-2-types-Inference.md](../../spec/1-2-types-Inference.md) への実装差分の反映
- 辞書構造の ABI 仕様を [3-9-core-async-ffi-unsafe.md](../../spec/3-9-core-async-ffi-unsafe.md) に追記
- 制約解決アルゴリズムの擬似コードを追加
- 新規サンプルコードの追加

7.2. **メトリクス記録**
- `0-3-audit-and-metrics.md` に計測結果を追記
- CI レポートの自動生成設定
- 性能レグレッション検出の閾値設定

7.3. **レビュー資料作成**
- M1 マイルストーン達成報告
- 辞書渡し vs PoC 比較レポート
- 次フェーズへの TODO リスト

**成果物**: 更新仕様書、メトリクス記録、レビュー資料

### 8. 統合テストと安定化（23-24週目）
**担当領域**: 品質保証

8.1. **統合テスト整備**
- [1-2-types-Inference.md](../../spec/1-2-types-Inference.md) の全サンプルの実行テスト
- 型クラス制約の複雑な組み合わせテスト
- Phase 1 のテストスイートとの統合
- ゴールデンテスト（IR/診断出力）の更新

8.2. **CI/CD 強化**
- 型クラステストの GitHub Actions ジョブ追加
- 性能レグレッション検出の自動化
- テストカバレッジの計測と目標（>80%）
- ビルド時間の最適化

8.3. **安定化とバグ修正**
- テスト失敗の原因調査と修正
- エッジケースの追加テスト
- 既知の制限事項の文書化
- Phase 2 他タスクとの統合検証

**成果物**: 統合テストスイート、CI 設定、安定版

## 進捗ログ（2025-10-15 更新）
- `Type_env` を `constrained_scheme` ベースに刷新し、型クラス制約付きスキームを環境全体で扱えるようにした。既存の let 多相は空の制約リストとして保持し、辞書引数を導入するための基盤を確保。
- `Constraint` モジュールの代入適用・自由型変数収集を制約リスト込みで再実装し、今後の制約伝搬で辞書レイアウト情報が欠落しないようにした。
- 型推論・Typed AST を制約付きスキーム対応へ移行し、`generalize` / `instantiate` / `make_typed_decl` など辞書情報を保持する経路を確認済み。既存テストも `scheme_to_constrained` を介して更新。
- Core IR と CFG/DCE/ConstFold/CodeGen が `DictConstruct` / `DictMethodCall` ノードを認識するように調整し、辞書生成と vtable 呼び出しを後続パスで扱うためのスタブを追加。
- LLVM バックエンドは現時点で辞書ノードを未実装扱いとしつつ、エラーメッセージで Phase 2 のブロッカーを明示。今後の辞書 lowering 実装が必要。

### フォローアップ
- 制約付きスキームに蓄えた `trait_constraint` を解決フェーズへ流すため、制約解決器 (`constraint_solver`) のインターフェース更新が必要。
- Core IR の辞書ノードが実際に生成される経路（脱糖・型推論）を実装し、CodeGen での辞書レイアウト確定まで接続するタスクを追加する。
- `docs/spec/1-2-types-Inference.md` と辞書 ABI 仕様 (`docs/spec/3-9-core-async-ffi-unsafe.md`) へ今回の構造変更を反映し、用語集・リスクログの更新を検討。

## 成果物と検証
- 辞書渡し方式で [1-2-types-Inference.md](../../spec/1-2-types-Inference.md) のサンプルが全て通過すること。
- PoC モノモルフィゼーションの出力を LLVM IR で比較し、差分とコストを `docs/notes/llvm-spec-status-survey.md` に追記。
- メトリクスが `0-3-audit-and-metrics.md` に記録され、CI でレポート化される。

## リスクとフォローアップ
- PoC の工数が膨張する場合は対象型クラスを縮小し、Phase 3 で再評価する。
- 辞書構造の ABI が未確定だと FFI との互換性が崩れるため、Phase 2 FFI 拡張タスクと連携し、構造体定義を共通化する。
- 量産型クラスの可搬性を検証するため、セルフホスト時の影響を `3-2-reml-typechecker-port.md` に引き継ぐメモを残す。

## 参考資料
- [2-0-phase2-stabilization.md](2-0-phase2-stabilization.md)
- [1-2-types-Inference.md](../../spec/1-2-types-Inference.md)
- [0-3-audit-and-metrics.md](0-3-audit-and-metrics.md)
- [0-4-risk-handling.md](0-4-risk-handling.md)
- [notes/llvm-spec-status-survey.md](../../notes/llvm-spec-status-survey.md)
