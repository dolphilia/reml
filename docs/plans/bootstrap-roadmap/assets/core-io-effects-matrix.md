# Core IO & Path 効果タグ・Capability マトリクス

## 背景
- 仕様 [3-5 Core IO & Path](../../spec/3-5-core-io-path.md) は Reader/Writer・ファイル・パス・監視 API ごとに `effect {io}`, `effect {io.blocking}`, `effect {security}`, `effect {io.async}` を明示しており、監査要件（[3-6 Core Diagnostics & Audit](../../spec/3-6-core-diagnostics-audit.md)）と Capability Registry（[3-8 Core Runtime & Capability](../../spec/3-8-core-runtime-capability.md) §1.2, §5.1）のステージ契約を同時に満たす必要がある。
- 効果タグと Capability 要件を API 横断で一覧化し、`IoContext` / `EffectSet` / `CapabilityRegistry::verify_capability_stage` の出力を CI で突合できるようにする。
- `docs/plans/bootstrap-roadmap/3-5-core-io-path-plan.md` の 1.2 項で指示された `effects_matrix` シナリオの基準票として、本ファイルを参照する。

## 効果タグ／Capability 整合マトリクス
| APIカテゴリ | 代表 API | 効果タグ | 必須 Capability / Stage 要件 | 検証ポイント | 仕様根拠 |
| --- | --- | --- | --- | --- | --- |
| Reader / Writer 基本操作 | `Reader::read`, `Reader::read_exact`, `Writer::write`, `Writer::flush`, `copy`, `with_reader` | `effect {io}`, `effect {io.blocking}` | `CapabilityId = "io.fs"`（`IoCapability`） / `StageRequirement::AtLeast(StageId::Beta)`。`CapabilityRegistry::verify_capability_stage("io.fs", ..)` の結果を `effect.stage.required/actual` として転写する。 | `take_io_effects_snapshot()` で `EffectSet.mark_io` / `effect.io_blocking = true` を収集し、`metadata.io.operation`, `metadata.io.path`, `metadata.io.helper`（`copy`/`with_reader`/`write_all` などヘルパ名）と `metadata.io.bytes_processed` が `IoContext` から常に埋まることを `python3 tooling/ci/collect-iterator-audit-metrics.py --section core_io --scenario reader_writer --matrix docs/plans/bootstrap-roadmap/assets/core-io-effects-matrix.md --output reports/spec-audit/ch3/reader_writer-effects.json --require-success` で検証する。 | [3-5](../../spec/3-5-core-io-path.md) §2, [3-6](../../spec/3-6-core-diagnostics-audit.md) §1 (`core.io.*` 診断), [3-8](../../spec/3-8-core-runtime-capability.md) §5.1 |
| ファイルハンドル / メタデータ | `File::open`, `File::create`, `File::metadata`, `File::remove`, `File::sync` | `effect {io}`, `effect {io.blocking}` | `CapabilityId = "io.fs"`（`IoCapability`） / `StageRequirement::AtLeast(StageId::Beta)`。`FileOptions.permissions` 経由で `SecurityCapability` を要求する場合は `CapabilityId = "security.fs.policy"` / `StageRequirement::Exact(StageId::Stable)` を追加。 | `IoError::into_diagnostic()` が `metadata.io.capability`, `metadata.security.policy`, `metadata.io.operation`, `metadata.io.platform`, `effect.stage.required/actual` を埋めることを `effects_matrix` シナリオに加えて `file_ops` シナリオ（`python3 tooling/ci/collect-iterator-audit-metrics.py --section core_io --scenario file_ops --platform linux --platform windows --output reports/spec-audit/ch3/file_ops-metrics.json --require-success`）で確認し、`scripts/validate-diagnostic-json.sh --pattern core.io.file --pattern metadata.io.file` と併用して `core.io.file.*` 診断の必須キーを照合する。 | [3-5](../../spec/3-5-core-io-path.md) §3, [3-6](../../spec/3-6-core-diagnostics-audit.md) §1 (`core.io.file.*`), [3-8](../../spec/3-8-core-runtime-capability.md) §5.1, §1.2, [docs/plans/bootstrap-roadmap/3-5-core-io-path-plan.md](../3-5-core-io-path-plan.md) §3.1 |
| バッファリング / 行読み出し | `BufferedReader`, `buffered`, `read_line` | `effect {mem}`, `effect {io.blocking}` | `CapabilityId = "io.fs"`（`IoCapability`） / `StageRequirement::AtLeast(StageId::Beta)` に加えて `CapabilityId = "memory.buffered_io"`（`MemoryCapability`） / `StageRequirement::AtLeast(StageId::Beta)` を要求。 | `BufferedReader` の確保時に `record_buffer_allocation` が発火し、`collector.effect.mem_bytes` / `collector.effect.mem=true` が `collect-iterator-audit-metrics.py --section core_io --scenario effects_matrix --check buffered` で検証できること。`metadata.io.buffer.capacity` / `metadata.io.buffer.fill` を `IoContext` に保存し、`compiler/runtime/tests/buffered_reader.rs` + `tests/data/core_io/buffered_reader/context_snapshot.json` でゴールデン化する。 | [3-5](../../spec/3-5-core-io-path.md) §3.1, [docs/plans/rust-migration/2-2-adapter-layer-guidelines.md](../../plans/rust-migration/2-2-adapter-layer-guidelines.md) §2.2.5 (FS/Memory) |
| パス列挙 / セキュリティ | `glob`, `is_safe_symlink`, `validate_path`, `sandbox_path` | `effect {io}`, `effect {io.blocking}`, `effect {security}`（`validate_path` / `sandbox_path` / `is_safe_symlink`） | `CapabilityId = "io.fs"`（`IoCapability`） / `StageRequirement::AtLeast(StageId::Beta)` + `CapabilityId = "security.fs.policy"`（`SecurityCapability`） / `StageRequirement::Exact(StageId::Stable)`。`SecurityCapability` は `Diagnostic.extensions["effects"].capability` にも転写する。 | `core.path.security.*` 診断で `metadata.security.reason`, `effect.security=true`, `effect.stage.required = Exact("stable")` を必須化し、`glob` 系では `metadata.io.glob.pattern` / `metadata.io.glob.offending_path` / `metadata.io.helper = "path.glob"` が欠落しないことを `collect-iterator-audit-metrics.py --section core_io --scenario path_glob --matrix docs/plans/bootstrap-roadmap/assets/core-io-effects-matrix.md --output reports/spec-audit/ch3/path_glob-metrics.json --require-success` で突合する。Rust 実装では `cargo test --manifest-path compiler/runtime/Cargo.toml path_security` + `tests/data/core_path/security/*.json` に加え、`tests/path_glob.rs` + `tests/data/core_path/glob_{posix,windows}.json` / `tests/fixtures/path_glob/*` をゴールデン化する。 | [3-5](../../spec/3-5-core-io-path.md) §4.2, §4.4, [3-6](../../spec/3-6-core-diagnostics-audit.md) §1 (`core.path.security.*`), [3-8](../../spec/3-8-core-runtime-capability.md) §1.2 |
| パス文字列ユーティリティ | `normalize_path`, `join_paths`, `relative_to`, `is_absolute_str` | `@pure`（EffectSet なし） | N/A（Capability 要件なし） | `tests/path_string_utils.rs` + `tests/data/core_path/unicode_cases.json` で POSIX/Windows/UNC ケースを検証し、`reports/spec-audit/ch3/path_unicode-20251130.md` に `cargo test --manifest-path compiler/runtime/Cargo.toml path_string_utils` の結果を保存する。`docs/plans/bootstrap-roadmap/3-3-core-text-unicode-plan.md` と相互参照し、Text 側で `record_text_mem_copy` を観測する。 | [3-5](../../spec/3-5-core-io-path.md) §4.3, [docs/plans/bootstrap-roadmap/3-5-core-io-path-plan.md](../3-5-core-io-path-plan.md) §4.3 |
| ファイル監視 / Watcher | `watch`, `watch_with_limits`, `close`, `WatchEvent` | `effect {io}`, `effect {io.async}` | `CapabilityId = "io.fs.watch"`（`IoCapability` 拡張） / `StageRequirement::AtLeast(StageId::Beta)` と `CapabilityId = "async.scheduler"`（`AsyncCapability`） / `StageRequirement::AtLeast(StageId::Beta)` の両方を要求。`compiler/runtime/src/io/watcher.rs` は `WatcherAdapter` を通じて Stage を検証し、`IoContext` に `metadata.io.watch.queue_size` / `metadata.io.watch.delay_ns` を埋め込む。 | `watch`/`watch_with_limits` で `effect.io_async=true`、`metadata.io.watch.queue_size`、`metadata.io.watch.delay_ns` が `collect-iterator-audit-metrics.py --section core_io --scenario effects_matrix --check watcher` のケースと突合できること。Rust 実装では `tests/watcher.rs`（`tests/fixtures/watcher/simple_case` をコピーする E2E テスト）を CI に追加し、`WatcherAuditSnapshot::into_metadata()` が `reports/spec-audit/ch3/io_watcher-simple_case.jsonl` へ出力する `io.watch.*` キーを `scripts/validate-diagnostic-json.sh --pattern core.io.watcher` と `collect-iterator-audit-metrics.py --section core_io --scenario watcher_audit` で検証する。 | [3-5](../../spec/3-5-core-io-path.md) §4.4, [3-6](../../spec/3-6-core-diagnostics-audit.md) §1 (`core.io.watcher.*`), [3-8](../../spec/3-8-core-runtime-capability.md) §1.4 |

## 監査・CI 設計
- `python3 tooling/ci/collect-iterator-audit-metrics.py --section core_io --scenario reader_writer --matrix docs/plans/bootstrap-roadmap/assets/core-io-effects-matrix.md --output reports/spec-audit/ch3/reader_writer-effects.json --require-success` で `metadata.io.helper` / `metadata.io.bytes_processed` / `effect.io_blocking_calls` をチェックし、Reader/Writer ヘルパの効果測定を CI へ昇格させる。
- `python3 tooling/ci/collect-iterator-audit-metrics.py --section core_io --scenario effects_matrix --matrix docs/plans/bootstrap-roadmap/assets/core-io-effects-matrix.md --output reports/spec-audit/ch3/core_io_effects.json --require-success` を Phase3 `core-io-path` ジョブへ追加し、上表に列挙した各カテゴリの `effect.*` / `metadata.io.*` / `metadata.security.*` / `effect.stage.*` を突合する。
- `python3 tooling/ci/collect-iterator-audit-metrics.py --section core_io --scenario file_ops --platform linux --platform windows --matrix docs/plans/bootstrap-roadmap/assets/core-io-effects-matrix.md --output reports/spec-audit/ch3/file_ops-metrics.json --require-success` を並行実行し、`File` 行の `effect {io}`/`{io.blocking}`、Capability `io.fs.*`/`security.fs.*`、`metadata.io.file.*` が POSIX/Windows 双方で欠落しないことを確認する。結果は `core_io.file_ops_pass_rate`（`docs/guides/tooling/audit-metrics.md`）へ転記する。
- `python3 tooling/ci/collect-iterator-audit-metrics.py --section core_io --scenario path_glob --matrix docs/plans/bootstrap-roadmap/assets/core-io-effects-matrix.md --output reports/spec-audit/ch3/path_glob-metrics.json --require-success` を追加し、`core.path.glob.*` 診断と `metadata.io.glob.pattern/offending_path` が `docs/spec/3-5` §4.1 の要件を満たすかチェックする。
- レポートは `reports/spec-audit/ch3/core_io_effects.json`（サマリ）と `reports/spec-audit/ch3/core_io_effects.jsonl`（ケース詳細）に保存し、週次レビューで `core_io.effect_matrix_pass_rate` を確認する。`pass_rate < 1.0` の場合は `docs/plans/bootstrap-roadmap/0-4-risk-handling.md` へ即時登録する。
- `scripts/validate-diagnostic-json.sh --pattern core.io --pattern core.path.security --pattern core.io.watcher` を併走させ、診断と監査ログの必須キーが同時に揃っていることを保証する。

## 既知のギャップ
- `EffectSet` は `mark_io` ビットのみを提供しており、`effect {io.blocking}` / `effect {io.async}` / `effect {security}` を個別に追跡できない。`take_io_effects_snapshot()` と `collect-iterator-audit-metrics.py --section core_io` で参照できるよう、`compiler/runtime/src/prelude/iter/mod.rs` のビットフィールド拡張と `compiler/runtime/src/io/effects.rs` のスナップショット API を追加する必要がある。
- `CollectorEffectMarkers` には `io_blocking` / `security_checks` 相当のカウンタが存在しないため、`BufferedReader` や `validate_path` の効果測定ができない。`collector.effect.io_blocking` / `collector.effect.security` を導入し、`collect-iterator-audit-metrics.py` が `core_io.effects_matrix` 行と突合できるようにする。
- `IoContext` から `CapabilityId` と Stage 情報を `Diagnostic.audit_metadata` へ転写する経路が未実装である。`IoError::into_diagnostic` で `effect.stage.required/actual` と `metadata.io.capability` を必須入力として扱う拡張が必要。
