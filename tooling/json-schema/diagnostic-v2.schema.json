{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://reml.dev/schemas/diagnostic-v2.schema.json",
  "title": "Reml Diagnostic V2",
  "description": "Reml CLI / LSP が共有する診断 V2 JSON エンベロープのドラフト定義。",
  "type": "object",
  "required": ["message", "severity", "primary", "audit", "audit_metadata", "timestamp"],
  "additionalProperties": true,
  "properties": {
    "id": {
      "type": ["string", "null"],
      "description": "診断のトレーサビリティ ID。UUID v4 を推奨。"
    },
    "message": {
      "type": "string"
    },
    "severity": {
      "oneOf": [
        {
          "type": "string",
          "enum": ["error", "warning", "info", "hint"]
        },
        {
          "type": "integer",
          "enum": [1, 2, 3, 4]
        }
      ],
      "description": "Severity 列挙の文字列表現、または LSP 数値（1=Error, 2=Warning, 3=Info, 4=Hint）。"
    },
    "severity_level": {
      "type": "integer",
      "enum": [1, 2, 3, 4],
      "description": "LSP Diagnostics に合わせた数値表現。1=Error, 2=Warning, 3=Info, 4=Hint。"
    },
    "domain": {
      "type": ["string", "null"],
      "enum": [
        "syntax",
        "parser",
        "type",
        "effect",
        "runtime",
        "config",
        "manifest",
        "target",
        "security",
        "plugin",
        "cli",
        "lsp",
        "regex",
        "template",
        "text",
        "network",
        "data",
        "audit",
        "other",
        null
      ],
      "description": "診断ドメインの語彙。`other` を使用する場合は `extensions[\"domain.other\"]` に元の識別子（snake_case 推奨）を格納する。"
    },
    "codes": {
      "type": "array",
      "items": { "type": "string" },
      "minItems": 1,
      "description": "診断コード。先頭要素が primary code。"
    },
    "primary": {
      "type": "object",
      "required": ["file", "start_line", "start_col", "end_line", "end_col"],
      "properties": {
        "file": { "type": "string" },
        "start_line": { "type": "integer", "minimum": 0 },
        "start_col": { "type": "integer", "minimum": 0 },
        "end_line": { "type": "integer", "minimum": 0 },
        "end_col": { "type": "integer", "minimum": 0 }
      },
      "additionalProperties": false
    },
    "secondary": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [],
        "properties": {
          "span": { "$ref": "#/properties/primary" },
          "message": { "type": ["string", "null"] }
        },
        "additionalProperties": false
      }
    },
    "expected": {
      "type": ["object", "null"],
      "description": "ExpectationSummary のドラフト表現。詳細は 3-6 §2.3 を参照。"
    },
    "hints": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "message": { "type": ["string", "null"] },
          "actions": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["kind", "range"],
              "properties": {
                "kind": {
                  "type": "string",
                  "enum": ["insert", "replace", "delete"]
                },
                "range": { "$ref": "#/properties/primary" },
                "text": { "type": ["string", "null"] }
              },
              "additionalProperties": false
            }
          }
        },
        "additionalProperties": false
      }
    },
    "structured_hints": {
      "type": "array",
      "description": "V2 で追加された構造化ヒント。",
      "items": {
        "type": "object",
        "required": ["kind", "payload"],
        "properties": {
          "id": { "type": ["string", "null"] },
          "title": { "type": ["string", "null"] },
          "span": { "$ref": "#/properties/primary" },
          "kind": {
            "type": "string",
            "description": "quick_fix / follow_up / context / documentation / command / link など。"
          },
          "payload": {
            "type": ["object", "array", "string"],
            "description": "CLI 側で定義する構造化データ。"
          },
          "actions": {
            "type": "array",
            "items": { "$ref": "#/properties/hints/items/properties/actions/items" }
          }
        },
        "additionalProperties": true
      }
    },
    "extensions": {
      "type": "object",
      "description": "自由拡張領域。`diagnostic.v2` キーに派生フィールドを格納する想定。"
    },
    "stream_meta": {
      "type": ["object", "null"],
      "description": "ストリーミングランナーのメタデータ。存在する場合は CLI / LSP で同一値を共有する。",
      "required": [
        "bytes_consumed",
        "chunks_consumed",
        "await_count",
        "resume_count",
        "backpressure_events"
      ],
      "properties": {
        "bytes_consumed": { "type": "integer", "minimum": 0 },
        "chunks_consumed": { "type": "integer", "minimum": 0 },
        "await_count": { "type": "integer", "minimum": 0 },
        "resume_count": { "type": "integer", "minimum": 0 },
        "last_reason": { "type": ["string", "null"] },
        "memo_bytes": { "type": ["integer", "null"], "minimum": 0 },
        "backpressure_policy": { "type": ["string", "null"] },
        "backpressure_events": { "type": "integer", "minimum": 0 }
      },
      "additionalProperties": false
    },
    "audit": {
      "type": "object",
      "description": "AuditEnvelope の JSON 表現。",
      "required": ["metadata"],
      "additionalProperties": false,
      "properties": {
        "metadata": {
          "type": "object",
          "description": "監査メタデータの辞書。",
          "additionalProperties": true
        },
        "audit_id": {
          "type": ["string", "null"],
          "description": "監査イベントの識別子。UUID v4 を推奨。"
        },
        "change_set": {
          "description": "監査対象の変更セット。コマンドや入力ファイルなどのコンテキストを含む。",
          "type": ["object", "array", "string", "number", "boolean", "null"]
        },
        "capability": {
          "type": ["string", "null"],
          "description": "関連する Capability 名（存在する場合）。"
        }
      }
    },
    "audit_metadata": {
      "type": "object",
      "description": "AuditEnvelope への書き込み前に持つメタデータのフラット辞書。",
      "additionalProperties": true
    },
    "timestamp": {
      "type": "string",
      "description": "ISO8601 (UTC) タイムスタンプ。",
      "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$"
    }
  }
}
