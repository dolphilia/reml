# Reml 改善注目マトリクス（監査・ストリーム・外部DSL連動）

新規サンプル `audit_pipeline_integration.reml`, `stream_processing_dsl.reml`, `external_dsl_bridge.reml` の検証結果に基づき、Reml 仕様の追補が必要と判断した論点を整理する。Chapter 3 のランタイム／診断仕様、Chapter 2 のパーサー API、および Config/Capability 連携の改善検討に利用することを想定している。

| 観点 | 参考サンプル/根拠 | 発見された課題 | 改善提案 | 関連章 | 優先度 | 進行状況 |
| - | - | - | - | - | - | - |
| Capability 検証エラーの実態把握 | `examples/language-impl-samples/reml/audit_pipeline_integration.reml:193-205` | `Runtime.verify_capability_stage` が失敗時の実在 Stage 情報を返さず、サンプルでは `StageRequirement` から推測値を仮置きして診断 (`actual_stage = Experimental`) を生成している。監査ログの正確性と `effects.contract` 系診断の一貫性が損なわれる。 | `Runtime.CapabilityError` に `actual_stage`, `capability_metadata` を追加し、`verify_capability_stage` の Err で必須提供とする。併せて `Diag.EffectDiagnostic` で Stage 差分を構造化出力する規約を 3-6 §2.4.1 / 3-8 §1.2 / 3-9 §1.4.5 に追記。 | 3-6, 3-8, 3-9 | 高 | 完了 |
| メトリクススコープとリソース制限の分断 | `examples/language-impl-samples/reml/audit_pipeline_integration.reml:220-277` | DSL メトリクスとチャネルメトリクスで個別に `Runtime.create_metrics_registry()` を要求され、リソース制限 (`Async.ResourceLimitSet`) も ExecutionPlan に自動伝播しない。パイプラインごとのメトリクス統合やリミット監査が仕様から読めない。 | `Runtime` にパイプライン単位の `ExecutionMetricsScope` を追加し（3-8 §4）、`Async.channel_metrics`/`Diag.register_dsl_metrics` が同一スコープを受け取れるよう改訂。`ResourceLimitSet` を ExecutionPlan と Conductor 設定に連動させる手順を 3-6 §6.1 / 3-9 §1.4 に明文化。 | 3-6, 3-8, 3-9 | 中 | 完了 |
| ExecutionPlan の適用欠如 | `examples/language-impl-samples/reml/stream_processing_dsl.reml:240-307` | ストリーム処理で `Async.ExecutionPlan` を構築しても、適用先 API が無いため計画が実行経路に反映されず、バックプレッシャー戦略が実装依存のままになる。 | 3-9 §1.4 に `Async.with_plan(stream, plan)` を追加し、適用時の Capability 検証・診断メタデータ (`extensions["async.plan"]`) と `async.plan.unsupported` コードを定義。2-6 §M で `RunConfig.extensions["async"].execution_plan` との連動を明文化。 | 2-6, 3-9 | 高 | 完了 |
| Timeout エラー型の二重定義 | `examples/language-impl-samples/reml/audit_pipeline_integration.reml:427-443`, `examples/language-impl-samples/reml/stream_processing_dsl.reml:325-333` | 同じ `Async.timeout` を利用しているにも関わらず、片方のサンプルは `Async.AsyncError.Timeout`、もう片方は `Async.TimeoutError` を想定。仕様でエラー型の単一化がされておらず、診断コード `async.timeout` の扱いも不統一。 | 3-9 §1.2 に `Async.timeout` の戻り値と `TimeoutInfo` を追記し、3-6 §2.5 で `async.timeout` コードとメタデータを標準化。併せて 2-5 §B-12 に診断生成手順と後方互換ヘルパを追加し、旧 `TimeoutError` 依存からの移行を明記。 | 2-5, 3-6, 3-9 | 中 | 完了 |
| DSL エクスポート署名と Capability ブリッジ | `examples/language-impl-samples/reml/external_dsl_bridge.reml:368-505` | GraphQL から生成した DSL エントリを `Manifest.DslExportSignature` で検証する際、`allows_effects` のみで Capability や Stage 要件を照合できず、`CapabilityManifest` からの情報も失われる。外部 DSL 連携時に効果タグと Capability の同期が仕様上曖昧。 | `DslExportSignature` に `requires_capabilities`/`stage_bounds` を追加し、Capability マニフェストとの整合検査手順を 3-7 §1.4.1 / 3-8 §7.4 に追加。`transform_capability_manifest_to_reml` で Stage/Capability を正規化する。 | 1-2, 3-7, 3-8 | 高 | 完了 |
| ParseError → Diagnostic 標準化不足 | `examples/language-impl-samples/reml/external_dsl_bridge.reml:440-509` | 外部 DSL 解析失敗時に `Diag.ParseDiagnosticOptions` を都度組み立てる必要があり、監査メタデータやロケール設定が実装者任せ。LSP/CLI 連携で診断品質に差が出る。 | `ParseDiagnosticOptions` に `input_name` を追加し、`Diag.parse_error_defaults(input_name)` と 3-6 §2.4.1 で `parse.*` 監査キーを必須化。2-5 §C-0 ではプリセット利用とレコード更新手順を示し、CLI/LSP と監査で統一された診断が得られるようにした。 | 2-5, 3-6 | 低 | 完了 |
