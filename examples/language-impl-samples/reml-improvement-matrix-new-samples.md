# Reml 改善注目マトリクス（新規サンプル連動）

新たに追加した `conductor_data_pipeline.reml`, `async_actor_supervision.reml`, `config_manifest_lifecycle.reml` の検証結果を踏まえ、Reml 仕様で改善が必要な観点を整理した。既存マトリクスと併せて参照し、Chapter 3 と DSL 関連仕様の拡張計画に活用することを想定している。

| 観点 | 参考サンプル/根拠 | 発見された課題 | 改善提案 | 関連章 | 優先度 | 進行状況 |
| - | - | - | - | - | - | - |
| Conductor と Capability 検証の統合 | `examples/language-impl-samples/reml/conductor_data_pipeline.reml:152-176`, `examples/language-impl-samples/reml/conductor_data_pipeline.reml:268-276`, `examples/language-impl-samples/reml/async_actor_supervision.reml:370-376` | `with_capabilities` 宣言と `Runtime.verify_capability(_stage)` の整合が仕様上自動化されておらず、Stage 検査 API も未定義。 | Conductor 宣言時に効果/Capability を静的検証する仕組みを 1-1 B.8 と 3-8 に追加し、`CapabilityRegistry::verify_stage` の正式 API を定義。`@cfg(capability="...")` との連携手順も明文化する。 | 1-1, 3-8, 3-9 | 高 | 完了 (1-1 §B.8.5 / 3-8 §1.2 / 3-9 §1.9.4 改訂) |
| リソース制限パラメータの型安全化 | `examples/language-impl-samples/reml/conductor_data_pipeline.reml:150-188` | `with_resource_limits(memory: "128MB", cpu: "0.5")` のように文字列へ依存しており、単位や上限値の検証がランタイム任せ。 | `Core.Resource.MemoryLimit`/`Core.Resource.CpuQuota` などの型を Chapter 3 へ追加し、Conductor/RunConfig での使用を必須化。`ExecutionPlan` バリデーションに単位換算と範囲チェックを取り込む。 | 3-5, 3-8, 3-9 | 中 | 完了 (3-5 §9 / 3-8 §6.1 / 3-9 §1.4.3 改訂) |
| 監視・メトリクスのベースライン不足 | `examples/language-impl-samples/reml/conductor_data_pipeline.reml:174-190`, `examples/language-impl-samples/reml/async_actor_supervision.reml:401-406` | Conductor/Channel 利用時の必須メトリクスが未定義で、バックプレッシャー状況を計測する標準 API が欠如。 | `Core.Async` に `channel_metrics` API を追加し、Conductor `monitoring` セクションでは latency/throughput/error_rate/in_flight をデフォルト収集とする規定を 3-6/3-9 に追記。 | 3-6, 3-9 | 中 | 完了 (3-6 §6.1.1, §6.5 / 3-9 §1.4.5 追記済) |
| ドメイン別 Diagnostic 拡張の標準化 | `examples/language-impl-samples/reml/conductor_data_pipeline.reml:237-255`, `examples/language-impl-samples/reml/conductor_data_pipeline.reml:288-291`, `examples/language-impl-samples/reml/config_manifest_lifecycle.reml:607-616` | Conductor/Config の診断拡張フィールドに共通フォーマットが無く、LSP/CLI での可視化がばらつく。 | 3-6 に `ConductorDiagnosticExtension` と `ConfigDiagnosticExtension` を追加し、必須フィールド（依存グラフ、互換モード差分、Stage 等）を定義。生成 API にバリデーションを組み込む。 | 3-6, 3-7 | 中 | 完了 (3-6 §6.1.2-6.1.3 / 3-7 §1.5.4 追記済) |
| 実行計画・スケジューラの静的検証 | `examples/language-impl-samples/reml/conductor_data_pipeline.reml:162-170`, `examples/language-impl-samples/reml/conductor_data_pipeline.reml:293-296`, `examples/language-impl-samples/reml/async_actor_supervision.reml:394-399` | Backpressure の閾値やスケジューラ構成が実行時検知に依存し、`high_watermark <= low_watermark` 等の不整合を早期に検出できない。 | `ExecutionPlan` 解析をコンパイラ/CLI の lint として実装し、`SchedulerConfig` の制約違反をビルド時エラーにする規則を 3-9 §1.4.3 に追加。 | 3-9 | 高 | 完了 (3-9 §1.4.3-1.4.4 静的検証追記) |
| AuditEvent タクソノミーの拡充 | `examples/language-impl-samples/reml/conductor_data_pipeline.reml:186-190`, `examples/language-impl-samples/reml/conductor_data_pipeline.reml:298-301`, `examples/language-impl-samples/reml/async_actor_supervision.reml:279-282`, `examples/language-impl-samples/reml/async_actor_supervision.reml:387-392`, `examples/language-impl-samples/reml/config_manifest_lifecycle.reml:583-598` | パイプライン/ワーカー/Stage 変更などドメイン固有イベントを手動で構築しており、標準のシリアライズ形式が無い。 | `AuditEvent` に Conductor・Async・Config・Env を網羅する標準バリアントと必須メタデータ表を追加し、拡張用途には `AuditEvent::Custom` を利用する方針を明文化する。監査ログが共通キーで整合するよう 3-7/3-8/3-10 を同期する。 | 3-6, 3-8 | 高 | 完了 (3-6 §1.1.1 新設, 3-7 §1.5, 3-8 §1.2, 3-10 §1-2 更新) |
| AsyncError の因果チェーン | `examples/language-impl-samples/reml/async_actor_supervision.reml:377-385` | `AsyncError` が一次原因しか保持できず、監査・診断で失敗パスを追跡できない。 | `AsyncError` に `cause` と `metadata` を追加し、`Diagnostic` へ連結する仕様を 3-9 §1.8/3-6 §2.5 に明記。 | 3-6, 3-9 | 中 | 完了 (3-6 §2.5 / 3-9 §1.8 改訂済) |
| Actor/Supervisor パターンの標準 API | `examples/language-impl-samples/reml/async_actor_supervision.reml:408-412` | Supervisor/再起動ロジックを利用者が都度実装しており、再利用性と監査一貫性が低い。 | Core.Async に `spawn_supervised`, `RestartStrategy`, `SupervisorSpec` 等の抽象を導入し、Capability/診断連携手順を 3-9 §1.9 に追加。 | 3-9 | 中 | 完了 (3-9 §1.9.5 / 3-6 §2.5.1 / 3-0 §セクションガイド) |
| ConfigCompatibility デフォルトと優先順位 | `examples/language-impl-samples/reml/config_manifest_lifecycle.reml:402-407`, `examples/language-impl-samples/reml/config_manifest_lifecycle.reml:573-587`, `examples/language-impl-samples/reml/config_manifest_lifecycle.reml:579-582` | `ConfigCompatibility.default()` の挙動と CLI/Env/Manifest の優先順位が未規定で、実装依存。 | 3-7 にデフォルトプロファイルを定義し、3-10 で優先順位 (CLI > Env > Manifest > Default) を正式化。`resolve_compat` の準拠テストを追加。 | 3-7, 3-10 | 高 | 完了 (3-7 §1.5.1-1.5.2 / 3-10 §2.1 改訂) |
| feature_guard と @cfg の同期 | `examples/language-impl-samples/reml/config_manifest_lifecycle.reml:589-606` | `feature_guard` に指定した互換フラグが `@cfg` 特性と同期せず、実行環境ごとに挙動差が出る。 | コンパイラが `ConfigCompatibility.feature_guard` と `RunConfig.extensions["target"].features` を突き合わせ、未同期時に診断 `config.feature.mismatch` を出す仕様を追加。 | 1-3, 3-7, 3-10 | 中 | 完了 (1-3 §C.1 / 3-7 §1.5.5 / 3-10 §2.1・§4 / 3-6 §6.1.3 更新) |
| 診断生成と効果タグの分離 | `examples/language-impl-samples/reml/config_manifest_lifecycle.reml:610-622` | `@pure` 関数内で `Diag.new_uuid()` や `current_timestamp()` を呼び出しており、効果タグ規約と矛盾。 | 診断レコードの構築を純粋処理に限定し、発行は別関数で `effect {diagnostic}` を要求する設計ガイドを 3-6 §2「ピュア構築と発行責務」と 3-7 §1.5.3 に明記。 | 3-6, 3-7 | 中 | 完了 (3-6 §2 / 3-7 §1.5.3) |

> 優先度の目安: 高 = 次版仕様で必須、 中 = 早期にドラフト化、 低 = 将来検討。
