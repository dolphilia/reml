# Reml 言語仕様降格検討メモ

## 1. 背景

- 参照文書: `0-2-project-purpose.md` に定義された Reml の目的と設計哲学。
- 現状の言語コア仕様 (`1-1`〜`1-4`) と標準 API (`2-1`〜`2-7`) を精査し、"小さく強いコア" と実用性重視の方針に照らして肥大化リスクを評価。
- 重要機能を削るのではなく、適切なレイヤ（標準 API / プラグイン / 既存機能の合成）へ移し替えることで目的適合性を高めることを目標とした。

## 2. コア仕様から標準 API への降格候補

### 2.1 `schema` 宣言ブロック
- **現状**: `1-1-syntax.md` に言語構文として収録。条件付き束縛・テンプレート糖衣を備える。
- **論点**: コア構文のプリミティブ数を抑える方針と乖離。実際の振る舞いは `Core.Config`（`2-7`）の API と 1:1 対応しており、構文糖衣がコア複雑性を押し上げている。
- **提案**: 言語コアから除外し、標準ライブラリの DSL ビルダ (`Config.schema` 他) やテンプレート API を活用。必要な糖衣はプラグインマクロで提供。

### 2.2 プラグインパッケージ構文 (`package` / `use plugin`)
- **現状**: `1-1-syntax.md` B.7 にてマニフェスト的メタデータを言語構文として扱う。
- **論点**: Capability 管理やバージョン制約はツール／マニフェストで代替可能。コア文法を複雑化し "小さく強いコア" を損なう恐れ。
- **提案**: プラグイン宣言は `reml-plugin` CLI やロックファイルへ移譲し、言語側は従来の `use` 文に集約。構文糖衣が不要な利用者への負担を軽減。

## 3. 標準 API から拡張／プラグインへの降格候補

### 3.1 ドメイン特化型 (`Tensor` / `Schema` / `Resource` / `EffectSet`)
- **現状**: `1-2-types-Inference.md` J 節にて HM コアへテンソル計算・クラウド資源・監査効果などの型群を組み込んでいる。
- **論点**: 学習コストと実装負荷が高く、ユースケース依存。コア型システムを越える責務を負っており、基本ゴール（迅速な DSL 構築）と相克。
- **提案**: コアは汎用 ADT + トレイト制約に留め、これらドメイン型は `Core.Data` などの拡張モジュールやプラグインで提供。利用プロジェクトが必要に応じて opt-in。

### 3.2 拡張効果タグ (`config` / `audit` / `runtime` / `gpu` ...)
- **現状**: `1-3-effects-safety.md` K 節で基礎効果に加えガバナンス目的のタグを公式化。
- **論点**: 基本5効果から大きく逸脱し、領域特化ロジックをコンパイラに強制。エコシステム全体の汎用性を損なう可能性。
- **提案**: コア効果は `mut/io/ffi/panic/unsafe` に限定。ガバナンス効果は `@requires` など属性を提供する監査プラグインで実装し、必要な現場のみ導入。

### 3.3 診断の監査メタデータ必須化
- **現状**: `2-5-error.md` の `Diagnostic` が `audit_id` や `ChangeSetRef` を既定フィールドとして要求。
- **論点**: 監査ワークフローを前提としており、一般的な解析器には過剰。エラー処理コアを重くする。
- **提案**: コア診断は汎用項目（severity / message / span / expected）へ縮退。監査用データは拡張フィールドとしてプラグインが注入。

### 3.4 実行設定の高度機能（ストリーミング制御・GC統合）
- **現状**: `2-1-parser-type.md` G 節や `2-6-execution-strategy.md` F〜H 節に詳細なストリーミングドライバ、FlowController、GC連携を標準 API として記載。
- **論点**: 初期導入や軽量ユースケースに不要な責務が標準 API へ載っており、目的である「最短距離の組み立て」を阻害。
- **提案**: 標準 API の既定は `run` / `run_partial` / Packrat / 左再帰切替に絞り、ストリーミング・GC・高度テレメトリは拡張モジュールとして外出し。`RunConfig` も軽量版＋拡張版の二層構造とする。

## 4. 今後の検討事項

1. 上記降格案に伴う文書リンク・参照の影響調査（`README.md`、関連ガイド、相互参照）。
2. 移行パスとツール連携（CLI / マニフェスト）の整理、および利用者向けのガイドライン作成。
3. プラグイン／拡張 API の最小仕様を定義し、従来機能をどのように opt-in で再提供するか決定。

## 5. 対応状況（反映済み）

- `schema` 宣言: `1-1-syntax.md` から削除し、`2-7-config.md` に API ベースの正式手順とマクロ糖衣を記載。
- プラグイン構文: `1-1-syntax.md` から削除し、CLI/マニフェスト運用を `guides/DSL-plugin.md` に追記。
- ドメイン特化型: `1-2-types-Inference.md` はコア型を汎用に絞り、領域固有型は拡張ライブラリ（`Core.Data` 等）へ委譲する旨を明示。
- 拡張効果タグ: `1-3-effects-safety.md` を 5 効果のみに整理し、ガバナンス効果は拡張属性へ切り出し。
- 診断メタデータ: `2-5-error.md` を `extensions` 中心に再設計し、監査情報はプラグインで注入できる形へ変更。
- 実行設定の高度機能: `2-1-parser-type.md` および `2-6-execution-strategy.md` をバッチ解析前提に縮約し、ストリーミングや GC 連携は `Core.Parse.Streaming` / ランタイム拡張に委ねる。

今後は上記仕様を前提に、拡張レイヤーの API とガイドを段階的に整備する。
