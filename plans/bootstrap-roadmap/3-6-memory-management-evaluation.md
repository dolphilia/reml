# 3.6 メモリ管理戦略評価計画

## 目的
- Phase 3 で予定されている RC 継続 vs GC 導入の評価を体系的に行い、Phase 3 終了時に採用方針を決定する。
- RC ツール整備・GC 候補調査・性能/メモリ比較を行い、`0-4-risk-handling.md` に意思決定の根拠を残す。

## スコープ
- **含む**: RC ツール（リーク検出・参照トレース）の整備、GC 候補（Boehm など）の PoC 統合、性能/メモリ測定、評価レポート。
- **含まない**: 本番 GC の完全実装、メモリモデルの仕様変更。必要に応じて Phase 4 以降。
- **前提**: Phase 1 で RC ベースのランタイムが完成しており、Phase 3 で Reml 実装に移植されている。

## 作業ブレークダウン

### 1. RC ツール整備（67-68週目、3-5と並行）
**担当領域**: RC 診断とデバッグ

1.1. **リーク検出ツール**
- 参照カウントのトレース機能
- リーク箇所の特定（未解放オブジェクトの報告）
- スタックトレースの記録
- CLI フラグ: `--mem-leak-detect`

1.2. **循環参照検出**
- オブジェクトグラフの構築
- 循環の検出アルゴリズム（深さ優先探索）
- 循環参照の可視化（Graphviz 出力）
- 警告メッセージの生成

1.3. **参照トレース**
- オブジェクトのライフタイム追跡
- 参照カウント操作のログ
- CLI フラグ: `--mem-trace`
- デバッグビルドでの詳細出力

**成果物**: RC診断ツール、CLI統合、ドキュメント

### 2. ベンチマークとワークロード選定（68-69週目）
**担当領域**: 評価基盤

2.1. **代表ワークロードの選定**
- マイクロベンチマーク: 小オブジェクト大量生成、長寿命オブジェクト
- アプリケーションベンチマーク: コンパイラセルフホスト、パーサ実行
- メモリ集約型: 大規模データ構造の操作
- 計算集約型: 数値演算・再帰処理

2.2. **計測フレームワーク**
- メモリアロケーション/解放パターンの記録
- ピークメモリ使用量の測定
- GC 停止時間の計測（GC の場合）
- スループット測定（処理時間）

2.3. **ベースライン収集**
- 現行 RC 実装での性能測定
- `0-3-audit-and-metrics.md` への記録
- 比較基準の確立
- 測定環境の標準化（ハードウェア、OS）

**成果物**: ベンチマークスイート、測定フレームワーク、ベースラインデータ

### 3. GC 候補調査（69-70週目）
**担当領域**: GC 技術評価

3.1. **GC アルゴリズム調査**
- Boehm GC（保守的 GC）
- 精密 GC（型情報ベース）
- 世代別 GC の検討
- インクリメンタル/並行 GC の可能性

3.2. **統合容易性評価**
- LLVM との統合方法
- 既存コードベースへの影響
- FFI との互換性
- クロスプラットフォーム対応

3.3. **候補の絞り込み**
- 実装コスト vs 効果の評価
- 保守性・成熟度の検討
- ライセンス互換性
- PoC 実装の対象決定（Boehm GC を優先）

**成果物**: GC技術調査レポート、候補選定

### 4. GC PoC 統合（70-72週目）
**担当領域**: 概念実証

4.1. **Boehm GC 統合**
- Boehm GC ライブラリのビルド統合
- `GC_malloc` / `GC_free` の呼び出し
- RC 操作の置き換え（条件付きコンパイル）
- 初期化・終了処理の追加

4.2. **最小動作確認**
- Hello World での動作確認
- 基本的なメモリアロケーション
- GC 起動の確認
- クラッシュ・リークのチェック

4.3. **ベンチマーク実行**
- 選定ワークロードでの実行
- GC 統計情報の収集
- パフォーマンスデータの記録
- 問題点の洗い出し

**成果物**: GC PoC 実装、動作確認レポート

### 5. 比較評価（72-73週目）
**担当領域**: 定量分析

5.1. **性能比較**
- スループット: RC vs GC での処理時間比較
- レイテンシ: GC 停止時間の測定
- メモリ使用量: ピーク・平均の比較
- CPU 使用率: オーバーヘッドの測定

5.2. **実装複雑性評価**
- コード行数・変更箇所の比較
- デバッグ容易性
- エラーハンドリングの複雑さ
- 保守コストの見積もり

5.3. **定性評価**
- 開発者体験（DX）への影響
- ユーザーへの透明性
- 既存コードへの影響
- 将来拡張性（並行GC等）

**成果物**: 比較評価レポート、定量データ、推奨事項

### 6. 意思決定プロセス（73-74週目）
**担当領域**: 方針決定

6.1. **評価サマリ作成**
- RC vs GC の総合評価
- トレードオフの明示
- 推奨方針の提案
- 各選択肢のリスク分析

6.2. **レビュー会議**
- ステークホルダーレビュー
- 評価結果のプレゼンテーション
- 質疑応答・議論
- 方針の仮決定

6.3. **最終決定と文書化**
- 採用方針の最終決定
- 決定理由の文書化
- `0-4-risk-handling.md` への記録
- 実装計画の策定（RC継続 or GC導入）

**成果物**: 意思決定記録、採用方針文書

### 7. フォローアップ計画（74週目、3-7と並行）
**担当領域**: 次ステップ準備

7.1. **RC 継続の場合**
- RC 最適化の計画
- リーク検出の強化
- 循環参照への対策（weak pointer等）
- Phase 4 での改善タスク

7.2. **GC 導入の場合**
- 本格実装のロードマップ
- 段階的移行計画
- RC との共存期間の設定
- Phase 4 での実装タスク

7.3. **ハイブリッド手法の場合**
- RC + GC 併用の設計
- 使い分け基準の定義
- 実装優先度の決定
- リスク管理計画

**成果物**: フォローアップ計画、ロードマップ

### 8. ドキュメント整備（74週目）
**担当領域**: ドキュメント

8.1. **評価レポート作成**
- 技術評価の詳細記録
- ベンチマーク結果の整理
- グラフ・表による可視化
- 結論と推奨事項

8.2. **仕様書への反映**
- `notes/llvm-spec-status-survey.md` への追記
- 新規メモ作成: `notes/memory-management-evaluation.md`
- メモリモデルの文書化
- 将来計画の明示

8.3. **引き継ぎ資料**
- Phase 4 へのタスク引き継ぎ
- 未解決課題の整理
- 継続調査項目のリスト
- レビュー資料の保存

**成果物**: 完全な評価レポート、更新仕様書、引き継ぎ資料

## 成果物と検証
- RC ツールと GC PoC が CI で実行でき、測定データが `0-3-audit-and-metrics.md` に収集される。
- ベンチマーク結果が定量的に比較され、グラフ・表で可視化される。
- 評価レポートが公開され、採用方針（RC継続/GC導入/ハイブリッド）が決定・文書化される。
- リスクとフォローアップが `0-4-risk-handling.md` に登録され、Phase 4 計画に反映される。

## リスクとフォローアップ
- GC PoC の工数が大きい場合は対象範囲を最小限（Boehm GC のみ）にし、評価軸を明確化。
- RC ツールが未成熟の場合、Phase 4 以降での継続開発を計画し、現段階では測定精度の限界を明示。
- 意思決定が遅れると Phase 4 の移行スケジュールに影響するため、74週までに必ず決定。レビューのタイムラインを早期に設定（73週）。
- GC 導入を決定した場合、Phase 4 での本格実装のリソース確保が必要。実装計画を早期に立案。
- ハイブリッド手法を選択した場合、複雑性が増すため、明確な使い分け基準とテスト戦略を策定。

## 参考資料
- [3-0-phase3-self-host.md](3-0-phase3-self-host.md)
- [1-5-runtime-integration.md](1-5-runtime-integration.md)
- [3-5-runtime-capability-integration.md](3-5-runtime-capability-integration.md)
- [guides/llvm-integration-notes.md](../../guides/llvm-integration-notes.md)
- [notes/llvm-spec-status-survey.md](../../notes/llvm-spec-status-survey.md)
- [0-3-audit-and-metrics.md](0-3-audit-and-metrics.md)
- [0-4-risk-handling.md](0-4-risk-handling.md)
