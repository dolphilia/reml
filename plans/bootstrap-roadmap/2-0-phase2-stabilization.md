# 2.0 Phase 2 — 言語仕様の安定化

Phase 2 は OCaml 実装を用いて Reml 言語仕様の全体を検証し、MVP から正式仕様へ昇格させる工程である。型クラス・効果システム・診断メタデータなど `1-2`〜`1-3` および `3-6` に記述された要素を段階的に有効化し、パーサ/タイパ/ランタイムの仕様差異を解消する。

## 2.0.1 目的
- `1-2-types-Inference.md` に定義された型クラス制約・辞書渡し・局所型推論を OCaml 実装に反映し、セルフホスト移行前に挙動を固める。
- `1-3-effects-safety.md` の効果タグと `3-8-core-runtime-capability.md` の Stage 契約をパーサとタイプチェッカで検証し、`effect` 注釈と Capability Stage の相互整合を確立する。
- `3-6-core-diagnostics-audit.md` で定義された監査ログフォーマットを実装し、診断・監査パイプラインを安定化する。

## 2.0.2 スコープ境界
- **含む**: 型クラス/辞書渡し、代数的効果タグの静的検証、`RuntimeBridge` との Stage 整合、FFI 所有権契約の正式化、診断メタデータの出力。
- **含まない**: セルフホスト化、Reml 実装での再構築、JIT ターゲット・クロスコンパイル最適化。これらは Phase 3 以降で実施。
- **前提条件**: Phase 1 の成果物、`guides/llvm-integration-notes.md` の Phase 2 要件、`notes/llvm-spec-status-survey.md` で列挙された未決領域リスト。

## 2.0.3 成果物とマイルストーン
| マイルストーン | 内容 | 検証方法 | 期限目安 |
|----------------|------|----------|----------|
| M1: 型クラスサポート | 多相辞書の生成と渡しを実装し、`1-2` のサンプルを全通過 | 型推論テスト + LLVM IR での辞書引数検証 | Phase 2 開始後 6 週 |
| M2: 効果タグ検証 | `effect` アノテーションと `RuntimeCapability` の整合チェックを導入 | スタティックアナライザ + 実行時 Stage 検証テスト | 開始後 10 週 |
| M3: 診断監査基盤 | `Diagnostic` + `AuditEnvelope` 出力を仕様と同一形式で実装 | JSON スナップショットテスト + `3-6` のキー照合 | 開始後 14 週 |
| M4: 仕様レビュー完了 | Chapter 1〜3 の仕様サンプルを実行検証し、ギャップを解消 | 仕様レビュー記録（`0-3-audit-and-metrics.md`） | 開始後 18 週 |

## 2.0.4 実装タスク
1. **型クラスと辞書渡し**
   - コンパイラ IR に辞書引数を追加し、`1-2` の制約解決アルゴリズムを OCaml で実装。
   - LLVM IR で辞書構造体を生成し、`-target arm64-apple-macos12.0` 指定時に Mach-O シンボルが正しく解決されるよう関数シグネチャを整備する。
2. **効果システム統合**
   - `effect` 注釈を AST/TAST に保持し、Stage 要求 (`StageRequirement::{Exact, AtLeast}`) を型チェック時に検証。
   - ARM64 macOS の Capability 構成（Sandbox, NativeSystem, ObjectiveFFI 等）を `3-8` の Stage テーブルと照合し、実機テストで検証。
3. **FFI 契約の拡張**
   - `3-9-core-async-ffi-unsafe.md` の ABI/所有権表を OCaml 実装に反映し、`clang -target arm64-apple-macos12.0` でビルドしたブリッジコードを通じて RC 以外の借用が発生した場合は診断警告を出す。
   - FFI 呼び出しの追跡ログを `AuditEnvelope.metadata` に記録し、macOS 固有のフレームワーク呼び出し（`CoreFoundation` など）をサンプルに含める。
4. **診断・監査パイプライン**
   - `Diagnostic` に `extensions` フィールドを追加し、`effect.stage.*` や `bridge.stage.*` を出力。
   - 監査ログを JSON で出力し、`3-6` のキーセットに照合する自動テストを実装。Apple Silicon 上でのログ整形差異を吸収するテンプレートを用意。
5. **仕様差分の補正**
   - 仕様書の表記ゆれや不足項目をレビューし、必要に応じて Chapter 1〜3 を更新。
   - 更新した仕様には計画書から脚注リンクを追加し、`0-3-audit-and-metrics.md` に差分概要を記録。
6. **ARM64 macOS 向け最適化検証**
   - `llc -mtriple=arm64-apple-macos12.0 -mcpu=apple-m1` の出力をベンチマークし、辞書渡し導入後のコードサイズ・性能変化を観測。
   - Linux/SysV・Windows への展開計画は TODO として別途管理し、Phase 3 着手前に優先度を見直す。

## 2.0.5 測定と検証
- **性能トレンド**: Phase 1 と同じベンチマークを継続し、型クラス導入によるオーバーヘッドを定量化。
- **安全性**: 効果タグと Capability Stage のミスマッチが 0 件であることを CI で確認。
- **診断品質**: 代表的な型クラス失敗・Stage ミスマッチ・FFI 契約違反の診断をレビューし、仕様通りのメッセージが得られるかチェック。
- **ターゲット適合性**: ARM64 macOS 向けに生成した辞書引数付き LLVM IR が `lldb`/`otool -l` で検証可能なシンボル/セクション構造になっているかを確認。

## 2.0.6 リスクとフォローアップ
- **辞書膨張**: 多数の型クラス実装によるコードサイズ増を監視し、Phase 3 でモノモルフィゼーション最適化を検討。
- **効果タグと Capability のずれ**: 仕様更新と実装の差異が発生した場合、`0-4-risk-handling.md` に TODO を登録し、Phase 3 の着手条件に設定。
- **FFI 所有権**: 参照カウントのデバッグ支援ツールが不足しているため、Phase 3 でツール化タスクを追加予定。
- **ツールチェーン依存**: Apple Clang/LLVM のメジャーアップデートに追随できないリスクがあるため、`0-4-risk-handling.md` にサポート窓口とロールバック手順を記録。

---

Phase 2 の完了により、Reml 言語の正式仕様が OCaml 実装で追証され、セルフホスト化に向けた要件（型クラス、効果、診断）が安定化する。
