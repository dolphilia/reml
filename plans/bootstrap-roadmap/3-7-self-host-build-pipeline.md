# 3.7 セルフホストビルドパイプライン計画

## 目的
- Phase 3 マイルストーン M6 として、OCaml 実装 → Reml 実装 → Reml 自己ビルドの 3 段階 CI パイプラインを構築し、x86_64 Linux を中心にマルチターゲットで検証する。
- セルフホスト化の過程を自動化し、再帰ビルドの完全性を確認する。

## スコープ
- **含む**: 三段階ビルドフロー、成果物比較、マルチターゲット検証、再帰ビルドテスト、監査ログ。
- **含まない**: JIT、追加ターゲット (WASM 等) のビルド。必要に応じて別計画。
- **前提**: Reml Parser/TypeChecker/CodeGen/Runtime が完了し、クロスコンパイル機能が整備されている。

## 作業ブレークダウン
1. **ビルドシナリオ定義**: OCaml 実装から Reml コンパイラをビルドし、その Reml コンパイラで再度自身をビルドするフローを定義。
2. **CI ワークフロー構築**: GitHub Actions (Linux 中心) に三段階ジョブを設定し、必要なアーティファクトを受け渡し。
3. **マルチターゲット検証**: Phase 3 クロスコンパイルタスクと連携し、Linux/Windows/macOS 向けバイナリを生成。
4. **成果物比較**: 1 回目と 2 回目のビルド成果物を比較し、差分をレポート (`llvm-diff`, `cmp` 等)。
5. **監査ログ統合**: ビルド結果・メトリクスを `0-3-audit-and-metrics.md` にアップロードし、失敗時は `0-4-risk-handling.md` に自動記録。
6. **ドキュメント整備**: セルフホスト手順を `guides/llvm-integration-notes.md` または新規ガイドにまとめ、開発者が再現できるようにする。

## 成果物と検証
- CI でセルフホスト再帰ビルドが成功し、差分が許容範囲内であること。
- 主要ターゲットで生成されたバイナリがスモークテストを通過する。
- 手順書が整備され、新規開発者が追従可能な状態になる。

## リスクとフォローアップ
- CI 時間が長くなる場合は段階ごとにキャッシュを用意し、必要に応じて nightly ジョブに移管。
- 差分が解消しない場合はコンパイラ決定的性の改善タスクを立ち上げる。
- 監査ログが肥大化する恐れがあるため、サマリと詳細ログを分割し、保持ポリシーを策定。

## 参考資料
- [3-0-phase3-self-host.md](3-0-phase3-self-host.md)
- [guides/llvm-integration-notes.md](../../guides/llvm-integration-notes.md)
- [0-3-audit-and-metrics.md](0-3-audit-and-metrics.md)
- [0-4-risk-handling.md](0-4-risk-handling.md)

