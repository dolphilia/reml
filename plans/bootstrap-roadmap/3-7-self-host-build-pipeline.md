# 3.7 セルフホストビルドパイプライン計画

## 目的
- Phase 3 マイルストーン M6 として、OCaml 実装 → Reml 実装 → Reml 自己ビルドの 3 段階 CI パイプラインを構築し、x86_64 Linux を中心にマルチターゲットで検証する。
- セルフホスト化の過程を自動化し、再帰ビルドの完全性を確認する。

## スコープ
- **含む**: 三段階ビルドフロー、成果物比較、マルチターゲット検証、再帰ビルドテスト、監査ログ。
- **含まない**: JIT、追加ターゲット (WASM 等) のビルド。必要に応じて別計画。
- **前提**: Reml Parser/TypeChecker/CodeGen/Runtime が完了し、クロスコンパイル機能が整備されている。

## 作業ブレークダウン

### 1. ビルドシナリオ設計と定義（67-68週目）
**担当領域**: 3段階ビルドフロー

1.1. **ビルドステージ定義**
- Stage 0: OCaml 実装によるブートストラップコンパイラ (`remlc-ocaml`) のビルド
- Stage 1: Stage 0 で Reml ソースからコンパイラをビルド (`remlc-stage1`)
- Stage 2: Stage 1 で再度自身をビルド (`remlc-stage2`)、決定性検証用
- 各ステージの入力・出力・依存関係を明確化

1.2. **アーティファクト管理設計**
- ステージ間のアーティファクト受け渡し仕様（ディレクトリ構造、命名規則）
- キャッシュ戦略（ステージ 0 のビルド成果物を再利用）
- バージョン管理（Git commit hash を含むバージョン情報埋め込み）
- クリーンビルド vs インクリメンタルビルドの切り替え

1.3. **ビルドスクリプト作成**
- Makefile または Dune ベースのビルドスクリプト
- 各ステージの実行コマンドとオプション
- エラー時のフォールバック処理
- 並行ビルドの最適化（`-j` オプション等）

1.4. **ローカル検証環境**
- 開発者マシンでの 3 段階ビルド手順書
- 必要な環境変数・パス設定
- トラブルシューティングガイド
- 期待される実行時間とリソース使用量

**成果物**: ビルドフロー設計書、ビルドスクリプト、ローカル検証手順

### 2. CI/CD ワークフロー実装（68-69週目）
**担当領域**: GitHub Actions 統合

2.1. **GitHub Actions ジョブ設計**
- `build-stage0.yml`: OCaml 実装のビルド（x86_64 Linux メイン）
- `build-stage1.yml`: Stage 1 コンパイラのビルド
- `build-stage2.yml`: Stage 2 再帰ビルドと決定性検証
- ジョブ間の依存関係設定（`needs` ディレクティブ）

2.2. **アーティファクト受け渡し**
- GitHub Actions artifacts API の活用
- ステージ 0 → 1、ステージ 1 → 2 のアーティファクト転送
- 圧縮形式と展開処理
- アーティファクトの保持期間設定（7日間程度）

2.3. **キャッシュ戦略**
- OCaml 依存関係のキャッシュ（opam、Menhir）
- LLVM ツールチェーンのキャッシュ
- Reml 中間成果物のキャッシュ
- キャッシュ無効化の条件（Makefile、dune ファイル変更時）

2.4. **環境セットアップ自動化**
- Ubuntu ランナーでの LLVM インストール
- OCaml/opam のセットアップ
- Reml ランタイムライブラリのビルド
- タイムアウト設定（各ステージ 30-60 分）

**成果物**: GitHub Actions ワークフロー定義、CI 設定ドキュメント

### 3. マルチターゲット並行ビルド（69-70週目）
**担当領域**: クロスプラットフォーム対応

3.1. **ターゲット別 CI ジョブ**
- x86_64 Linux: メインターゲット、全ステージ実行
- Windows x64: クロスコンパイルまたは Windows ランナーでビルド
- ARM64 macOS: macOS ランナーでのネイティブビルド
- ターゲット別の並行実行設定（matrix strategy）

3.2. **クロスコンパイル対応**
- Phase 3-3 のクロスコンパイル機能を活用
- ターゲット指定フラグ（`--target=x86_64-linux`, `--target=x86_64-windows` 等）
- リンカ・ランタイムのターゲット別設定
- ABI 差分の検証（System V vs MSVC vs ARM64 ABI）

3.3. **ターゲット別テスト**
- 各ターゲットでの最小スモークテスト（Hello World、基本機能）
- ランタイムライブラリのリンク検証
- 実行可能バイナリの動作確認
- OS 固有機能のテスト（パス処理、環境変数等）

3.4. **ビルド成果物の集約**
- ターゲット別アーティファクトの命名規則
- 統合レポートの生成（全ターゲットのビルド結果）
- リリース用パッケージの準備
- チェックサム・署名の生成準備

**成果物**: マルチターゲット CI 設定、ターゲット別テストスイート

### 4. 決定性検証と成果物比較（70-71週目）
**担当領域**: ビルド再現性

4.1. **バイナリ比較ツール実装**
- Stage 1 と Stage 2 のバイナリを比較（`cmp`, `diff`）
- LLVM IR の構造的比較（`llvm-diff`）
- デバッグ情報の除外比較オプション（タイムスタンプ等を無視）
- 許容差分の定義（非決定的な部分の明示）

4.2. **差分レポート生成**
- 差分の自動分類（許容可能 vs 要調査）
- 詳細差分の可視化（バイト単位、行単位）
- 過去ビルドとの比較トレンド
- レポート形式（JSON、Markdown、HTML）

4.3. **決定性改善**
- 非決定的要素の特定（並行処理、ハッシュマップ順序等）
- ソースコード修正による決定性向上
- ビルドオプションの調整（`-fno-random-seed` 等）
- 決定性達成率の測定（目標: 99%以上）

4.4. **回帰検証**
- CI での自動比較実行
- 差分検出時のビルド失敗設定（閾値あり）
- 差分履歴の追跡
- `0-3-audit-and-metrics.md` への記録

**成果物**: 比較ツール、差分レポート生成システム、決定性検証

### 5. 性能・メトリクス計測（71-72週目）
**担当領域**: ベンチマークと監査

5.1. **ビルド時間計測**
- 各ステージのビルド時間測定
- ステージ間の比較（OCaml 実装 vs Reml 実装）
- 並行度別の計測（`-j1`, `-j4`, `-j8`）
- CI 環境での安定性評価

5.2. **リソース使用量プロファイリング**
- ピークメモリ使用量（各ステージ）
- ディスク I/O 量
- CPU 使用率の推移
- キャッシュヒット率

5.3. **コンパイラ性能測定**
- Stage 1/2 コンパイラでの標準ベンチマーク実行
- `samples/language-impl-comparison/` のコンパイル時間
- Phase 2 ベースラインとの比較（±10% 目標）
- 性能レグレッション検出

5.4. **メトリクス記録**
- `0-3-audit-and-metrics.md` への自動記録
- CI レポートの生成（表、グラフ）
- 週次トレンドの可視化
- 性能目標達成状況の追跡

**成果物**: 性能計測スクリプト、メトリクスレポート、監査ログ

### 6. 監査ログ統合と自動レポート（72-73週目）
**担当領域**: 品質保証インフラ

6.1. **ログ収集システム**
- 各ステージのビルドログ収集
- エラーログの構造化（JSON 形式）
- 警告・エラーの分類とカウント
- ログ保存とアーカイブ戦略

6.2. **失敗時の自動記録**
- ビルド失敗時の `0-4-risk-handling.md` への自動追記
- 失敗原因の自動分類（パース失敗、型エラー、リンクエラー等）
- 再現手順の自動生成
- 通知システム（Slack、Email 等）との連携

6.3. **成功時のメトリクス更新**
- `0-3-audit-and-metrics.md` の該当セクション更新
- ビルド成功率の記録
- 決定性達成率の更新
- 性能メトリクスの追記

6.4. **レポートダッシュボード**
- CI 実行結果のサマリ表示
- マルチターゲット一覧表
- トレンドグラフ（ビルド時間、成功率等）
- GitHub Pages または別途ホスティング

**成果物**: ログ収集システム、自動レポート生成、ダッシュボード

### 7. ドキュメント整備とナレッジ共有（73週目）
**担当領域**: 開発者支援

7.1. **セルフホスト手順書作成**
- `guides/self-host-build-guide.md`（新規作成）または `guides/llvm-integration-notes.md` への追記
- ローカル環境でのセルフホスト手順
- トラブルシューティング集
- FAQ（よくある質問と回答）

7.2. **CI 運用ガイド**
- GitHub Actions ワークフローの説明
- キャッシュ管理と無効化手順
- アーティファクトのダウンロードと検証
- 手動トリガーの方法

7.3. **アーキテクチャ文書**
- 3 段階ビルドの設計図（フローチャート）
- ステージ間のデータフロー
- 決定性検証の原理
- マルチターゲット対応の概要

7.4. **レビュー資料作成**
- M6 マイルストーン達成報告書
- ビルドパイプラインのデモ動画（オプション）
- Phase 4 への引き継ぎ事項
- 既知の制限事項と TODO リスト

**成果物**: セルフホスト手順書、CI 運用ガイド、アーキテクチャ文書、レビュー資料

### 8. 安定化とフィードバック反映（74週目）
**担当領域**: 品質向上

8.1. **統合テスト強化**
- 全ターゲットでのエンドツーエンドテスト
- ストレステスト（大規模ソースのビルド）
- 並行ビルドの安定性検証
- ネットワーク障害時のリトライ処理

8.2. **CI 最適化**
- ビルド時間の短縮（並行化、キャッシュ改善）
- リソース使用量の最適化
- 不要なステップの削除
- 依存関係の最小化

8.3. **フィードバック収集**
- Phase 3 他タスク（3-1〜3-6）からのフィードバック反映
- 開発者からの使用感ヒアリング
- 改善提案の取り込み
- `notes/llvm-spec-status-survey.md` への知見記録

8.4. **Phase 4 準備**
- Phase 4-1（互換性検証）への引き継ぎ資料作成
- Phase 4-2（リリースパイプライン）への要件伝達
- 未解決課題の `0-4-risk-handling.md` への記録
- 次フェーズへのスムーズな移行計画

**成果物**: 安定版 CI パイプライン、フィードバックレポート、Phase 4 引き継ぎ資料

## 成果物と検証
- CI でセルフホスト再帰ビルドが成功し、差分が許容範囲内であること。
- 主要ターゲットで生成されたバイナリがスモークテストを通過する。
- 手順書が整備され、新規開発者が追従可能な状態になる。

## リスクとフォローアップ
- CI 時間が長くなる場合は段階ごとにキャッシュを用意し、必要に応じて nightly ジョブに移管。
- 差分が解消しない場合はコンパイラ決定的性の改善タスクを立ち上げる。
- 監査ログが肥大化する恐れがあるため、サマリと詳細ログを分割し、保持ポリシーを策定。

## 参考資料
- [3-0-phase3-self-host.md](3-0-phase3-self-host.md)
- [guides/llvm-integration-notes.md](../../guides/llvm-integration-notes.md)
- [0-3-audit-and-metrics.md](0-3-audit-and-metrics.md)
- [0-4-risk-handling.md](0-4-risk-handling.md)

