# 1.6 開発者体験整備計画

## 目的
- `remlc-ocaml` CLI を Phase 1 で整備し、開発者が解析結果・IR・診断を観測できる開発体験を提供する。
- `3-6-core-diagnostics-audit.md` のフィールド定義に従い、出力フォーマットを将来のセルフホスト版と一致させる。

## スコープ
- **含む**: CLI インタフェース設計、サブコマンド実装、出力フォーマット整備、診断メッセージの国際化方針（日本語 + 原語併記）、ドキュメント整備。
- **含まない**: GUI、LSP サーバ、IDE プラグイン。これらは Phase 2 以降に計画。
- **前提**: Parser/TypeChecker/Core IR/LLVM が CLI から呼び出せる状態であること。

## 作業ブレークダウン

### 1. CLIアーキテクチャ設計（9-13週目並行）
**担当領域**: コマンドラインインタフェース基盤

1.1. **エントリポイント設計**
- `remlc-ocaml` メインモジュールの作成
- コマンドライン引数パーサ（`Cmdliner` または手動実装）
- サブコマンド構造の検討（`compile`, `check`, `emit` 等）

1.2. **オプション体系設計**
- 入力: `<file.reml>` または stdin (`-`)
- 出力制御: `--emit-ast`, `--emit-tast`, `--emit-core`, `--emit-ir`
- コンパイルオプション: `-O0`/`-O1`, `--target`, `--link-runtime`
- 診断オプション: `--trace`, `--verbose`, `--color=auto|always|never`
- 出力先: `--out-dir`, `--out-file`

1.3. **設定ファイル対応**
- `reml.toml` 形式の検討（Phase 2で本格化）
- CLI優先度の明確化（CLI > 設定ファイル > デフォルト）

**成果物**: `cli/main.ml`, CLI設計ドキュメント

### 2. パイプライン統合（13-14週目）
**担当領域**: コンパイルフロー統合

2.1. **フェーズオーケストレーション**
- Parser → Typer → Core IR → LLVM の順次実行
- 各フェーズの入出力整合性チェック
- エラー時の早期終了と診断出力

2.2. **中間生成物の管理**
- `--emit-*` 時のファイル出力処理
- 一時ディレクトリの管理と削除
- デバッグモードでの中間ファイル保持

2.3. **並行処理準備**
- 複数ファイル入力の対応（Phase 2で本格化）
- 依存解析の基礎設計

**成果物**: `cli/pipeline.ml`, パイプライン統合

### 3. 診断出力システム（14週目）
**担当領域**: エラー・警告の表示

3.1. **Diagnostic構造体実装**
- `3-6-core-diagnostics-audit.md` 準拠のフィールド定義
- Span情報との統合
- 重大度レベル（error, warning, info, hint）

3.2. **テキスト出力フォーマット**
- ソースコードスニペット表示（前後2行）
- カラーコード対応（エラー=赤、警告=黄等）
- ポインタ表示（`^^^` での位置指示）
- 日本語メッセージ + 英語キーワード併記

3.3. **JSON出力フォーマット**
- JSONスキーマ定義（`diagnostic_schema.json`）
- 機械判読可能な構造化出力
- LSP互換性の準備（Phase 2）

**成果物**: `cli/diagnostic.ml`, 診断出力実装

### 4. トレース・ログ機能（14-15週目）
**担当領域**: デバッグ支援とオブザーバビリティ

4.1. **`--trace` 実装**
- 各フェーズの開始・終了ログ
- 時間計測（経過時間、累積時間）
- メモリ使用量スナップショット

4.2. **ログレベル管理**
- `--verbose` レベルの段階設定（0-3）
- デバッグ情報の選択的出力
- 環境変数での制御（`REMLC_LOG=debug`）

4.3. **統計情報収集**
- パースしたトークン数、AST ノード数
- 型推論のunify呼び出し回数
- 最適化パスの適用回数
- 生成されたLLVM IR命令数

**成果物**: `cli/trace.ml`, トレース機能

### 5. 統計サマリ出力（15週目）
**担当領域**: パフォーマンス可視化

5.1. **時間計測**
- 各フェーズの実行時間内訳
- 合計コンパイル時間
- パーセンテージ表示（どのフェーズが遅いか）

5.2. **メモリ使用量**
- プロセスメモリ使用量のサンプリング
- ピークメモリの記録
- GC統計（OCaml GC）

5.3. **メトリクス出力**
- `--metrics` フラグで詳細統計を表示
- `0-3-audit-and-metrics.md` 形式への書き出し
- CSV/JSON形式でのエクスポート

**成果物**: `cli/metrics.ml`, メトリクス機能

### 6. ヘルプ・ドキュメント生成（15週目）
**担当領域**: ユーザー支援

6.1. **`--help` 実装**
- サブコマンド別のヘルプ表示
- オプション一覧と説明
- 使用例の表示

6.2. **manページ生成**
- `remlc-ocaml.1` マニュアルページの作成
- インストール時の配置（`/usr/local/share/man`）

6.3. **ユーザーガイド作成**
- `guides/cli-usage.md`（仮）の作成
- 基本的なワークフロー例
- トラブルシューティングガイド

**成果物**: ヘルプシステム、ユーザーガイド

### 7. サンプルプロジェクト整備（15-16週目）
**担当領域**: 実践的な使用例

7.1. **サンプルコード拡充**
- `samples/language-impl-comparison/` への追加例
- Hello World からの段階的サンプル
- エラーケースの例

7.2. **ワークフロー実演**
- CLI を用いたコンパイル手順の README 追加
- 各 `--emit-*` オプションの出力例
- CI での実行例

7.3. **ベンチマークスイート準備**
- パフォーマンス計測用のサンプルセット
- 回帰テストの基準値設定

**成果物**: 拡充されたサンプル、ワークフロードキュメント

### 8. CI統合とテスト（16週目）
**担当領域**: CLI品質保証

8.1. **CLI統合テスト**
- 各オプションの動作検証
- エラー時の正しい終了コード確認
- 出力フォーマットの検証（テキスト、JSON）

8.2. **スモークテスト**
- 基本的なコンパイルフローの自動テスト
- `--emit-*` オプション全パターンの検証
- CI での定期実行

8.3. **ドキュメント整備**
- CLI アーキテクチャの技術文書
- 診断システムの設計解説
- Phase 2への引き継ぎ（LSP、設定ファイル）

**成果物**: 完全なCLIテストスイート、技術文書

## 成果物と検証
- CLI コマンドが `dune exec remlc-ocaml -- --help` で利用可能になり、各オプションが CI のスモークテストで網羅される。
- `Diagnostic` JSON のスキーマを `jsonschema` 形式で管理し、CI で検証。
- ドキュメント (`guides/llvm-integration-notes.md` または新規ガイド) に CLI 利用手順が掲載される。

## リスクとフォローアップ
- 出力フォーマットの変更がフェーズ間で発生しやすいため、バージョンタグを付与し後方互換性を `0-4-risk-handling.md` で管理。
- CLI のオプションが増えすぎると UX が低下するため、Phase 2 で LSP 計画へ引き継ぎ、現段階では観測用途に絞る。
- 多言語対応は Phase 4 のエコシステム移行で本格化するため、日本語テキストに英語キーワードを括弧書きで併記する程度に留める。

## 参考資料
- [1-0-phase1-bootstrap.md](1-0-phase1-bootstrap.md)
- [3-6-core-diagnostics-audit.md](../../3-6-core-diagnostics-audit.md)
- [0-3-audit-and-metrics.md](0-3-audit-and-metrics.md)
- [guides/llvm-integration-notes.md](../../guides/llvm-integration-notes.md)

