# 4.0 Phase 4 — 移行完了と運用体制

Phase 4 は Reml セルフホスト実装を正式版として採用し、OCaml 実装を段階的にリタイアする段階である。互換性確認、リリース体制、エコシステム支援を整え、Reml 開発者コミュニティがセルフホスト版を前提に活動できるようにする。

## 4.0.1 目的
- Reml セルフホスト実装の出力が OCaml 実装と機能的に一致することを証明し、正式なリリースパイプラインへ組み込む。
- `5-3-developer-toolchain.md` に沿ったツールチェーン整備（パッケージ管理、CI/CD、診断集計）を完了させる。
- OCaml 実装は移行期間中の LTS として維持し、後方互換チェックリストを通過後にアーカイブする。

## 4.0.2 スコープ境界
- **含む**: 出力一致検証、ローリングリリース戦略、ドキュメント更新、エコシステム（パッケージ、プラグイン、CI テンプレート）への周知。
- **含まない**: 新ターゲット（ARM64/WASM）の正式サポート、JIT/最適化高度化。これらは別計画または次期フェーズへ引き継ぐ。
- **前提条件**: Phase 3 のセルフホスト成果、`0-3-audit-and-metrics.md` での性能/診断ベンチマーク、`0-4-risk-handling.md` の未解決リスク一覧。

## 4.0.3 成果物とマイルストーン
| マイルストーン | 内容 | 検証方法 | 期限目安 |
|----------------|------|----------|----------|
| M1: 出力一致サインオフ | LLVM IR / バイナリ / 診断の差分が承認閾値内に収束 | 自動差分レポート + レビュア承認記録 | Phase 4 開始後 6 週 |
| M2: リリースパイプライン | セルフホスト実装を CI/CD に組み込み、署名付き成果物を配布 | CI 成果物レビュー、署名確認 | 開始後 10 週 |
| M3: エコシステム移行 | パッケージマネージャ、プラグイン、ガイドをセルフホスト前提に更新 | `README.md` / ガイド更新、コミュニティ告知 | 開始後 14 週 |
| M4: OCaml 実装アーカイブ | LTS ブランチ化とサポート終了アナウンス、移行ガイド公開 | `guides/` 追加資料、リスク確認 | 開始後 18 週 |

## 4.0.4 実装タスク
1. **互換性検証**
   - LLVM IR の構造差分（関数単位）を比較し、差分がある場合は `notes/llvm-spec-status-survey.md` の未決項目に照らして承認または修正。
   - ARM64 macOS (Mach-O) 成果物を基準にし、`llvm-diff` と `dwarfdump` でデバッグ情報・シンボル整合を確認する。
   - 診断メッセージの差分を比較し、`3-6-core-diagnostics-audit.md` のキーセットに準拠するか確認。
2. **リリースパイプライン構築**
   - `5-3-developer-toolchain.md` の手順に従い、ビルド→テスト→署名→配布までを自動化。
   - Apple Silicon 向けの `codesign`/`notarytool` フローと `pkgbuild` または `tar.xz` の成果物生成を標準化し、Linux/Windows 用アーティファクトは後続の拡張として扱う。
   - 公式リリースノートフォーマット（`5-5-roadmap-metrics.md` 参照）でセルフホスト移行の進捗を報告。
3. **ドキュメント更新**
   - `README.md` と `0-0-overview.md` にセルフホスト完了と Apple Silicon 版が正規版である旨を追記。
   - `guides/llvm-integration-notes.md` をアップデートし、Phase 4 以降の拡張計画を付録化。
4. **エコシステム整備**
   - パッケージレジストリ (`5-2-registry-distribution.md`) にセルフホスト版を登録し、ARM64 macOS 用バイナリを優先配信。OCaml 版を非推奨マーク。
   - プラグイン開発ガイド (`guides/DSL-plugin.md`) をセルフホスト ABI 前提に更新し、Apple Silicon を基準環境として例示。
5. **サポートポリシー策定**
   - OCaml 実装の LTS 期間・サポート終了日・更新フローを `0-4-risk-handling.md` に記録し、コミュニティへ周知。
   - 将来の Linux/Windows 対応計画を別添ロードマップとして整理し、ARM64 macOS 優先方針との整合を明示する。

## 4.0.5 測定と検証
- **性能リグレッション**: Phase 3 のベースラインと比較して ±5% 以内を目標とする。超過時は緩和策を `0-4-risk-handling.md` へ登録。
- **Stage/Capability**: すべての Stage 要件が `Stable` 以上に昇格し、監査ログにミスマッチが無いことを確認。
- **診断整合**: 主要エラーケースでのメッセージ差分がゼロ、またはレビュア承認済みの改善のみであること。
- **リリース検証**: Apple Notary Service での notarization (`notarytool submit --wait`) をパスし、署名付き成果物が Gatekeeper で問題無く実行できること。

## 4.0.6 リスクとフォローアップ
- **エコシステム乗り換え遅延**: サードパーティが移行に遅延した場合に備え、OCaml 実装のセキュリティパッチ計画を用意。
- **ツール互換性**: 既存 IDE/CI 連携が想定と異なる場合は、ガイドにトラブルシュートを追加し、`notes/` に TODO ノートを残す。
- **人員負荷**: 移行期のレビュー負荷が高いため、レビュアの割当と休日計画を `0-3-audit-and-metrics.md` のレビュー欄で可視化する。
- **Notary 失敗**: Apple notarization で拒否された場合に備え、修正フローとリトライ SLA を `0-4-risk-handling.md` に明記する。

---

Phase 4 の完了により、Reml プロジェクトはセルフホスト実装を正式な開発基盤として採用し、以降の最適化・ターゲット拡張・エコシステム成長にフォーカスできる体制が整う。
