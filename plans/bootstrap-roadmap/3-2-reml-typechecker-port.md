# 3.2 Reml TypeChecker 再実装計画

## 目的
- Phase 3 マイルストーン M2 を達成するため、OCaml の Typer を Reml で再実装し、型クラス・効果・Stage 判定を Reml コードで再現する。
- 辞書渡し/モノモルフィゼーションの最終方針を反映し、セルフホスト環境での型推論性能を Phase 2 ベースライン ±10% に収める。

## スコープ
- **含む**: 型表現の移植、一般化/インスタンス化、型クラス解決、効果タグ検証、診断整合、計測フック。
- **含まない**: 将来拡張予定の型システム（依存型等）、メタプログラミング向け API。必要であれば Phase 4 以降。
- **前提**: Phase 2 の実装で型クラス方式が決定し、効果システム統合が安定していること。

## 作業ブレークダウン
1. **型表現ポート**: Reml の代数的データ型で Type/TypeScheme/Constraint を表現し、OCaml 版と互換のシリアライズを提供。
2. **推論エンジン移植**: Unifier・一般化・制約解決を Reml で実装し、辞書生成またはモノモルフィゼーションを反映。
3. **効果タグ統合**: 効果・Stage 判定を Reml 版 Typer に移植し、共通モジュール化。
4. **診断整合**: `Diagnostic` 出力を OCaml 版と比較し、差分レポートを自動生成。
5. **性能計測**: 推論ステップ・辞書生成時間を計測し、`0-3-audit-and-metrics.md` に掲載。
6. **移行フラグ**: CLI で `--typer=reml|ocaml` を切り替えられるようにし、並行検証期間を確保。

## 成果物と検証
- 型推論テストが Reml 実装で全て通過し、OCaml 版との差分が把握されている。
- 診断メッセージが整合し、差異がある場合は仕様更新またはフォローアップタスクが登録される。
- パフォーマンス計測がベースライン範囲内で、改善が必要な場合は TODO を `0-4-risk-handling.md` に記録。

## リスクとフォローアップ
- Reml 実装のパフォーマンスが劣る場合のフォールバックとして OCaml 版を維持し、最適化計画を別途策定。
- 効果システムとの相互作用にバグが出た場合、`3-2` と `3-5` のタスク間で調整しながら修正。
- 型クラス方式の決定が遅れると着手が遅延するため、Phase 2 の評価結果を早期に反映する。

## 参考資料
- [3-0-phase3-self-host.md](3-0-phase3-self-host.md)
- [1-2-types-Inference.md](../../1-2-types-Inference.md)
- [1-3-effects-safety.md](../../1-3-effects-safety.md)
- [0-3-audit-and-metrics.md](0-3-audit-and-metrics.md)
- [0-4-risk-handling.md](0-4-risk-handling.md)

