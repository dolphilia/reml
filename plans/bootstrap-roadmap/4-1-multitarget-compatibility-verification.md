# 4.1 マルチターゲット互換性検証計画

## 目的
- Phase 4 マイルストーン M1 を達成するため、x86_64 Linux/Windows/ARM64 macOS の 3 ターゲットで LLVM IR・バイナリ・診断の差分を検証し、承認閾値内に収束させる。
- リリース前の最終互換性チェックリストを運用し、OCaml 実装からの移行リスクを解消する。

## スコープ
- **含む**: 差分比較ツール整備、ターゲット別成果物の収集、診断メッセージ比較、レビュー手順、ログ記録。
- **含まない**: 新規ターゲットの追加、JIT。必要に応じて別計画。
- **前提**: Phase 3 でセルフホストビルドが成功し、マルチターゲット成果物が生成できること。

## 作業ブレークダウン
1. **比較基準定義**: `notes/llvm-spec-status-survey.md` の未決項目を参照し、許容差分リストを確定。
2. **差分ツール強化**: `llvm-diff`, `dwarfdump`, `cmp` などのツールを組み合わせ、自動レポート生成を実装。
3. **診断比較**: CLI 診断をターゲット別に収集し、`3-6-core-diagnostics-audit.md` のキーで照合。
4. **レビュー運用**: レポートをレビュアに配布し、承認プロセスを `0-3-audit-and-metrics.md` に記録。
5. **記録保存**: 差分承認/却下理由を `0-4-risk-handling.md` に残し、後続フェーズの参照に備える。
6. **フォローアップ**: 承認閾値を超える差分があれば修正タスクを起票し、リリース前に解消。

## 成果物と検証
- 3 ターゲットそれぞれで差分レポートが生成され、レビュア承認済みであること。
- 診断メッセージの差分がゼロ、もしくは承認済み改善のみであること。
- 記録が `0-3-audit-and-metrics.md` / `0-4-risk-handling.md` に残されていること。

## リスクとフォローアップ
- 比較ツールの出力が煩雑な場合、サマリを自動生成しレビュー効率を高める。
- ターゲット固有の問題が未解決の場合、リリーススケジュールに影響するため優先修正。
- デバッグ情報差分は許容範囲を明示的に定義し、将来の拡張 (DWARF バージョン差等) に備える。

## 参考資料
- [4-0-phase4-migration.md](4-0-phase4-migration.md)
- [3-6-core-diagnostics-audit.md](../../3-6-core-diagnostics-audit.md)
- [notes/llvm-spec-status-survey.md](../../notes/llvm-spec-status-survey.md)
- [0-3-audit-and-metrics.md](0-3-audit-and-metrics.md)
- [0-4-risk-handling.md](0-4-risk-handling.md)

