# Reml 標準API向けGC検討ノート

## 1. Remlの前提とメモリ管理方針
- Remlはパーサーコンビネーター処理系を最短距離で構築することを目的とし、小さく強いコアと宣言的操作性を重視する `0-1-overview.md:3` `0-2-project-purpose.md:19`
- MVP段階ではプリミティブ中心でGC不要、クロージャや文字列など本格実装では参照カウント(RC)を基盤とする `0-1-overview.md:191` `a-jit.md:148`
- 効果システムは外界への作用を5種類の効果で管理し、GCは純粋性を損なわない内部実装として扱える `1-3-effects-safety.md:8`

## 2. 標準APIにGC拡張を含める妥当性
- 現行仕様はRCを暗黙の既定とするが、GC不要な処理系にも影響しないオプトイン設計が可能
- Core APIにヒープ管理Capabilityを導入することで、RC/GC/リージョンなど多様な実装を差し替えられる
- RunConfigや設定DSLからGCの停止時間・メモリ上限を宣言的に制御できれば、Remlの「宣言で終わらせる」哲学と整合
- Packrat/ストリーミングのゼロコピー設計を保つには、アロケータとルート列挙ポイントを明示した抽象化が必要

## 3. 想定シナリオから見るGCニーズ
- ゲームエンジン向けスクリプト: ホットリロードと即時差分反映のため停止時間を抑えたGCが望ましい `scenario-requirements.md:21`
- IDE/ツール拡張: 編集中の継続解析を阻害しないインクリメンタルGCが有効 `scenario-requirements.md:56`
- Web/ORM DSL: 短命オブジェクトと長命データが混在し、世代別GCやリージョン戦略が適合 `scenario-requirements.md:88`
- データ/クラウドDSL: 一括処理やフェーズごとのリソース解放が求められ、リージョンや段階的回収の仕組みが有効 `scenario-requirements.md:250`

## 4. Remlに適合し得るGC方式
1. **世代別コピー + マークスイープ**
   - 特徴: 短命オブジェクトに強く、長命領域はマークスイープ
   - 適用: Web DSL、テンプレート、ORMでの大量再生成
   - 必要API: 書き込みバリア、若年領域アロケータ設定
2. **インクリメンタル三色マーク**
   - 特徴: 停止時間を分割してシステム応答性を確保
   - 適用: ホットリロードやIDE編集ループ
   - 必要API: Mutator/Collector協調フック、スケジューリング制御
3. **参照カウント + 循環検知**
   - 特徴: 決定的解放と低停止時間、循環を周期的に回収
   - 適用: RC基盤を維持したい安全志向シナリオ
   - 必要API: cycle detectorトリガ、オブジェクトグラフ列挙
4. **リージョン/アリーナ型GC**
   - 特徴: スコープ単位で一括破棄、フェーズ処理に適合
   - 適用: データパイプライン、クラウドIaC、バッチ処理
   - 必要API: リージョン生成/破棄、関連リソースのトラッキング
5. **並列/並行GC (オプション)**
   - 特徴: マルチスレッド環境でGCを並列化
   - 適用: 将来的な並列DSLやクラウド運用
   - 必要API: Stop-the-world制御、スレッドローカルルート登録

## 5. 標準API設計に向けた検討課題
- GC Capabilityインターフェイス設計: Root列挙、割り当て、バリア、統計取得
- RunConfig拡張: GCポリシー選択、ヒープ上限、停止時間ターゲット等の宣言的指定
- 効果システムとの整合: GC操作を`@pure`の範囲に収めつつ、プロファイルや監視を安全に公開
- Packrat/ストリーミングとの連携: メモテーブルの寿命管理とGCトリガ調整

## 6. 推奨アクション
1. Core.Runtime(仮)にGC Capability案を草案化し、標準APIへの追加インターフェイスを検討
2. 世代別・インクリメンタル・RC+循環検知の3方式でPoCを作成し、停止時間/スループット/メモリ使用を比較
3. RunConfig/設定DSLへGC設定項目を追加する設計案を起草し、シナリオ要求に照らしてレビュー
4. 代表的シナリオ（ゲーム、IDE、Web、データ）ごとのGC推奨プロファイルをまとめる
5. 仕様書への反映範囲を整理し、該当セクション（2-1, 2-6, guides/runtime-bridges.md 等）に追記計画を立案

## 7. 参考資料
- `0-1-overview.md`
- `0-2-project-purpose.md`
- `1-3-effects-safety.md`
- `a-jit.md`
- `scenario-requirements.md`
