# Algebraic Effects/Handlers 導入検討メモ

## 1. 現状の効果システム（Reml 1.x 設計）

- **タグ集合ベース**: 関数・式に対し効果タグ集合 `Σ`（コア: `mut`, `io`, `ffi`, `panic`, `unsafe` 等／システム拡張: `syscall`, `process`, `io.async` など）を付与し、`effects(expr)` を静的に集計【1-3-effects-safety.md:11-33】。
- **純粋デフォルトと値制限**: 関数はデフォルト純粋。本文でタグが検出された場合のみ潜在効果を保持し、`@pure`/`@no_panic` など属性で包含チェックを実施【1-3-effects-safety.md:41-64】【1-3-effects-safety.md:201-232】。
- **型システムとの関係**: HM 系推論（サブタイピング無し、ランク1多相）では効果は型へ織り込まれず、一般化抑制と契約検査の補助情報として扱う【1-2-types-Inference.md:119】【1-3-effects-safety.md:213-224】。
- **DSL との統合**: `@dsl_export` 属性で効果許容集合を明示、Capability Registry と照合して DSL の安全境界を管理する【1-1-syntax.md:84-101】【1-3-effects-safety.md:226-236】。

## 2. Algebraic Effects/Handlers の最新動向

- **研究と実装例**:
  - Koka 2.x（Daan Leijen）: マルチショットハンドラ、行多相効果、最適化済み実装（2024 年版論文「A Unified Theory of Effects」など）。
  - Eff 3.x, Links, Multicore OCaml: 整合性検証済みのハンドラ実装、継続捕捉コストやスレッド連携の実測。
  - OCaml 5 系: `effect`/`perform` と軽量ハンドラ、マルチコア環境でのステーブル化。
- **応用事例**:
  - 監査・ログの注入、async/await のモデリング、エラー回復 DSL、トランザクション／リトライ制御。
  - IDE 診断でのトレース集約、解析器内部でのバックトラック制御にも応用可能（学術例: Links のストリーム処理、Koka のマルチモーダル I/O）。

## 3. Reml に導入する際のメリット

1. **効果の局所化と純粋性維持**
   - ハンドラで `io`/`panic` 等をローカルに処理し、外向けシグネチャは純粋を維持→ `@pure`/`@dsl_export` 契約と両立。
2. **DSL エコシステムの拡張性**
   - Capability Registry と連動し、ハンドラで許可済み効果のみ露出する DSL を構築。監査ログや診断の注入が宣言的に。
3. **エラー品質と診断強化**
   - 効果発生位置でハンドラが補足し、エラー整形・復旧戦略を DSL 側で差し替え可能。
4. **非同期・並行機能の統一的モデリング**
   - `io.async`/`io.timer` などサブ効果をハンドラで実装し、同期 API を非同期ランタイムにリフト可能。
5. **テスト容易性**
   - モックハンドラで外部効果を差し替え、DSL 単体テストの純粋性を保ったまま動作検証。

## 4. 想定される課題・リスク

### 4.1 型システムへの影響
- HM 型推論へ行多相効果を組み込む必要があり、Algorithm W の拡張、一般化抑制、辞書パッシングの再設計が必須。
- 効果多相をどの程度許容するか（ランク制限、有界多相等）を明確化しないと推論が爆発する恐れ。

### 4.2 属性・契約システムとの整合
- `@pure`/`@no_panic` 等の既存属性はタグ包含で判定しており、ハンドラで効果を消費するケースをどう扱うか仕様再策定が必要。
- `@dsl_export(allows_effects=...)` と Capability Registry の合成ロジックを「ハンドラ適用後の残余効果」で評価できるよう再構成する必要がある。

### 4.3 実装コストとランタイム整合
- ハンドラの実行モデル（マルチショット vs ワンショット、継続再開のコスト）を Core.Async や FFI と整合させる必要。
- Packrat/左再帰パーサなどスタック重視のランタイムで継続保存をどう効率化するかが課題。

### 4.4 診断・デバッグの複雑化
- 効果がハンドラで複数段階に処理されるため、診断ログや `SpanTrace` にどの段階を表示するかポリシーが増える。
- IDE/LSP 連携でハンドラ境界を視覚化する新たな UI 仕様が必要になる可能性。

### 4.5 学習コスト・ドキュメント刷新
- DSL 開発者向け手引き（`guides/DSL-plugin.md` 等）を効果ハンドラ前提で更新する必要。
- 学習曲線を抑えるため、段階的導入（opt-in モジュール、実験フラグ）が望ましい。

## 5. 導入ロードマップ（提案）

1. **調査フェーズ**
   - Koka/OCaml の効果型推論を調査し、Reml の HM 実装とのギャップを洗い出す。
   - 既存 DSL ケースで必要となる効果種別を整理（監査、診断、async など）。
2. **MVP（実験フラグ）**
   - `effect`/`handle` 構文（試験的）と、行多相を標準ライブラリ側で限定サポート。
   - 型システムでは明示アノテーション必須（推論は行わず）とし、ハンドラ適用後の残余効果をタグ計算へ反映。
3. **正式統合**
   - HM + 効果行推論を実装、`@pure` 契約と Capability 統合を再定義。
   - Core.Async などランタイム API をハンドラベースへリファクタ。
4. **ドキュメント・ツール整備**
   - DSL ガイド、LSP/IDE 連携、診断仕様、テストツールを更新。

## 6. 推奨アクション

- 最新研究・実装動向のウォッチ: Koka/OCaml/Eff の開発ログを継続的に追う。
- 内部 PoC: `io` と `panic` のみを対象にしたハンドラ実験をサンドボックスで実装し、純粋関数との相互運用を検証。
- ガバナンス面の準備: Capability Registry のモデルをハンドラ対応に拡張する仕様草案を Chapter 3.8 に追加検討。

---

*更新履歴*
- 2024-XX-YY: 初版（Algebraic Effects/Handlers 導入検討メモ作成）
