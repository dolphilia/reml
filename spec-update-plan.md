# Kestrel 仕様更新計画（改訂版）

本計画は `scenario-priorities.md` で抽出した横断テーマを、既存仕様書へ反映するための段階的なアップデート方針を示す。優先度の高い領域から着手し、コア言語→標準API→エコシステム文書の順で整備を進める。

---

## フェーズ0: 現状棚卸し（1 週間）
**目的**: 既存仕様で不足している箇所を確認し、後続作業の前提を揃える。

- `1-1-syntax.md` / `1-2-types-Inference.md` / `1-3-effects-safety.md`: 宣言的スキーマ、拡張型、追加効果の空白を確認。
- `2-1`〜`2-6`: プラグイン API、エラー診断、ランタイム連携の未整備項目を洗い出し。
- `scenario-requirements.md`: 対応状況メモ欄を仮置きし、進捗トラッキングの準備。
- **成果物**: `notes/phase0-gap-analysis.md`

---

## フェーズ1: コア言語仕様の拡張ドラフト（優先度: 高、期間目安: 2 週間）
**狙い**: 型安全な宣言 DSL、型拡張、効果体系の強化を先行して定義し、後続の標準API整備を支える。

- `1-1-syntax.md`
  - スキーマ宣言文法、条件付き束縛、モジュール/プラグイン構文を追加。
- `1-2-types-Inference.md`
  - テンソル型、列型、スキーマ型、リソースIDなどドメイン型の導入。
  - 効果推論と型の結び付け（クラウド操作、リアルタイム制約等）。
- `1-3-effects-safety.md`
  - `audit` / `debug` / `runtime` など新効果、FFI 境界の詳細ガイド。
  - ホットリロード・差分適用時の安全規範。

成果物: 改訂ドラフト + レビュー用コメント。

---

## フェーズ2: 標準 API 章の拡充（優先度: 高、期間目安: 3 週間）
**狙い**: コア言語の拡張を受け、実務の DSL を支える標準ライブラリを整備する。

- `2-5-error.md`
  - 監査メタデータ、FixIt パターンテンプレート、エラーカテゴリ分類の追加。
- `2-6-execution-strategy.md`
  - LSP/IDE メタデータ出力、構造化ログ、ホットリロード API の節を追加。
- 新章 `2-7 Nest.Config`
  - スキーマ宣言、差分比較、テンプレート展開、条件付き設定の API。
- 新章 `2-8 Nest.Data`（仮称）
  - データモデル/スキーマ検証/型変換ユーティリティ。
- `2-1` / `2-2`
  - DSL プラグイン登録、Parser capability、バージョン互換ポリシーを追記。

成果物: 新旧差分、サンプルコード、仕様メモ。

---

## フェーズ3: エコシステム文書・ガイド整備（優先度: 中、期間目安: 2 週間）
**狙い**: 仕様を運用に展開できるよう、ツール連携や運用ガイドを整備。

- 新規ガイド
  - `guides/lsp-integration.md`: LSP/IDE 連携とメタデータ仕様。
  - `guides/config-cli.md`: 設定検証 CLI・CI/CD 組み込み手順。
  - `guides/runtime-bridges.md`: FFI/ランタイム統合、ホットリロードの運用。
- `README.md` / `0-1-overview.md`
  - 横断テーマを公式な柱として追加。
  - 新章・ガイドへのリンク、ツール整備の方向性を追記。

成果物: ガイド文書、トップレベル文書の更新。

---

## フェーズ4: レビュー & トラッキング（優先度: 中、期間: 継続）
**狙い**: シナリオ別の観点からレビューし、対応状況を可視化する。

- `scenario-requirements.md` 末尾にチェックリストを追加し、対応済み項目に ✅ を付与。
- シナリオオーナー（Web / Cloud / Data / IDE / ML / Network / Embedded）を割り当て、各フェーズのレビューを記録。
- フィードバックを `spec-update-plan.md` に反映し、必要に応じて再計画。

---

## 推奨タイムライン（調整済み）
| フェーズ | 期間 (目安) | 主なアウトプット | 備考 |
| --- | --- | --- | --- |
| 0 | 1 週間 | 現状棚卸しメモ | 着手前の共通理解形成 |
| 1 | 2 週間 | `1-*` 章ドラフト | 指針の柱となるため優先度高 |
| 2 | 3 週間 | `2-*` 章ドラフト & 新章 | コアと密接に連動、工数多め |
| 3 | 2 週間 | ガイド/README 更新 | 仕様反映後すぐに着手可能 |
| 4 | 継続 | レビュー記録、進捗管理 | フェーズ並走で実施 |

---

## 今後の進め方
1. フェーズ0完了後、フェーズ1ドラフト作成を開始（優先順位 A）。
2. フェーズ1レビューのフィードバックを組み込みながら、並行してフェーズ2の骨子に着手（優先順位 A）。
3. フェーズ2で追加された API に合わせてフェーズ3のドキュメント化を進行（優先順位 B）。
4. 全フェーズを通じてフェーズ4のチェックリスト・レビュー記録を更新し、`scenario-requirements.md` と相互参照する。

このロードマップに従い、Kestrel の横断的な拡張領域を順序立てて仕様やガイドに反映していく。
