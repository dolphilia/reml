# Reml 改善注目マトリクス

この資料は `samples/language-impl-comparison/` に含まれる既存サンプルの観点から、Reml 仕様で重点的に補強すべき領域を整理したものです。比較対象言語や実装予定リストを踏まえ、仕様書の該当章を参照しながら改善タスクの優先度付けに利用できます。

| 観点 | 参考実装/根拠 | Reml 現状から読み取れるポイント | 仕様改善に向けた着眼点 | 関連章 | 進行状況 |
| - | - | - | - | - | - |
| 字句解析とトークナイズ | `samples/language-impl-comparison/reml/json_parser.reml:56` | 手続き型トークナイザーが `Text.char_at` と `List.push_back` を逐一呼び出し、`read_*` 系は TODO なダミー実装のまま。 | `Core.Parse.Lex` を既定値として組み込む手順と、Unicode 正規化/数値解析のエラーを `Diagnostic` に変換するガイドラインを 2-3/3-3 へ追記する。 | 1-1, 2-3, 3-3, 3-5 | 未着手 |
| パーサーコンビネーター運用 | `samples/language-impl-comparison/reml/json_extended.reml:27`, `samples/language-impl-comparison/reml/yaml_parser.reml:120` | コメントスキップやトレーリングカンマ、インデント検証など高度な前処理を `RunConfig` 設定なしに都度書いている。 | `RunConfig` の Packrat/左再帰/コメント扱いを公式スイッチとして整理し、ストリーミング・復旧戦略を Chapter 2 と `guides/core-parse-streaming.md` で体系化する。 | 2-0, 2-2, 2-6, guides/core-parse-streaming.md | 未着手 |
| 効果ハンドリング戦略 | `samples/language-impl-comparison/reml/algebraic_effects.reml:32` | 1-3 §I.5 で効果行整列とハンドラ順序、3-6 §2.4 で診断・監査フロー、3-8 §1.2 で Stage/Capability 検査、notes §5 で比較マトリクスを提示。 | LSP 診断・CLI 連携の実装フォロー（`effects.contract.*` 系）と Stage 運用を監査ログへ拡張。 | 1-3, 3-6, 3-8, notes/dsl-plugin-roadmap.md | 完了（仕様更新済み） |
| 診断とエラー報告 | `samples/language-impl-comparison/reml/yaml_parser.reml:58`, `samples/language-impl-comparison/reml/yaml_parser.reml:139` | インデント不一致やネスト判定で `Parse.fail` に素朴な文字列を渡しており、スパン・期待集合・監査メタが欠落。 | 2-5 §B-11 で `Parse.fail`/`Parse.recover` の診断生成フローを明文化し、3-6 §2.2 で `from_parse_error` とエラーコードカタログ、3-7 §3.2 で Config 監査連携を定義。 | 2-5, 3-6, 3-7 | 完了（仕様更新済み） |
| 標準コレクション操作 | `samples/language-impl-comparison/reml/yaml_parser.reml:156`, `samples/language-impl-comparison/reml/template_engine.reml:343` | 3-1/3-2 で `List`/`Map` の順序保証・構造共有契約・`Iter` 連携を明文化し、`guides/collection-pipeline-guide.md` で実装レシピも整理済み。 | DSL 作者向けのサンプル拡充は引き続き `guides/dsl-gallery.md` 側で検討する。 | 3-1, 3-2, guides/collection-pipeline-guide.md | 完了（仕様・ガイド更新済み） |
| Unicode/Grapheme 操作 | `samples/language-impl-comparison/reml/markdown_parser.reml:42`, `samples/language-impl-comparison/reml/markdown_parser.reml:63` | カーソル管理で `String.grapheme_at` と `Grapheme.display_width` を直呼びし、列位置と診断位置を手計算している。 | `ParseState` と `Diagnostic` 間で Grapheme 単位の列情報を共有する規約、`Core.Text` の幅計算 API の利用手順を 1-4/3-3/2-5 に明示する。 | 1-4, 2-5, 3-3 | 未着手 |
| 設定ファイル拡張耐性 | `samples/language-impl-comparison/reml/json_extended.reml:27`, `samples/language-impl-comparison/reml/json_extended.reml:74` | コメント許容・トレーリングカンマ・期待集合活用が手動実装で、互換性スイッチや診断メタは未統一。 | `Lex.commentLine`/`commentBlock` の互換モード、拡張 JSON/TOML の互換性フラグ、`RunConfig` の feature ガードを 2-3/3-7/3-10 に整理する。 | 2-3, 3-7, 3-10 | 未着手 |
| テンプレート DSL とセキュリティ | `samples/language-impl-comparison/reml/template_engine.reml:64`, `samples/language-impl-comparison/reml/template_engine.reml:242`, `samples/language-impl-comparison/reml/template_engine.reml:329` | フィルター登録・HTML エスケープ・`Map` ベースの実行環境が独自実装で、効果タグや Capability 要件が未整理。 | DSL 向けテンプレート API、フィルター登録と `CapabilityRegistry` 連携、`Diagnostic` によるテンプレート実行エラー報告を 1-1/3-3/3-6/3-8 へ拡充する。 | 1-1, 3-3, 3-6, 3-8 | 未着手 |
| Regex/Parser 連携と性能 | `samples/language-impl-comparison/reml/regex_engine.reml:10`, `samples/language-impl-comparison/reml/regex_engine.reml:175` | `Core.Parse.Op` で正規表現を構築しつつ Packrat 活用はコメントに留まり、`feature {regex}` の挙動が暗黙。 | `Core.Parse` と `Core.Regex` の責務境界、Packrat/memo オプションの既定値、Unicode クラスの互換保証を 2-2/2-6/3-3/3-8 に取りまとめる。 | 2-2, 2-6, 3-3, 3-8 | 未着手 |
| 並行・分散モデル比較 | `samples/language-impl-comparison/README.md:12` | Elixir・Scala 3・Nim など並行モデルを持つ比較対象が列挙される一方、Reml の並行 API サンプルは未整備。 | `Core.Async`・`Core.FFI` の仕様ドラフトを進め、Actor/プロセス指向 DSL の最小例と Capability 検証手順を公開する。 | 3-9, guides/runtime-bridges.md, 3-8 | 未着手 |

> 今後、比較サンプルが追加された際は、本マトリクスの「参考実装/根拠」列を更新し、`README.md` の新項目と整合させてください。
